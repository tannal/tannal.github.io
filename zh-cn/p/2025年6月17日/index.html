<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Flutter åˆ›å»ºé¡¹ç›®çš„æ–¹æ³• Exported on 6/18/2025 at 06:38:44 GMT+8 from Cursor (1.0.0)\nUser\nflutter æ€ä¹ˆåˆ›å»ºé¡¹ç›®\nCursor\nè¦åˆ›å»º Flutter é¡¹ç›®ï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ flutter create å‘½ä»¤ã€‚\né¦–å…ˆï¼Œè¯·ç¡®ä¿ä½ å·²ç»å®‰è£…äº† Flutter SDK å¹¶é…ç½®å¥½äº†ç¯å¢ƒå˜é‡ã€‚\nç„¶åï¼Œæ‰“å¼€ä½ çš„ç»ˆç«¯æˆ–å‘½ä»¤æç¤ºç¬¦ï¼Œå¯¼èˆªåˆ°ä½ æƒ³è¦åˆ›å»ºé¡¹ç›®çš„ç›®å½•ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nflutter create your_project_name å°† your_project_name æ›¿æ¢ä¸ºä½ æƒ³è¦çš„é¡¹ç›®åç§°ã€‚ä¾‹å¦‚ï¼š\nflutter create my_first_app æ‰§è¡Œå®Œè¿™ä¸ªå‘½ä»¤åï¼ŒFlutter ä¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶åŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å’Œä»£ç ã€‚\nåˆ›å»ºå®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›å…¥é¡¹ç›®ç›®å½•å¹¶è¿è¡Œåº”ç”¨ï¼š\ncd your_project_name flutter run flutter create your_project_name flutter create my_first_app cd your_project_name flutter run User\nå›¾ç‰‡è½¬ä»£ç \nCursor\nå¥½çš„ï¼Œæ ¹æ®ä½ æä¾›çš„å›¾ç‰‡ï¼Œè¿™æ˜¯å¯¹åº”çš„ Flutter ä»£ç ï¼š\nclass HelloWorld extends StatelessWidget { const HelloWorld({Key? key}) : super(key: key); @override Widget build(BuildContext context) { return const Text("Hello World"); } } class HelloWorld extends StatelessWidget { const HelloWorld({Key? key}) : super(key: key); @override Widget build(BuildContext context) { return const Text("Hello World"); } } User\n'><title>2025å¹´6æœˆ17æ—¥</title><link rel=canonical href=https://tannal.github.io/zh-cn/p/2025%E5%B9%B46%E6%9C%8817%E6%97%A5/><link rel=stylesheet href=/scss/style.min.b0e76e98cdd4f7082d1fc36f7af7e0843a81201db2197c03ca426751dc923735.css><meta property='og:title' content="2025å¹´6æœˆ17æ—¥"><meta property='og:description' content='Flutter åˆ›å»ºé¡¹ç›®çš„æ–¹æ³• Exported on 6/18/2025 at 06:38:44 GMT+8 from Cursor (1.0.0)\nUser\nflutter æ€ä¹ˆåˆ›å»ºé¡¹ç›®\nCursor\nè¦åˆ›å»º Flutter é¡¹ç›®ï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ flutter create å‘½ä»¤ã€‚\né¦–å…ˆï¼Œè¯·ç¡®ä¿ä½ å·²ç»å®‰è£…äº† Flutter SDK å¹¶é…ç½®å¥½äº†ç¯å¢ƒå˜é‡ã€‚\nç„¶åï¼Œæ‰“å¼€ä½ çš„ç»ˆç«¯æˆ–å‘½ä»¤æç¤ºç¬¦ï¼Œå¯¼èˆªåˆ°ä½ æƒ³è¦åˆ›å»ºé¡¹ç›®çš„ç›®å½•ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nflutter create your_project_name å°† your_project_name æ›¿æ¢ä¸ºä½ æƒ³è¦çš„é¡¹ç›®åç§°ã€‚ä¾‹å¦‚ï¼š\nflutter create my_first_app æ‰§è¡Œå®Œè¿™ä¸ªå‘½ä»¤åï¼ŒFlutter ä¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶åŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å’Œä»£ç ã€‚\nåˆ›å»ºå®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›å…¥é¡¹ç›®ç›®å½•å¹¶è¿è¡Œåº”ç”¨ï¼š\ncd your_project_name flutter run flutter create your_project_name flutter create my_first_app cd your_project_name flutter run User\nå›¾ç‰‡è½¬ä»£ç \nCursor\nå¥½çš„ï¼Œæ ¹æ®ä½ æä¾›çš„å›¾ç‰‡ï¼Œè¿™æ˜¯å¯¹åº”çš„ Flutter ä»£ç ï¼š\nclass HelloWorld extends StatelessWidget { const HelloWorld({Key? key}) : super(key: key); @override Widget build(BuildContext context) { return const Text("Hello World"); } } class HelloWorld extends StatelessWidget { const HelloWorld({Key? key}) : super(key: key); @override Widget build(BuildContext context) { return const Text("Hello World"); } } User\n'><meta property='og:url' content='https://tannal.github.io/zh-cn/p/2025%E5%B9%B46%E6%9C%8817%E6%97%A5/'><meta property='og:site_name' content='è°­ç›Ÿ'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='è®¡ç®—æœº'><meta property='article:tag' content='é€»è¾‘'><meta property='article:published_time' content='2025-06-17T00:00:00+00:00'><meta property='article:modified_time' content='2025-06-17T00:00:00+00:00'><meta name=twitter:title content="2025å¹´6æœˆ17æ—¥"><meta name=twitter:description content='Flutter åˆ›å»ºé¡¹ç›®çš„æ–¹æ³• Exported on 6/18/2025 at 06:38:44 GMT+8 from Cursor (1.0.0)\nUser\nflutter æ€ä¹ˆåˆ›å»ºé¡¹ç›®\nCursor\nè¦åˆ›å»º Flutter é¡¹ç›®ï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ flutter create å‘½ä»¤ã€‚\né¦–å…ˆï¼Œè¯·ç¡®ä¿ä½ å·²ç»å®‰è£…äº† Flutter SDK å¹¶é…ç½®å¥½äº†ç¯å¢ƒå˜é‡ã€‚\nç„¶åï¼Œæ‰“å¼€ä½ çš„ç»ˆç«¯æˆ–å‘½ä»¤æç¤ºç¬¦ï¼Œå¯¼èˆªåˆ°ä½ æƒ³è¦åˆ›å»ºé¡¹ç›®çš„ç›®å½•ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nflutter create your_project_name å°† your_project_name æ›¿æ¢ä¸ºä½ æƒ³è¦çš„é¡¹ç›®åç§°ã€‚ä¾‹å¦‚ï¼š\nflutter create my_first_app æ‰§è¡Œå®Œè¿™ä¸ªå‘½ä»¤åï¼ŒFlutter ä¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶åŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å’Œä»£ç ã€‚\nåˆ›å»ºå®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›å…¥é¡¹ç›®ç›®å½•å¹¶è¿è¡Œåº”ç”¨ï¼š\ncd your_project_name flutter run flutter create your_project_name flutter create my_first_app cd your_project_name flutter run User\nå›¾ç‰‡è½¬ä»£ç \nCursor\nå¥½çš„ï¼Œæ ¹æ®ä½ æä¾›çš„å›¾ç‰‡ï¼Œè¿™æ˜¯å¯¹åº”çš„ Flutter ä»£ç ï¼š\nclass HelloWorld extends StatelessWidget { const HelloWorld({Key? key}) : super(key: key); @override Widget build(BuildContext context) { return const Text("Hello World"); } } class HelloWorld extends StatelessWidget { const HelloWorld({Key? key}) : super(key: key); @override Widget build(BuildContext context) { return const Text("Hello World"); } } User\n'><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/zh-cn/><img src=/img/avatar_hu_23460dfa2f6975f3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¤Ÿ</span></figure><div class=site-meta><h1 class=site-name><a href=/zh-cn>è°­ç›Ÿ</a></h1><h2 class=site-description>stay hungry, stay foolish</h2></div></header><ol class=menu-social><li><a href=https://space.bilibili.com/3546751254399476 target=_blank title="B ç«™ã€Œèµ·ä¸ªåå­—å«çŠŸé©´ã€" rel=me><!doctype html><svg t="1712105268862" class="icon" viewBox="0 0 1024 1024" p-id="5725" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M1019.54782609 345.3106087c-3.20556522-142.1133913-127.15408696-169.36069565-127.15408696-169.36069566s-96.70121739-.53426087-222.25252174-1.60278261l91.3586087-88.15304347s14.42504348-18.16486957-10.15095652-38.46678261c-24.576-20.30191304-26.17878261-11.21947826-34.72695653-5.87686957-7.47965217 5.3426087-117.00313043 112.72904348-136.23652174 131.96243479-49.68626087.0-101.50956522-.53426087-151.73008695-.53426087h17.63060869S315.392 43.98747826 306.84382609 38.1106087s-9.61669565-14.42504348-34.72695652 5.87686956c-24.576 20.30191304-10.15095652 38.46678261-10.15095653 38.46678261l93.49565218 90.82434783c-101.50956522.0-189.12834783.53426087-229.73217392 2.13704347C-5.69878261 213.34817391 4.45217391 345.3106087 4.45217391 345.3106087s1.60278261 283.15826087.0 426.34017391c14.42504348 143.18191304 124.48278261 166.15513043 124.48278261 166.15513043s43.8093913 1.06852174 76.39930435 1.06852174c3.20556522 9.08243478 5.87686957 53.96034783 56.0973913 53.96034783 49.68626087.0 56.0973913-53.96034783 56.09739131-53.96034783s365.96869565-1.60278261 396.42156522-1.60278261c1.60278261 15.49356522 9.08243478 56.63165217 59.30295652 56.09739131 49.68626087-1.06852174 53.42608696-59.30295652 53.42608695-59.30295652s17.09634783-1.60278261 67.85113044.0c118.60591304-21.90469565 125.55130435-160.81252174 125.55130435-160.81252174s-2.13704348-285.82956522-.53426087-427.94295652zM917.504 798.36382609c0 22.43895652-17.6306087 40.60382609-39.53530435 40.60382608H156.71652174c-21.90469565.0-39.53530435-18.16486957-39.53530435-40.60382608V320.20034783c0-22.43895652 17.6306087-40.60382609 39.53530435-40.60382609h721.25217391c21.90469565.0 39.53530435 18.16486957 39.53530435 40.60382609v478.16347826z" fill="#8a8a8a" p-id="5726"/><path d="M409.088 418.816l-203.264 38.912 17.408 76.288 201.216-38.912zm109.568 202.24c-49.664 106.496-94.208 26.112-94.208 26.112l-33.28 21.504s65.536 89.6 128 21.504c73.728 68.096 130.048-22.016 130.048-22.016l-30.208-19.456c0-.512-52.736 75.776-100.352-27.648zM619.008 495.104l201.728 38.912 16.896-76.288-202.752-38.912z" fill="#8a8a8a" p-id="5727"/></svg></a></li><li><a href=https://github.com/tannal target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/megotannal target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.zhihu.com/people/roseduan target=_blank title=Zhihu rel=me><!doctype html><svg t="1704259577746" class="icon" viewBox="0 0 1024 1024" p-id="5040" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M570.581333 806.272h61.952L652.928 876.117333 764.074667 806.272h130.986666V230.186667h-324.48V806.272zM636.501333 292.693333h192.64V743.68h-73.898666l-73.813334 46.378667L668.032 743.808l-31.530667-.128V292.736zM515.754667 493.738667H377.429333a2999.466667 2999.466667.0 005.802667-194.56h135.338667S523.776 239.445334 495.872 240.128H261.76c9.216-34.730667 20.821333-70.613333 34.688-107.690667.0.0-63.701333.0-85.333333 57.130667C202.112 213.12 176.128 303.786667 129.877333 396.416c15.573333-1.706667 67.114667-3.114667 97.450667-58.794667 5.589333-15.616 6.656-17.621333 13.568-38.485333h76.373333c0 27.776-3.157333 177.109333-4.437333 194.474667h-138.24c-31.104.0-41.173333 62.549333-41.173333 62.549333h173.482666C295.253333 688.256 232.789333 799.573333 119.466667 887.466667c54.186667 15.488 108.202667-2.432 134.912-26.197334.0.0 60.8-55.338667 94.122666-183.381333L491.264 849.834667s20.906667-71.168-3.285333-105.856c-20.053333-23.637333-74.24-87.552-97.322667-110.72l-38.698667 30.72c11.52-36.992 18.474667-72.96 20.821334-107.690667h163.072s-.213333-62.549333-20.053334-62.549333z" p-id="5041" fill="#8a8a8a"/></svg></a></li><li><a href=https://mp.weixin.qq.com/s/hs36eiU7Zr-UdJ0YBtZgKQ target=_blank title="å¾®ä¿¡å…¬ä¼—å· roseduanå†™å­—çš„åœ°æ–¹" rel=me><!doctype html><svg t="1704259948565" class="icon" viewBox="0 0 1194 1024" p-id="5272" xmlns:xlink="http://www.w3.org/1999/xlink" width="233.203125" height="200"><path d="M728.064 535.296a35.498667 35.498667.0 11-70.912.0 35.498667 35.498667.0 0170.912.0m246.016.0a35.498667 35.498667.0 11-70.997333.0 35.498667 35.498667.0 0170.997333.0" fill="#8a8a8a" p-id="5273"/><path d="M902.144 930.133333l-6.656 1.450667a594.176 594.176.0 01-18.602667 3.669333c-26.453333 4.778667-44.629333 6.826667-64 6.144C645.034666 935.850666 514.218666 853.504 461.824 722.688a446.464 446.464.0 01-6.826667-19.114667l-1.962666-6.058666a199.68 199.68.0 01-3.84-13.653334 338.858667 338.858667.0 01-9.216-75.690666c0-171.008 157.013333-305.92 354.304-314.709334l8.874666-.682666c7.850667-.597333 12.970667-.853333 18.773334-.853334h14.762666l9.301334.170667c188.16 14.677333 340.394667 156.672 340.394666 323.925333.0 78.336-38.826667 155.733333-109.653333 222.293334a303.530667 303.530667.0 01-7.082667 6.4l9.984 71.082666a49.152 49.152.0 01-69.12 58.453334l-98.816-46.421334a582.485333 582.485333.0 01-9.472 2.304zm220.16-314.026666c0-131.754667-124.586667-247.978667-279.125333-260.096H821.930667c-3.754667.0-7.68.085333-13.994667.597333l-10.666667.768C631.466667 364.8 503.978667 474.453333 503.978667 608.256c0 18.773333 2.730667 40.874667 7.509333 60.842667.597333 2.474667 1.450667 5.632 2.56 9.216l1.706667 4.949333c2.133333 6.570667 4.266667 12.629333 5.632 15.957333 42.325333 105.728 149.930667 173.397333 293.717333 178.176 13.738667.512 28.16-1.109333 50.346667-5.12a531.626667 531.626667.0 0016.64-3.242666l5.632-1.28c4.693333-1.109333 8.448-1.962667 19.370666-4.778667a32 32 0 0121.418667 2.133333L1013.76 905.216l-9.984-69.290667a32 32 0 0113.909333-31.232c1.194667-.853333 8.618667-6.912 15.189334-13.056 58.709333-55.210667 89.429333-116.394667 89.429333-175.616zM12.970667 378.197333C12.970667 171.52 206.677333 5.376 442.709333 5.376c208.384.0 394.24 130.304 431.872 306.090667 1.28 5.973333 1.28 11.264.512 16.896a32 32 0 01-63.658666-5.973334C779.178667 179.2 621.482667 69.376 442.709333 69.376c-202.666666.0-365.738666 139.776-365.738666 308.906667.0 89.941333 46.165333 171.52 136.021333 237.568a32 32 0 0111.434667 35.84l-23.296 69.973333 104.96-48.896a32 32 0 0122.442666-1.706667l5.461334 1.706667c54.357333 11.093333 76.288 14.506667 108.714666 14.506667a200.789333 200.789333.0 0032.256-4.010667c-.512.170667-1.536.512-2.730666 1.536a33.109333 33.109333.0 0139.253333 1.109333A32 32 0 01516.864 730.88c-11.776 14.848-47.36 20.309333-74.24 20.309333-37.12.0-62.037333-3.584-119.893333-15.530666L198.570667 793.6a49.493333 49.493333.0 01-68.949334-59.733333l26.88-80.64c-93.525333-75.52-143.530666-170.24-143.530666-275.029334z" fill="#8a8a8a" p-id="5274"/><path d="M344.576 254.378667a44.373333 44.373333.0 11-88.746667.085333 44.373333 44.373333.0 0188.746667.0M636.586667 254.378667A44.373333 44.373333.0 11547.84 254.464a44.373333 44.373333.0 0188.746667.0" fill="#8a8a8a" p-id="5275"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/zh-cn/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>ä¸»é¡µ</span></a></li><li><a href=/zh-cn/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/zh-cn/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li><a href=/zh-cn/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 108 0A4 4 0 008 7"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äº</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://tannal.github.io/>English</option><option value=https://tannal.github.io/zh-cn/ selected>Chinese</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#1-è¿™æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶å—>1. è¿™æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶å—ï¼Ÿ</a></li><li><a href=#2-casual-å› æœ-æ˜¯ä»€ä¹ˆæ„æ€>2. <code>casual</code> (å› æœ) æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</a></li><li><a href=#ä¸»è¦ç»“æ„å’ŒåŠŸèƒ½>ä¸»è¦ç»“æ„å’ŒåŠŸèƒ½ï¼š</a><ol><li><a href=#struct-imecontext><code>struct ImeContext</code></a></li><li><a href=#impl-imecontext-æ–¹æ³•è§£æ><code>impl ImeContext</code> æ–¹æ³•è§£æï¼š</a></li><li><a href=#impl-drop-for-imecontext><code>impl Drop for ImeContext</code></a></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“ï¼š</a></li><li><a href=#1-winit-å’Œ-ime-ç›¸å…³çš„-api-äº‹ä»¶å’Œæ–¹æ³•>1. <code>winit</code> å’Œ IME ç›¸å…³çš„ API (äº‹ä»¶å’Œæ–¹æ³•)</a><ol><li><a href=#a-winit-å‘é€çš„-ime-äº‹ä»¶>A. <code>winit</code> å‘é€çš„ IME äº‹ä»¶</a></li><li><a href=#b-winit-æä¾›çš„-ime-æ§åˆ¶æ–¹æ³•>B. <code>winit</code> æä¾›çš„ IME æ§åˆ¶æ–¹æ³•</a></li></ol></li><li><a href=#2-parley-å¦‚ä½•ä½¿ç”¨-winit-å¯¹åº”çš„-api>2. <code>parley</code> å¦‚ä½•ä½¿ç”¨ <code>winit</code> å¯¹åº”çš„ API</a></li><li><a href=#plaineditor-çš„æ ¸å¿ƒèŒè´£><code>PlainEditor</code> çš„æ ¸å¿ƒèŒè´£ï¼š</a></li><li><a href=#ä¸-ime-ç›¸å…³çš„å…³é”®å­—æ®µå’Œæ–¹æ³•>ä¸ IME ç›¸å…³çš„å…³é”®å­—æ®µå’Œæ–¹æ³•ï¼š</a></li><li><a href=#parley-å¦‚ä½•ä¸-winit-äº¤äº’çš„æ€»ç»“><code>parley</code> å¦‚ä½•ä¸ <code>winit</code> äº¤äº’çš„æ€»ç»“ï¼š</a></li></ol></li><li><a href=#1-ç‰©ç†å·¥ç¨‹æ•°å­¦å»ºæ¨¡ä¸­çš„å«ä¹‰>1. ç‰©ç†/å·¥ç¨‹/æ•°å­¦å»ºæ¨¡ä¸­çš„å«ä¹‰</a><ol><li><a href=#flow-componentæµåŠ¨åˆ†é‡><strong>Flow Componentï¼ˆæµåŠ¨åˆ†é‡ï¼‰</strong></a></li><li><a href=#diffusion-componentæ‰©æ•£åˆ†é‡><strong>Diffusion Componentï¼ˆæ‰©æ•£åˆ†é‡ï¼‰</strong></a><ol><li><a href=#ä¸¾ä¾‹><strong>ä¸¾ä¾‹ï¼š</strong></a></li></ol></li></ol></li><li><a href=#2-ç”Ÿæˆå¼aiæ·±åº¦å­¦ä¹ ä¸­çš„å«ä¹‰>2. ç”Ÿæˆå¼AI/æ·±åº¦å­¦ä¹ ä¸­çš„å«ä¹‰</a><ol><li><a href=#flow-component><strong>Flow Component</strong></a></li><li><a href=#diffusion-component><strong>Diffusion Component</strong></a><ol><li><a href=#ä¸¾ä¾‹-1><strong>ä¸¾ä¾‹ï¼š</strong></a></li></ol></li></ol></li><li><a href=#3-å…·ä½“åº”ç”¨åœºæ™¯>3. å…·ä½“åº”ç”¨åœºæ™¯</a></li><li><a href=#æ€»ç»“-1>æ€»ç»“</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/zh-cn/categories/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/>ç¥ç»ç½‘ç»œ</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/zh-cn/p/2025%E5%B9%B46%E6%9C%8817%E6%97%A5/>2025å¹´6æœˆ17æ—¥</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-06-17T00:00:00Z>Jun 17, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 73 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=flutter-åˆ›å»ºé¡¹ç›®çš„æ–¹æ³•>Flutter åˆ›å»ºé¡¹ç›®çš„æ–¹æ³•</h1><p><em>Exported on 6/18/2025 at 06:38:44 GMT+8 from Cursor (1.0.0)</em></p><hr><p><strong>User</strong></p><p>flutter æ€ä¹ˆåˆ›å»ºé¡¹ç›®</p><hr><p><strong>Cursor</strong></p><p>è¦åˆ›å»º Flutter é¡¹ç›®ï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ <code>flutter create</code> å‘½ä»¤ã€‚</p><p>é¦–å…ˆï¼Œè¯·ç¡®ä¿ä½ å·²ç»å®‰è£…äº† Flutter SDK å¹¶é…ç½®å¥½äº†ç¯å¢ƒå˜é‡ã€‚</p><p>ç„¶åï¼Œæ‰“å¼€ä½ çš„ç»ˆç«¯æˆ–å‘½ä»¤æç¤ºç¬¦ï¼Œå¯¼èˆªåˆ°ä½ æƒ³è¦åˆ›å»ºé¡¹ç›®çš„ç›®å½•ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>flutter create your_project_name
</span></span></code></pre></div><p>å°† <code>your_project_name</code> æ›¿æ¢ä¸ºä½ æƒ³è¦çš„é¡¹ç›®åç§°ã€‚ä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>flutter create my_first_app
</span></span></code></pre></div><p>æ‰§è¡Œå®Œè¿™ä¸ªå‘½ä»¤åï¼ŒFlutter ä¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶åŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å’Œä»£ç ã€‚</p><p>åˆ›å»ºå®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›å…¥é¡¹ç›®ç›®å½•å¹¶è¿è¡Œåº”ç”¨ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> your_project_name
</span></span><span class=line><span class=cl>flutter run
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flutter create your_project_name
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flutter create my_first_app
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd your_project_name
</span></span><span class=line><span class=cl>flutter run
</span></span></code></pre></div><hr><p><strong>User</strong></p><p>å›¾ç‰‡è½¬ä»£ç </p><hr><p><strong>Cursor</strong></p><p>å¥½çš„ï¼Œæ ¹æ®ä½ æä¾›çš„å›¾ç‰‡ï¼Œè¿™æ˜¯å¯¹åº”çš„ Flutter ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dart data-lang=dart><span class=line><span class=cl><span class=kd>class</span> <span class=nc>HelloWorld</span> <span class=kd>extends</span> <span class=n>StatelessWidget</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>const</span> <span class=n>HelloWorld</span><span class=p>({</span><span class=n>Key</span><span class=o>?</span> <span class=n>key</span><span class=p>})</span> <span class=o>:</span> <span class=k>super</span><span class=p>(</span><span class=nl>key:</span> <span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=err>@</span><span class=n>override</span>
</span></span><span class=line><span class=cl>  <span class=n>Widget</span> <span class=n>build</span><span class=p>(</span><span class=n>BuildContext</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>const</span> <span class=n>Text</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-dart data-lang=dart><span class=line><span class=cl><span class=kd>class</span> <span class=nc>HelloWorld</span> <span class=kd>extends</span> <span class=n>StatelessWidget</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>const</span> <span class=n>HelloWorld</span><span class=p>({</span><span class=n>Key</span><span class=o>?</span> <span class=n>key</span><span class=p>})</span> <span class=o>:</span> <span class=k>super</span><span class=p>(</span><span class=nl>key:</span> <span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=err>@</span><span class=n>override</span>
</span></span><span class=line><span class=cl>  <span class=n>Widget</span> <span class=n>build</span><span class=p>(</span><span class=n>BuildContext</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>const</span> <span class=n>Text</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><p><strong>User</strong></p><p>è‘—åçš„flutterå¼€æºé¡¹ç›®</p><hr><p><strong>Cursor</strong></p><p>æœ‰è®¸å¤šè‘—åçš„ Flutter å¼€æºé¡¹ç›®ï¼Œå®ƒä»¬å±•ç¤ºäº† Flutter çš„å¼ºå¤§åŠŸèƒ½å’Œçµæ´»æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ¯”è¾ƒçŸ¥åä¸”å€¼å¾—å…³æ³¨çš„ï¼š</p><ol><li><p><strong>Flutter Gallery (å®˜æ–¹ç¤ºä¾‹)</strong></p><ul><li><strong>æè¿°ï¼š</strong> è¿™æ˜¯ Google å®˜æ–¹æ¨å‡ºçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå±•ç¤ºäº† Flutter UI åº“ä¸­å„ç§ç»„ä»¶å’ŒåŠŸèƒ½ï¼Œæ˜¯å­¦ä¹  Flutter Widget å’Œè®¾è®¡æ¨¡å¼çš„ç»ä½³èµ„æºã€‚</li><li><strong>GitHubï¼š</strong> <code>github.com/flutter/gallery</code></li></ul></li><li><p><strong>InKino (ç”µå½±é¢„è®¢åº”ç”¨)</strong></p><ul><li><strong>æè¿°ï¼š</strong> ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ç”µå½±é¢„è®¢åº”ç”¨ç¨‹åºï¼Œæ¨¡ä»¿äº†çœŸå®çš„ç”Ÿäº§ç¯å¢ƒåº”ç”¨ï¼ŒåŒ…å«äº†å¾ˆå¤šé«˜çº§ Flutter ç‰¹æ€§ï¼Œå¦‚ BLoC æ¨¡å¼ã€åŠ¨ç”»ã€è·¯ç”±ç®¡ç†ç­‰ã€‚</li><li><strong>GitHubï¼š</strong> <code>github.com/roughike/inKino</code></li></ul></li><li><p><strong>Timetable (è¯¾ç¨‹è¡¨åº”ç”¨)</strong></p><ul><li><strong>æè¿°ï¼š</strong> ä¸€ä¸ªè®¾è®¡ç²¾ç¾çš„å­¦æ ¡è¯¾ç¨‹è¡¨åº”ç”¨ï¼Œä»¥å…¶é«˜è´¨é‡çš„ä»£ç ç»“æ„ã€è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œå¯¹å„ç§ Flutter ç‰¹æ€§çš„æ·±å…¥ä½¿ç”¨è€Œé—»åã€‚</li><li><strong>GitHubï¼š</strong> <code>github.com/zaiste/flutter_timetable</code></li></ul></li><li><p><strong>Flutter TodoMVC (å¾…åŠäº‹é¡¹åº”ç”¨)</strong></p><ul><li><strong>æè¿°ï¼š</strong> TodoMVC é¡¹ç›®çš„ Flutter å®ç°ï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•åœ¨ Flutter ä¸­ä½¿ç”¨ä¸åŒçš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼ˆå¦‚ BLoC, Provider, Riverpod ç­‰ï¼‰æ¥æ„å»ºä¸€ä¸ªç»å…¸çš„å¾…åŠäº‹é¡¹åº”ç”¨ã€‚</li><li><strong>GitHubï¼š</strong> (é€šå¸¸åœ¨å„ä¸ªçŠ¶æ€ç®¡ç†åº“çš„ç¤ºä¾‹ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œä¾‹å¦‚ <code>github.com/felangel/bloc/tree/master/examples/flutter_todos</code>)</li></ul></li><li><p><strong>Aurora Store (éå®˜æ–¹ Google Play Store å®¢æˆ·ç«¯)</strong></p><ul><li><strong>æè¿°ï¼š</strong> ä¸€ä¸ªå¼€æºçš„ Google Play Store æ›¿ä»£å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ Flutter æ„å»ºï¼Œåœ¨éšç§å’Œæ§åˆ¶æ–¹é¢æä¾›äº†æ›´å¤šé€‰æ‹©ã€‚è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¤æ‚ä¸”æ´»è·ƒç»´æŠ¤çš„çœŸå®ä¸–ç•Œåº”ç”¨ã€‚</li><li><strong>GitHubï¼š</strong> <code>github.com/AuroraOSS/AuroraStore</code></li></ul></li><li><p><strong>Immich (è‡ªæ‰˜ç®¡ç…§ç‰‡å’Œè§†é¢‘å¤‡ä»½è§£å†³æ–¹æ¡ˆ)</strong></p><ul><li><strong>æè¿°ï¼š</strong> ä¸€ä¸ªéå¸¸æµè¡Œçš„è‡ªæ‰˜ç®¡ç…§ç‰‡å’Œè§†é¢‘å¤‡ä»½è§£å†³æ–¹æ¡ˆï¼Œå…¶ç§»åŠ¨å®¢æˆ·ç«¯æ˜¯ä½¿ç”¨ Flutter æ„å»ºçš„ã€‚å®ƒæ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºå’Œä¸æ–­å¢é•¿çš„åŠŸèƒ½ã€‚</li><li><strong>GitHubï¼š</strong> <code>github.com/immich-app/immich</code></li></ul></li></ol><p>è¿™äº›é¡¹ç›®ä¸ä»…æ˜¯å­¦ä¹  Flutter çš„å¥½èµ„æºï¼Œä¹Ÿå±•ç¤ºäº† Flutter åœ¨æ„å»ºå¤æ‚ã€ç¾è§‚å’Œé«˜æ€§èƒ½åº”ç”¨ç¨‹åºæ–¹é¢çš„èƒ½åŠ›ã€‚ä½ å¯ä»¥åœ¨ GitHub ä¸Šæœç´¢è¿™äº›é¡¹ç›®æ¥æŸ¥çœ‹å®ƒä»¬çš„æºä»£ç ã€‚</p><hr><p><strong>User</strong></p><p>2
Contents
1 Introduction&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 10
1.1 Purpose of This Document &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 10
1.2 Organization of This Specification&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 10
1.3 New in Metal 4&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;11
1.4 References&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;11
1.5 Metal and C++17&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;..11
1.5.1 Overloading&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.11
1.5.2 Templates&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.11
1.5.3 Preprocessing Directives&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 12
1.5.4 Restrictions &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 12
1.6 Compiler and Preprocessor&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 12
1.6.1 Preprocessor Compiler Options&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 13
1.6.2 Preprocessor Definitions &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 13
1.6.3 Math Intrinsics Compiler Options &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 13
1.6.4 Invariance Compiler Options &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 15
1.6.5 Optimization Compiler Options&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 16
1.6.6 Maximum Total Threadgroup Size Option&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 16
1.6.7 Texture Write Rounding Mode &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 16
1.6.8 Compiler Options to Enable Modules&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 17
1.6.9 Compiler Options to Enable Logging&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 18
1.6.10 Compiler Options Controlling the Language Version&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 18
1.6.11 Compiler Options to Request or Suppress Warnings&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 19
1.6.12 Target Conditionals&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;..20
1.6.13 Dynamic Library Linker Options&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;20
1.6.14 Options for Compiling to GPU Binaries &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;20
1.6.15 Options for Generating Metal Library Symbol Files&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 21
1.7 Metal Coordinate Systems&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 21
2 Data Types&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;..24
2.1 Scalar Data Types&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;..24
2.2 Vector Data Types &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.26
2.2.1 Accessing Vector Components &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;28
2.2.2 Vector Constructors&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 31
2.2.3 Packed Vector Types &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;..32
2.3 Matrix Data Types&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 34
2.3.1 Accessing Matrix Components &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr; 36
2.3.2 Matrix Constructors&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;. 36
2.4 SIMD-group Matrix Data Types&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.37
2.5 Alignment of Data Types&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;.. 38
2.6 Atomic Data Types &mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;&mldr;</p><p>è®²ä»€ä¹ˆåœ¨</p><hr><p><strong>Cursor</strong></p><p>ä½ æä¾›çš„è¿™ä»½ç›®å½•æ¥è‡ªä¸€ä»½å…³äº <strong>Metal</strong> çš„æŠ€æœ¯æ–‡æ¡£ï¼Œå¾ˆå¯èƒ½æ˜¯ <strong>Metal Shading Language (MSL) è§„èŒƒ</strong>æˆ–ç›¸å…³çš„ç¼–ç¨‹æŒ‡å—ã€‚</p><p>ä»ç›®å½•å†…å®¹æ¥çœ‹ï¼Œè¿™ä»½æ–‡æ¡£ä¸»è¦è®²è¿°äº†ï¼š</p><ol><li><strong>Metal 4 è¯­è¨€åŠå…¶ç‰¹æ€§ï¼š</strong> ç‰¹åˆ«æ˜¯ä¸ C++17 çš„ç»“åˆï¼ˆé‡è½½ã€æ¨¡æ¿ã€é¢„å¤„ç†æŒ‡ä»¤ç­‰ï¼‰ã€‚</li><li><strong>Metal ç¼–è¯‘å™¨å’Œé¢„å¤„ç†å™¨ï¼š</strong> è¯¦ç»†ä»‹ç»äº†å„ç§ç¼–è¯‘é€‰é¡¹ï¼Œå¦‚é¢„å¤„ç†ã€æ•°å­¦å†…åœ¨å‡½æ•°ã€ä¼˜åŒ–ã€æ—¥å¿—ã€è¯­è¨€ç‰ˆæœ¬ã€è­¦å‘Šã€ç›®æ ‡æ¡ä»¶ç­‰ã€‚</li><li><strong>Metal åæ ‡ç³»ç»Ÿã€‚</strong></li><li><strong>Metal çš„æ•°æ®ç±»å‹ï¼š</strong> åŒ…æ‹¬æ ‡é‡ã€å‘é‡ã€çŸ©é˜µã€SIMD-ç»„çŸ©é˜µã€æ•°æ®å¯¹é½ä»¥åŠåŸå­æ•°æ®ç±»å‹ã€‚</li></ol><p>æ€»è€Œè¨€ä¹‹ï¼Œè¿™ä»½æ–‡æ¡£æ˜¯å…³äº <strong>Apple çš„ Metal å›¾å½¢å’Œè®¡ç®— API çš„ç¼–ç¨‹è¯­è¨€å’Œè¿è¡Œæ—¶ç¯å¢ƒçš„è¯¦ç»†æŠ€æœ¯è§„èŒƒ</strong>ï¼Œå°¤å…¶ä¾§é‡äºå…¶ç¼–è¯‘å™¨è¡Œä¸ºã€æ”¯æŒçš„æ•°æ®ç±»å‹å’Œè¯­è¨€ç‰¹æ€§ã€‚</p><hr><p><strong>User</strong></p><p>å…¶ä»–å¹³å°æœ‰è¿™ç§æ–‡æ¡£ä¹ˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>å½“ç„¶æœ‰ï¼ä¸»æµçš„å›¾å½¢å’Œè®¡ç®— API åœ¨å…¶ä»–å¹³å°ä¸Šä¹Ÿæœ‰éå¸¸è¯¦ç»†çš„ç±»ä¼¼æ–‡æ¡£ï¼Œé€šå¸¸åŒ…æ‹¬ API è§„èŒƒã€ç¼–ç¨‹æŒ‡å—ã€ç€è‰²å™¨è¯­è¨€è§„èŒƒç­‰ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦å¹³å°åŠå…¶å¯¹åº”çš„å›¾å½¢ API æ–‡æ¡£ï¼š</p><ol><li><p><strong>Windows & Xbox (DirectX)</strong></p><ul><li><strong>APIï¼š</strong> DirectX (åŒ…æ‹¬ Direct3D, DirectCompute ç­‰)ã€‚</li><li><strong>æ–‡æ¡£ç±»å‹ï¼š</strong><ul><li><strong>DirectX SDK æ–‡æ¡£ï¼š</strong> å¾®è½¯æä¾›äº†è¯¦å°½çš„ MSDN/Microsoft Docs æ–‡æ¡£ï¼Œæ¶µç›– Direct3D API çš„æ‰€æœ‰æ¥å£ã€å‡½æ•°ã€ç»“æ„ä½“ã€æšä¸¾ç­‰ã€‚</li><li><strong>HLSL (High-Level Shading Language) è¯­è¨€è§„èŒƒï¼š</strong> ç±»ä¼¼äº Metal Shading Languageï¼ŒHLSL æ˜¯ DirectX ä¸“ç”¨çš„ç€è‰²å™¨è¯­è¨€ï¼Œä¹Ÿæœ‰è¯¦ç»†çš„è¯­è¨€è§„èŒƒæ–‡æ¡£ï¼Œå®šä¹‰äº†å…¶è¯­æ³•ã€æ•°æ®ç±»å‹ã€å†…ç½®å‡½æ•°ç­‰ã€‚</li><li><strong>ç¼–ç¨‹æŒ‡å—å’Œæ•™ç¨‹ï¼š</strong> æä¾›äº†ä»åŸºç¡€åˆ°é«˜çº§çš„ DirectX ç¼–ç¨‹æŒ‡å—å’Œç¤ºä¾‹ã€‚</li></ul></li></ul></li><li><p><strong>Windows, Linux, Android (OpenGL / Vulkan)</strong></p><ul><li><strong>APIï¼š</strong> OpenGL (æ—§ä½†å¹¿æ³›), Vulkan (æ–°ä¸€ä»£é«˜æ€§èƒ½)ã€‚</li><li><strong>æ–‡æ¡£ç±»å‹ï¼š</strong><ul><li><strong>OpenGL/Vulkan è§„èŒƒ (Khronos Group)ï¼š</strong> è¿™æ˜¯æœ€é‡è¦çš„æ–‡æ¡£ã€‚Khronos Group ç»´æŠ¤ç€ OpenGL å’Œ Vulkan çš„å®˜æ–¹æ ‡å‡†å’Œè§„èŒƒæ–‡æ¡£ï¼Œéå¸¸è¯¦ç»†åœ°å®šä¹‰äº† API çš„æ¯ä¸€ä¸ªå‡½æ•°ã€çŠ¶æ€ã€è¡Œä¸ºã€é”™è¯¯ç ç­‰ã€‚è¿™äº›æ–‡æ¡£æ˜¯å›¾å½¢é©±åŠ¨å¼€å‘è€…å’Œå¼•æ“å¼€å‘è€…ç¼–å†™åº•å±‚ä»£ç çš„æƒå¨å‚è€ƒã€‚<ul><li>å¯¹äº Vulkanï¼Œæœ‰ <code>Vulkan Specification</code>ã€‚</li><li>å¯¹äº OpenGLï¼Œæœ‰ <code>OpenGL Specification</code>ã€‚</li></ul></li><li><strong>GLSL (OpenGL Shading Language) è§„èŒƒï¼š</strong> ç±»ä¼¼äº HLSL å’Œ MSLï¼ŒGLSL æ˜¯ OpenGL çš„ç€è‰²å™¨è¯­è¨€ï¼Œä¹Ÿæœ‰ç‹¬ç«‹çš„è¯­è¨€è§„èŒƒæ–‡æ¡£ã€‚</li><li><strong>SPIR-V è§„èŒƒï¼š</strong> å¯¹äº Vulkanï¼Œç€è‰²å™¨é€šå¸¸ç¼–è¯‘æˆ SPIR-V ä¸­é—´è¡¨ç¤ºï¼ŒSPIR-V ä¹Ÿæœ‰è‡ªå·±çš„è§„èŒƒã€‚</li><li><strong>SDK æ–‡æ¡£å’Œç¼–ç¨‹æŒ‡å—ï¼š</strong> é©±åŠ¨å‚å•†å’Œç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ GLFW, SDL ç­‰ï¼‰ä¼šæä¾›ä½¿ç”¨è¿™äº› API çš„åº“æ–‡æ¡£å’Œç¤ºä¾‹ã€‚</li></ul></li></ul></li><li><p><strong>Web å¹³å° (WebGL / WebGPU)</strong></p><ul><li><strong>APIï¼š</strong> WebGL (åŸºäº OpenGL ES), WebGPU (æ–°ä¸€ä»£ Web å›¾å½¢ API)ã€‚</li><li><strong>æ–‡æ¡£ç±»å‹ï¼š</strong><ul><li><strong>W3C/Khronos Group æ ‡å‡†ï¼š</strong> WebGL å’Œ WebGPU éƒ½æ˜¯ Web æ ‡å‡†ï¼Œç”± W3C å’Œ Khronos Group å…±åŒåˆ¶å®šã€‚å®ƒä»¬çš„è§„èŒƒæ–‡æ¡£å®šä¹‰äº†å¦‚ä½•åœ¨ Web æµè§ˆå™¨ä¸­æš´éœ²è¿™äº›å›¾å½¢ APIã€‚</li><li><strong>GLSL ES è§„èŒƒ (WebGL)ï¼š</strong> WebGL ä½¿ç”¨åŸºäº OpenGL ES çš„ç€è‰²å™¨è¯­è¨€ã€‚</li><li><strong>WGSL (WebGPU Shading Language) è§„èŒƒï¼š</strong> WebGPU æ‹¥æœ‰è‡ªå·±çš„ç€è‰²å™¨è¯­è¨€ WGSLï¼Œä¹Ÿæœ‰è¯¦ç»†çš„è¯­è¨€è§„èŒƒã€‚</li><li><strong>MDN Web Docsï¼š</strong> Mozilla å¼€å‘è€…ç½‘ç»œæä¾›äº†éå¸¸å¥½çš„ WebGL å’Œ WebGPU çš„ API å‚è€ƒå’Œæ•™ç¨‹ã€‚</li></ul></li></ul></li></ol><p>æ€»ç»“æ¥è¯´ï¼Œä»»ä½•ä¸€ä¸ªæˆç†Ÿçš„å›¾å½¢ API éƒ½ä¼šæœ‰ä¸€æ•´å¥—å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£ä½“ç³»ï¼ŒåŒ…æ‹¬åº•å±‚è§„èŒƒã€ç€è‰²å™¨è¯­è¨€è§„èŒƒã€ä»¥åŠé¢å‘å¼€å‘è€…çš„ç¼–ç¨‹æŒ‡å—å’Œå‚è€ƒæ–‡æ¡£ï¼Œè¿™äº›æ–‡æ¡£çš„è¯¦ç»†ç¨‹åº¦å’Œæ·±åº¦ä¸ä½ çœ‹åˆ°çš„ Metal æ–‡æ¡£æ˜¯ç±»ä¼¼çš„ã€‚</p><hr><p><strong>User</strong></p><p>chatter
Off-topic conversation and chatter.</p><p>VIEWS
Recent conversations
Inbox
Combined feed
Mentions
Reactions
Starred messages
Drafts
DIRECT MESSAGES
tannal (you)
Welcome Bot
CHANNELS
announce
chatter
Apple WWDC announcements
Draft article very critical of AI
Ramblings about SVG
Notes from the Web Engines Hackfest (June 2025)
AMD Upstreams Efficient Malloc Support On GPUs For LLVM libc
(Ab)using usvg and kurbo to generate gcode
Finale - How music software dies (by Tantacrul)
Anyone heard of Moho before?
Show all topics
checkins
general
glazier
kurbo
new members
office hours
pairing
parley
runebender
rust
rust ui
study-group
vello
web
xi-editor
xilem
zulip
BROWSE 13 MORE CHANNELS
chatter</p><blockquote></blockquote><p>Draft article very critical of AI
Mar 8
Raph Levien
01:12
I&rsquo;ve written a draft article for Western Friend, a Quaker publication. It&rsquo;s probably one of the more negative and critical takes you&rsquo;ll find on AI. Comments are welcome (either here or on the doc).</p><p>Dominik Honnef
01:38
It&rsquo;s a pretty exact match of my own opinions on AI.</p><p>Austin M. Reppert
02:44
Maybe some notes about which types of careers are using AI. Good to have some realistic opinions on AI. So much hype bs everywhere.</p><p>Nico Burns
04:30
I have noticed a lot of pressure to work on things involving &ldquo;AI&rdquo; recently. Even where it makes zero sense and actively hinders progress.</p><p>Raph Levien
04:31
You&rsquo;re not alone in noticing and feeling that. This article wasn&rsquo;t specifically in response those pressures, though it is informed by them, it&rsquo;s really been cooking for while in conversations with the editor of that publication.</p><p>Nico Burns
04:31
I&rsquo;m less concerned about surveillance andore concerned about the potential for &ldquo;computer says no&rdquo; scenarios, and AI simply sucking up useful potential (although that&rsquo;s really more about capital chasing fashions than AI in particular)</p><p>Tom Churchman
05:24
I agree wholeheartedly. The only way to improve yourself is to struggle through problems. Like your text editing example, whether AI becomes meaningfully helpful for editing code in the future, perhaps by suggesting improvements and the rationale behind them, we&rsquo;ll have to see. So far in my work the context switching definitely has not been worth it.</p><p>05:54
Generative AI can certainly generate a lot of output, but in designing/engineering part of the value of thought is subtractive, e.g. reducing the number of transistors on a chip by clever design of opcodes. Whether language models can ever convincingly mimic the output of such modes of thought will be interesting to see&mldr;</p><p>Piotr Wyszomirski (chipnertkj)
08:56
For critical thought on matters related to LLMs and the AI boom, I highly recommend checking out Ed Zitron&rsquo;s blog: <a class=link href=https://www.wheresyoured.at/ target=_blank rel=noopener>https://www.wheresyoured.at/</a>
Note that Ed is significantly more skeptical, particularly from the economic and environmental standpoints</p><p>matt rice
09:57
Nico Burns said:</p><p>I&rsquo;m less concerned about surveillance andore concerned about the potential for &ldquo;computer says no&rdquo; scenarios, and AI simply sucking up useful potential (although that&rsquo;s really more about capital chasing fashions than AI in particular)</p><p>I agree, but would say this differently&mldr; i.e. I&rsquo;ve long been interested in laws and legal documents resembling more formal proofs. If we can&rsquo;t trust humans to fairly adjudicate them if we should at least be able to prove that our laws are sound (This is perhaps too strong, I should say laws in a formal logical language provide clarity of intent, and leave little to interpretation). In that sense I am fine with &ldquo;computer says no&rdquo;, but some random AI based decision procedures is nothing like that and does not improve things&mldr;</p><p>Olivier FAURE
17:41
To me, the process of applying that time and effort is the important thing, and is what builds the skill and knowledge</p><p>I strongly agree with this. I&rsquo;d go even further and claim that failing to achieve something is the fundamental unit of work that leads to learning. The more a cursus pushes you to fail (meaningfully and in different ways, not just the same failure over and over) the more you will learn from it.</p><p>Piotr Wyszomirski (chipnertkj)
17:59
failing to achieve something is the fundamental unit of work that leads to learning</p><p>This has been a core part of my philosophy for a very long time</p><p>Chad Brokaw
06:27
Channeling Niels Bohr: â€œAn expert is a person who has made all the mistakes that can be made in a very narrow field.â€</p><p>Richard Dodd
08:12
First of all really enjoyed this article. I&rsquo;m somewhat late to the party. I think AI will force us (as a species) to re-evaluate some of our ideas about how we derive meaning.</p><p>I&rsquo;d preface all of this by saying that meaning is something that is different to every person, and for me it is something that is created intrinsically by humans. The alternative is the belief that meaning is extrinsic, provided by a deity and not something us humans need to concern ourselves with. I&rsquo;ve never found the comfort that others have in religious dogma, because I have a mind that always questions and never just accepts, for better or worse (I have OCD, for example).</p><p>So, assuming that us humans have to create meaning and purpose for ourselves, how does AI change this? &ldquo;Life is a journey, not a destination.&rdquo; AI, and the slop it produces, will force us to transfer meaning from the output of a creative process to the process itself. It might be that some future generative image model produces exceptional quality paintings, but in that situation I would still prefer the imperfections of human artists, because they put their lives and their own meaning into their work. I&rsquo;ve recently seen people using gen AI to create Studio Ghibli versions of images, and while the generated output is impressive, part of the charm of the originals is the care and craft that you know went into their creation. Also AI is very good at imitating van Gough&rsquo;s style, but would be completely incapable of creating that style if it did not already exist, and the meaning I derive from his paintings is totally dependent on my understanding of his experiences as a human.</p><p>I know I talked about art here, but it&rsquo;s true elsewhere as well. The article talks about how AI is already being used in education, and how it tempts us to avoid the graft and failure of the work of learning. Others have attributed meaning to this process of hard work and failure, and I totally agree.</p><p>I really hope that society is able to come together and think critically about this new technology, because for me the biggest risk is that it destroys meaning in people&rsquo;s lives and leads to some sort of societal existential crisis.</p><p>Show more
08:31
Bryan Cantrill&rsquo;s blog was also excellent.</p><p>Raph Levien
22:46
A followup on this: it ended up not getting published (partly some missed communications), but I&rsquo;ve been asked to do an article, possibly adapting some of this one, for an upcoming theme of &ldquo;attunement.&rdquo; I&rsquo;ve started a draft, and again would appreciate feedback. I&rsquo;m not sure whether to try to push the first one into publication; probably just under the activation energy for me.</p><p>matt rice
05:52
Another of my favorite examples is the creation of formal mathematical proofs.
<snip>In this problem domain, hallucinations are not an issue, as there is a way to distinguish plausible but wrong answers from truth</p><p>I haven&rsquo;t finished reading yet, I kind of feel like this section needs a bit more precision, up front we have a proof checker that is well understood by some number of human beings as confirming the veracity of a proof.</p><p>Where I feel like this &ldquo;Hallucinations are not an issue&rdquo; statement goes awry is in the creation of propositions.
Or the relative strength of any axioms embedded therein.
It is entirely possible for a proof to be both valid as well as &ldquo;underhanded&rdquo;, in the sense that by some pesky detail it may not mean exactly what a naive intuition could interpret it as.</p><p>If one comes at it from the perspective of &ldquo;I want it to prove this proposition&rdquo;, and let AI fill in the blanks then yes there would seem to be no room for hallucinations given a decidable checker.</p><p>To give an example of the kind of underhanded thing I am thinking about, consider an (informal) statement like for all the squares of a randomly colored grid, for each square there exists a neighbor with the same color. which all rests on whether the definition of neighbor allows a grid to border itself. I feel like there is some wiggle room here for things to be &ldquo;true&rdquo; but also nonsense, and not really what you want to be proving.</p><p>08:45
I remembered that David A. Wheeler&rsquo;s essay on the allsome quantifier or âˆ€! also goes into what he calls &ldquo;mistranslation of informal statements into formal logic&rdquo;. <a class=link href=https://dwheeler.com/essays/allsome.html target=_blank rel=noopener>https://dwheeler.com/essays/allsome.html</a> while focusing on proving things about the empty set or perhaps translated into rust Iterator&lt;Item=!>.</p><p>I feel like it is important to say that these problems happen without AI involvement, I certainly have and don&rsquo;t feel like it is uncommon to prove something about some definition, only to discover that the definition I wrote is not exactly as written the one I intended. Thus the feeling I get is that we still have this exact attunement problem, where people must make mistakes by themselves first to discern which statements from the AI can be taken at face value based upon it&rsquo;s veracity, and others which may end up being complex tautology at best meaningless, and at worst giving us a false sense of security in a mismatched model.</p><p>08:46
I&rsquo;m not sure I have suggestions yet on how to incorporate any of this feedback into the article yet though.</p><p>Navid Vahdat
17:47
The differentiation of language skills from intelligence puts into words a difference I felt, but could not express before, because in real life, I unconsciously do take language skills as an indicator of intelligence in humans. This distinction also clarifies, that there can never be a artificial general intelligence (AGI) based on the kind of currently developed AI technology.</p><p>For me &ndash; a non native English speaker &ndash; it is kind of unclear what attunement means in the title. The use of the word in the text is clearer, but still its use seems kind of artificial? Maybe an introductory problem statement would help, that describes what kind of attunement people expect, when they think of AI.</p><p>There is a tradeoff between efficiency/cost and risk in every action. E.g. when a nation decides the desired minimum distance to medical facilities from any point in the country it makes a cost-risk-tradeoff: more medical facilities cost more, but also reduce the risk of death in cases of car-accidents at random locations on the road. When you decide the speed at which you drive, there is a efficiency-risk-tradeoff between getting to your destination quickly and not getting there at all (and killing pedestrians and cyclists in the process). These tradeoffs are unavoidable. And there seems to be a set-point for risk, in which all technological progress is used to raise efficiency and reduce cost but not reduce risk anymore. This set-point is different between individuals and between comparable groups.
The use of AI offers such a cost-risk-tradeoff. AI potentially computes working solutions to problems much faster and at much low cost than a workforce. But sometimes the &ldquo;solutions&rdquo; will have catastrophic consequences. The trouble is, that while the efficiency-gains are very well measurable, the risk is not. That is because a) a hallucinating, non-intelligent AI does not give warning signs of problems which it cannot solve. Its results do not deteriorate gradually, but suddenly (catastrophically) and b) the kind of problems it is used to solve can fail in many ways &ndash; many of which are hard to foresee and even if they materialize, the damage they do may stay invisible for a long time. Measurable gains but unmeasurable risks make for a clear incentive to use AI. One can&rsquo;t argue against its use with &ldquo;We should abstain from the humongous gains of using AI to solve problem X, because I feel this is risky (but can&rsquo;t quantify the risk or even tell the kind of risk we are facing).&rdquo;
In earlier technical revolutions the use of new technology replaced the need for, say hundreds of workers that hand-spun fibers to yarn, by the need for a couple of technicians, that ensured the machines worked properly. This made a lot of workers redundant but also required upskilling the work force. Checking that the machines are working properly in case of AIs requires checking all their results, because they don&rsquo;t stop working, when they produce garbage and there is no way to predict the quality of their results from their inner structure. Unfortunately, checking all results requires just as much work as creating the results but also requires a higher skill level. E.g. a student, that does his homework using AI, would need to take the role of a hyper vigilant editor, who checks the style of the essay, the veracity of its contents and whether the essay authentically expresses his own understanding and evaluation of the subject. If he could do that in the first place, he wouldn&rsquo;t need to write the essay as a part of his learning. He&rsquo;d already be on the level of the teacher.</p><p>Show less
matt rice
17:48
Another thing that came to mind as I was trying to sleep is the satirical paper &ldquo;mustard watches an integrated approach to time and food&rdquo; <a class=link href=https://girard.perso.math.cnrs.fr/mustard/titre.html target=_blank rel=noopener>https://girard.perso.math.cnrs.fr/mustard/titre.html</a> which being from 1990, predates AI but pokes fun at useless results given the formal treatment without understanding.</p><p>Raph Levien
08:33
Thanks greatly for the feedback here. I&rsquo;ve expanded and revised the article, also providing more nuance to the idea that proofs are hallucination-proof. It will be published in the forthcoming issue of Western Friend on &ldquo;attunement.&rdquo;</p><p>Message #chatter > Draft article very critical of AI
Start new conversation
New direct message
Filter users
Dominik Honnef
Piotr Wyszomirski (chipnertkj)
Nico Burns
Raph Levien
Austin M. Reppert
Chad Brokaw
matt rice
Navid Vahdat
Olivier FAURE
Richard Dodd
Tom Churchman
tannal</p><p>(you)
Alex Gemberg
Bruce Mitchener
Bunbury
Jed Brown
Joe Neeman
Aaron Muir Hamilton
Alya Abbott
Benjamin Saunders
Colin Rofls
Jared O&rsquo;Connell
jermy
Kaur Kuut
Keavon Chambers
Laurenz Stampfl
Lucas Meurer
Spencer C. Imbleau
Stephan van Schaik
Stewart Connor
valadaptive
Zarenor
éƒ­è‚²èƒœ
ä¸€ä¸
Ada BÃ¶hm
Adam
Adam Goldstein
Adam Nemecek
additional-pumpkin
AdrianEddy
View all subscribers
Invite to organization</p><p>è¿™é‡Œåœ¨è®¨è®ºäººå·¥æ™ºèƒ½</p><hr><p><strong>Cursor</strong></p><p>æ˜¯çš„ï¼Œä½ å®Œå…¨æ­£ç¡®ï¼æ ¹æ®ä½ æä¾›çš„èŠå¤©è®°å½•ï¼Œè¿™é‡Œæ­£åœ¨çƒ­çƒˆè®¨è®º <strong>äººå·¥æ™ºèƒ½ (AI)</strong>ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œè®¨è®ºçš„æ ¸å¿ƒæ˜¯ï¼š</p><ul><li><strong>å¯¹ AI çš„æ‰¹åˆ¤æ€§è§‚ç‚¹ï¼š</strong> å›´ç»• Raph Levien æ’°å†™çš„ä¸€ç¯‡â€œå¯¹ AI éå¸¸æ‰¹åˆ¤â€çš„æ–‡ç« å±•å¼€ã€‚</li><li><strong>AI çš„å±€é™æ€§ï¼š</strong> å‚ä¸è€…ä»¬è¡¨è¾¾äº†å¯¹ AI çš„æ‹…å¿§ï¼ŒåŒ…æ‹¬å®ƒå¯èƒ½é˜»ç¢çœŸæ­£è¿›æ­¥ã€äº§ç”Ÿâ€œç”µè„‘è¯´ä¸â€çš„åƒµç¡¬ç»“æœã€ä»¥åŠ AI å¯¹äººç±»å­¦ä¹ å’Œåˆ›é€ è¿‡ç¨‹ä¸­â€œå¥‹æ–—â€å’Œâ€œå¤±è´¥â€çš„ä»·å€¼çš„æ½œåœ¨å½±å“ã€‚</li><li><strong>äººç±»æ™ºæ…§ä¸ AI çš„åŒºåˆ«ï¼š</strong> è®¨è®ºäº† AI ç¼ºä¹çœŸæ­£çš„æ™ºèƒ½ï¼Œä»¥åŠäººç±»é€šè¿‡äº²èº«ç»å†å’ŒçŠ¯é”™æ¥ç§¯ç´¯æŠ€èƒ½å’ŒçŸ¥è¯†çš„é‡è¦æ€§ã€‚</li><li><strong>AI çš„é£é™©ï¼š</strong> æåˆ°äº† AI å¯èƒ½å¸¦æ¥çš„â€œè®¡ç®—æœºè¯´ä¸â€æƒ…æ™¯ã€ç›‘ç®¡å’Œéšç§é—®é¢˜ï¼Œä»¥åŠå…¶å¯¹ç¤¾ä¼šæ„ä¹‰çš„æ½œåœ¨ç ´åã€‚</li><li><strong>å½¢å¼åŒ–éªŒè¯å’Œâ€œå¹»è§‰â€é—®é¢˜ï¼š</strong> æœ‰äººè®¨è®ºäº† AI åœ¨ç”Ÿæˆæ•°å­¦è¯æ˜ç­‰é¢†åŸŸæ—¶ï¼Œè™½ç„¶ç»“æœå¯èƒ½â€œæœ‰æ•ˆâ€ï¼Œä½†ç”±äºåˆå§‹å‡è®¾æˆ–å®šä¹‰çš„æ¨¡ç³Šï¼Œä»å¯èƒ½äº§ç”Ÿâ€œè¨€ä¸ç”±è¡·â€æˆ–â€œæ¯«æ— æ„ä¹‰â€çš„ç»“è®ºï¼Œå³â€œå¹»è§‰â€é—®é¢˜å³ä½¿åœ¨çœ‹ä¼¼ä¸¥è°¨çš„é¢†åŸŸä¹Ÿå­˜åœ¨ã€‚</li><li><strong>â€œè°ƒè° (attunement)â€çš„ä¸»é¢˜ï¼š</strong> Raph æåˆ°åç»­ä¼šæœ‰ä¸€ç¯‡å…³äºâ€œè°ƒè°â€çš„æ–‡ç« ï¼Œæš—ç¤ºäº† AI è¾“å‡ºå¦‚ä½•ä¸äººç±»çš„æ„å›¾å’Œç†è§£ä¿æŒä¸€è‡´çš„é—®é¢˜ã€‚</li></ul><p>æ€»è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³äº <strong>AI çš„ä¼¦ç†ã€å“²å­¦ã€ç¤¾ä¼šå’Œå®é™…åº”ç”¨å±€é™æ€§</strong>çš„æ·±å…¥è®¨è®ºã€‚</p><hr><p><strong>User</strong></p><p>Googleçš„Brotliæ˜¯ä»€ä¹ˆåº“ï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>Google çš„ Brotli æ˜¯ä¸€ä¸ª<strong>é€šç”¨çš„ã€æ— æŸçš„æ•°æ®å‹ç¼©ç®—æ³•</strong>ã€‚</p><p>å®ƒæœ€åˆç”± Google å¼€å‘ï¼Œå¹¶äº 2015 å¹´å‘å¸ƒã€‚Brotli çš„ä¸»è¦ç›®æ ‡æ˜¯ä¸º <strong>Web å†…å®¹æä¾›æ›´é«˜æ•ˆçš„å‹ç¼©</strong>ï¼Œä»¥å‡å°‘æ•°æ®ä¼ è¾“é‡ï¼Œä»è€ŒåŠ å¿«ç½‘é¡µåŠ è½½é€Ÿåº¦ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚</p><p>ä»¥ä¸‹æ˜¯ Brotli çš„ä¸€äº›å…³é”®ç‰¹ç‚¹ï¼š</p><ol><li><strong>æ— æŸå‹ç¼©ï¼š</strong> ä¸ JPEG æˆ– MP3 ç­‰æœ‰æŸå‹ç¼©ä¸åŒï¼ŒBrotli æ˜¯ä¸€ç§æ— æŸå‹ç¼©ç®—æ³•ï¼Œè¿™æ„å‘³ç€ç»è¿‡å‹ç¼©å’Œè§£å‹ç¼©åï¼ŒåŸå§‹æ•°æ®å¯ä»¥å®Œå…¨æ¢å¤ï¼Œæ²¡æœ‰ä»»ä½•ä¿¡æ¯ä¸¢å¤±ã€‚</li><li><strong>é«˜å‹ç¼©æ¯”ï¼š</strong> ç›¸å¯¹äºä¼ ç»Ÿçš„ Deflate (gzip) ç®—æ³•ï¼ŒBrotli é€šå¸¸èƒ½æä¾›æ›´é«˜çš„å‹ç¼©æ¯”ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†æ–‡æœ¬å’Œé™æ€ Web å†…å®¹æ—¶æ•ˆæœæ˜¾è‘—ã€‚è¿™æ„å‘³ç€åŒæ ·çš„æ•°æ®ï¼ŒBrotli å¯ä»¥å°†å…¶å‹ç¼©å¾—æ›´å°ã€‚</li><li><strong>é’ˆå¯¹ Web ä¼˜åŒ–ï¼š</strong> Brotli åŒ…å«äº†ä¸“é—¨ä¸º Web æµè§ˆå™¨è®¾è®¡çš„åŠŸèƒ½ï¼Œä¾‹å¦‚é¢„å®šä¹‰å­—å…¸ï¼ˆåŒ…å«å¸¸ç”¨ HTMLã€CSSã€JS å…³é”®å­—ç­‰ï¼‰ï¼Œè¿™æœ‰åŠ©äºåœ¨å°æ–‡ä»¶ä¸Šå®ç°æ›´å¥½çš„å‹ç¼©æ•ˆæœã€‚</li><li><strong>å¿«é€Ÿè§£å‹ç¼©ï¼š</strong> å°½ç®¡å…¶å‹ç¼©è¿‡ç¨‹å¯èƒ½ç›¸å¯¹è€—æ—¶ï¼ˆå°¤å…¶æ˜¯åœ¨æœ€é«˜å‹ç¼©çº§åˆ«ä¸‹ï¼‰ï¼Œä½† Brotli çš„è§£å‹ç¼©é€Ÿåº¦éå¸¸å¿«ï¼Œè¿™å¯¹äºå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰æ¥è¯´éå¸¸é‡è¦ã€‚</li><li><strong>å¹¿æ³›æ”¯æŒï¼š</strong> ç°ä»£ä¸»æµçš„ Web æµè§ˆå™¨ï¼ˆå¦‚ Chrome, Firefox, Safari, Edgeï¼‰éƒ½åŸç”Ÿæ”¯æŒ Brotli è§£å‹ç¼©ã€‚è®¸å¤š Web æœåŠ¡å™¨å’Œ CDN ä¹Ÿæ”¯æŒ Brotli å‹ç¼©å’Œä¼ è¾“ã€‚</li></ol><p>ç®€è€Œè¨€ä¹‹ï¼ŒBrotli æ˜¯ Google ä¸ºæå‡ Web æ€§èƒ½è€Œæ¨å‡ºçš„ä¸€é¡¹é‡è¦æŠ€æœ¯ï¼Œå®ƒé€šè¿‡æ›´å…ˆè¿›çš„å‹ç¼©ç®—æ³•å¸®åŠ©å‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡ã€‚</p><hr><p><strong>User</strong></p><p>CtaApillib æå…‰è®¤è¯ åˆæ˜¯ä»€ä¹ˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p><code>CtaApillib æå…‰è®¤è¯</code> é€šå¸¸æŒ‡çš„æ˜¯ <strong>æå…‰ (JPush)</strong> æä¾›çš„ä¸€é¡¹åä¸º <strong>â€œæå…‰è®¤è¯â€</strong> çš„æœåŠ¡ï¼Œè€Œ <code>CtaApillib</code> å¾ˆå¯èƒ½æ˜¯è¿™ä¸ªæœåŠ¡ç›¸å…³çš„ä¸€ä¸ª<strong>SDK (Software Development Kit) æˆ–å†…éƒ¨åº“çš„åç§°</strong>ã€‚</p><p>è®©æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š</p><ol><li><p><strong>æå…‰ (JPush)</strong>:
æå…‰æ˜¯ä¸­å›½çŸ¥åçš„ç§»åŠ¨å¼€å‘è€…æœåŠ¡æä¾›å•†ï¼Œå®ƒæä¾›ä¸€ç³»åˆ—æœåŠ¡ï¼Œæœ€å‡ºåçš„æ˜¯ <strong>æ¨é€é€šçŸ¥ (JPush)</strong>ã€‚é™¤äº†æ¨é€ï¼Œæå…‰è¿˜æä¾›çŸ­ä¿¡ã€ç»Ÿè®¡ã€å³æ—¶é€šè®¯ä»¥åŠä½ æåˆ°çš„â€œè®¤è¯â€ç­‰æœåŠ¡ã€‚</p></li><li><p><strong>æå…‰è®¤è¯</strong>:
â€œæå…‰è®¤è¯â€æ˜¯æå…‰æä¾›çš„ä¸€ç§<strong>ä¸€é”®ç™»å½•/æ‰‹æœºå·éªŒè¯</strong>æœåŠ¡ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li><strong>å¿«é€ŸéªŒè¯</strong>: ç”¨æˆ·æ— éœ€è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œé€šè¿‡ç§»åŠ¨è¿è¥å•†çš„æ•°æ®ç½‘ç»œå³å¯å®ç°å¿«é€Ÿçš„æœ¬æœºå·ç è®¤è¯æˆ–ä¸€é”®ç™»å½•ã€‚</li><li><strong>æå‡ç”¨æˆ·ä½“éªŒ</strong>: ç®€åŒ–äº†æ³¨å†Œ/ç™»å½•æµç¨‹ï¼Œå‡å°‘äº†ç”¨æˆ·çš„æ“ä½œæ­¥éª¤ï¼Œé¿å…äº†çŸ­ä¿¡éªŒè¯ç æ¥æ”¶å»¶è¿Ÿæˆ–å¤±è´¥çš„é—®é¢˜ã€‚</li><li><strong>å®‰å…¨ä¾¿æ·</strong>: åˆ©ç”¨è¿è¥å•†çš„ç½‘å…³è®¤è¯èƒ½åŠ›ï¼Œåœ¨ä¿éšœå®‰å…¨çš„å‰æä¸‹æä¾›ä¾¿æ·çš„éªŒè¯æœåŠ¡ã€‚</li><li><strong>åº”ç”¨åœºæ™¯</strong>: ä¸»è¦ç”¨äºç§»åŠ¨ App çš„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç»‘å®šæ‰‹æœºå·ã€æ‰¾å›å¯†ç ç­‰åœºæ™¯ã€‚</li></ul></li><li><p><strong>CtaApillib</strong>:
è¿™ä¸ªåå­—å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªæŠ€æœ¯ç»†èŠ‚ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå¯¹å¤–éƒ¨ç”¨æˆ·å¹¿ä¸ºäººçŸ¥çš„åº“åç§°ã€‚å®ƒå¾ˆå¯èƒ½æ˜¯æå…‰è®¤è¯ SDK å†…éƒ¨æˆ–å…¶ä¾èµ–çš„ä¸€ä¸ª<strong>ç§æœ‰åº“</strong>ï¼Œç”¨äºå¤„ç†ä¸è¿è¥å•† API äº¤äº’çš„åº•å±‚é€šä¿¡ (CTA - Carrier&rsquo;s Telecom Access / Carrier Telecommunication API Library)ã€‚å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œä½ é€šå¸¸ä¼šé›†æˆæå…‰è®¤è¯çš„å®˜æ–¹ SDK (ä¾‹å¦‚ Android æˆ– iOS å¹³å°ä¸Šçš„ç‰¹å®šåç§°çš„ SDK)ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æˆ–å…³æ³¨ <code>CtaApillib</code> è¿™ä¸ªåº•å±‚åº“ã€‚</p></li></ol><p><strong>æ€»ç»“æ¥è¯´ï¼Œ<code>CtaApillib æå…‰è®¤è¯</code> æ„å‘³ç€ä½ æˆ–æŸä¸ªåº”ç”¨æ­£åœ¨ä½¿ç”¨æå…‰æä¾›çš„åŸºäºè¿è¥å•†ç½‘ç»œçš„ä¸€é”®ç™»å½•/æœ¬æœºå·ç è®¤è¯æœåŠ¡ã€‚</strong> å®ƒçš„æ ¸å¿ƒåŠŸèƒ½åœ¨äºè®©ç”¨æˆ·æ— éœ€æ‰‹åŠ¨è¾“å…¥éªŒè¯ç ï¼Œå³å¯å¿«é€Ÿå®‰å…¨åœ°å®Œæˆèº«ä»½éªŒè¯ã€‚</p><hr><p><strong>User</strong></p><p>opencore-amræ˜¯ä»€ä¹ˆ</p><hr><p><strong>Cursor</strong></p><p><code>opencore-amr</code> æ˜¯ä¸€ä¸ª <strong>å¼€æºçš„éŸ³é¢‘ç¼–è§£ç å™¨åº“</strong>ï¼Œä¸»è¦ç”¨äºå¤„ç† <strong>AMR (Adaptive Multi-Rate)</strong> éŸ³é¢‘æ ¼å¼ã€‚</p><p>ä»¥ä¸‹æ˜¯å®ƒçš„ä¸»è¦ç‰¹ç‚¹å’Œä½œç”¨ï¼š</p><ol><li><p><strong>AMR éŸ³é¢‘æ ¼å¼ï¼š</strong></p><ul><li>AMR æ˜¯ä¸€ç§ä¸“é—¨ä¸º <strong>è¯­éŸ³ç¼–ç </strong> è®¾è®¡çš„éŸ³é¢‘å‹ç¼©æ ¼å¼ï¼Œå¹¿æ³›åº”ç”¨äºç§»åŠ¨é€šä¿¡é¢†åŸŸï¼Œä¾‹å¦‚ 2G (GSM) å’Œ 3G (UMTS) èœ‚çªç½‘ç»œä¸­çš„è¯­éŸ³é€šè¯ã€‚</li><li>å®ƒæœ‰ä¸¤ç§ä¸»è¦å˜ä½“ï¼š<ul><li><strong>AMR-NB (NarrowBand)ï¼š</strong> çª„å¸¦ï¼Œé€‚ç”¨äºæ ‡å‡†ç”µè¯è¯­éŸ³è´¨é‡ã€‚</li><li><strong>AMR-WB (WideBand)ï¼š</strong> å®½å¸¦ï¼Œæä¾›æ›´å¥½çš„éŸ³è´¨ï¼ˆå¸¸è¢«ç§°ä¸º HD Voiceï¼‰ã€‚</li></ul></li></ul></li><li><p><strong><code>opencore-amr</code> åº“çš„ä½œç”¨ï¼š</strong></p><ul><li><code>opencore-amr</code> æä¾›äº† AMR éŸ³é¢‘çš„ <strong>ç¼–ç  (encoder)</strong> å’Œ <strong>è§£ç  (decoder)</strong> åŠŸèƒ½ã€‚è¿™æ„å‘³ç€å®ƒèƒ½å¤Ÿå°†åŸå§‹éŸ³é¢‘æ•°æ®å‹ç¼©æˆ AMR æ ¼å¼ï¼ˆç¼–ç ï¼‰ï¼Œä¹Ÿèƒ½å°† AMR æ ¼å¼çš„æ•°æ®è¿˜åŸæˆåŸå§‹éŸ³é¢‘æ•°æ®ï¼ˆè§£ç ï¼‰ã€‚</li><li>å®ƒé€šå¸¸æŒ‡çš„æ˜¯ <strong>AMR-NB</strong> çš„å¼€æºå®ç°ï¼Œè™½ç„¶ä¹Ÿæœ‰ä¸€äº›é¡¹ç›®æˆ–åˆ†æ”¯å¯èƒ½åŒ…å« AMR-WBã€‚</li><li>ç”±äºæ˜¯å¼€æºçš„ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­é›†æˆ AMR ç¼–è§£ç åŠŸèƒ½ï¼Œè€Œæ— éœ€ä»å¤´å¼€å§‹å®ç°å¤æ‚çš„ç®—æ³•ã€‚</li></ul></li><li><p><strong>â€œopencoreâ€ çš„ç”±æ¥ï¼š</strong></p><ul><li>è¿™ä¸ªåç§°ä¸­çš„ &ldquo;opencore&rdquo; éƒ¨åˆ†é€šå¸¸æŒ‡å‘ä¸€ä¸ªå«åš <strong>OpenCORE</strong> çš„å¤šåª’ä½“æ¡†æ¶ã€‚OpenCORE æ˜¯ä¸€ä¸ªç”± PacketVideo å…¬å¸å‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨æä¾›å„ç§éŸ³è§†é¢‘ç¼–è§£ç å™¨çš„å®ç°ã€‚<code>opencore-amr</code> å°±æ˜¯ä»è¿™ä¸ªé¡¹ç›®ä¸­åˆ†ç¦»å‡ºæ¥æˆ–æ·±å—å…¶å½±å“çš„ AMR ç¼–è§£ç å™¨éƒ¨åˆ†ã€‚</li></ul></li></ol><p><strong>ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœä½ éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­æ’­æ”¾ã€å½•åˆ¶æˆ–è½¬æ¢ AMR æ ¼å¼çš„è¯­éŸ³æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œæ‰‹æœºå½•éŸ³ã€æŸäº›å³æ—¶é€šè®¯åº”ç”¨ä¸­çš„è¯­éŸ³æ¶ˆæ¯ï¼‰ï¼Œ<code>opencore-amr</code> å°±æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ã€å¯é çš„å¼€æºè§£å†³æ–¹æ¡ˆã€‚</strong></p><hr><p><strong>User</strong></p><p>hdiffpatchæ˜¯ä»€ä¹ˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p><code>hdiffpatch</code> æ˜¯ä¸€ä¸ªå¼€æºçš„ <strong>äºŒè¿›åˆ¶æ–‡ä»¶å·®å¼‚æ¯”è¾ƒ (diff) å’Œè¡¥ä¸åº”ç”¨ (patch) å·¥å…·/åº“</strong>ã€‚</p><p>å®ƒçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ï¼š</p><ol><li><strong>ç”Ÿæˆå·®å¼‚æ–‡ä»¶ (Diff)</strong>: å®ƒå¯ä»¥æ¯”è¾ƒä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„åº”ç”¨ç¨‹åºã€æ¸¸æˆæ–‡ä»¶æˆ–å›ºä»¶ï¼‰ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªéå¸¸å°çš„è¡¥ä¸æ–‡ä»¶ã€‚è¿™ä¸ªè¡¥ä¸æ–‡ä»¶åªåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´çš„å˜åŒ–ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ã€‚</li><li><strong>åº”ç”¨è¡¥ä¸ (Patch)</strong>: å®ƒå¯ä»¥åˆ©ç”¨è¿™ä¸ªå°çš„è¡¥ä¸æ–‡ä»¶ï¼Œå°†æ—§ç‰ˆæœ¬çš„æ–‡ä»¶è½¬æ¢ä¸ºæ–°ç‰ˆæœ¬çš„æ–‡ä»¶ã€‚</li></ol><p><strong>ä¸»è¦ç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼š</strong></p><ul><li><strong>é«˜æ•ˆå’Œç´§å‡‘ï¼š</strong> <code>hdiffpatch</code> çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å¤Ÿç”Ÿæˆæå°çš„è¡¥ä¸æ–‡ä»¶ï¼Œå³ä½¿åŸå§‹æ–‡ä»¶å¾ˆå¤§ï¼Œä¸”åªæœ‰å°‘é‡æ”¹åŠ¨ï¼Œä¹Ÿèƒ½ä¿æŒè¡¥ä¸æ–‡ä»¶éå¸¸å°ã€‚è¿™å¯¹äºç½‘ç»œä¼ è¾“å’Œå­˜å‚¨éƒ½éå¸¸æœ‰åˆ©ã€‚</li><li><strong>è·¨å¹³å°ï¼š</strong> å®ƒé€šå¸¸ç”¨ C++ ç¼–å†™ï¼Œå¯ä»¥ç¼–è¯‘å’Œè¿è¡Œåœ¨å¤šç§æ“ä½œç³»ç»Ÿä¸Šï¼ŒåŒ…æ‹¬ Windows, Linux, macOS, Android, iOS ç­‰ã€‚</li><li><strong>é²æ£’æ€§ï¼š</strong> åœ¨æ–‡ä»¶æŸåæˆ–ä¼ è¾“é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œå®ƒé€šå¸¸ä¼šå°è¯•ä¿æŒè‰¯å¥½çš„æ€§èƒ½æˆ–æä¾›é”™è¯¯æ£€æµ‹ã€‚</li><li><strong>åº•å±‚ä¼˜åŒ–ï¼š</strong> å®ƒä½¿ç”¨äº†å¤æ‚çš„ç®—æ³•ï¼Œå¦‚åç¼€æ•°ç»„ (suffix array) ç­‰ï¼Œæ¥é«˜æ•ˆåœ°æ‰¾åˆ°æ–‡ä»¶é—´çš„é‡å¤å’Œå˜åŒ–æ¨¡å¼ã€‚</li></ul><p><strong>å…¸å‹åº”ç”¨åœºæ™¯ï¼š</strong></p><p><code>hdiffpatch</code> ä¸»è¦ç”¨äºé‚£äº›éœ€è¦é«˜æ•ˆåˆ†å‘è½¯ä»¶æ›´æ–°çš„åœºæ™¯ï¼š</p><ol><li><strong>æ¸¸æˆæ›´æ–°ï¼š</strong> æ¸¸æˆå®¢æˆ·ç«¯é€šå¸¸å¾ˆå¤§ï¼Œ<code>hdiffpatch</code> å¯ä»¥å¤§å¤§å‡å°æ¯æ¬¡æ›´æ–°åŒ…çš„å¤§å°ï¼Œè®©ç©å®¶æ›´å¿«åœ°ä¸‹è½½è¡¥ä¸ã€‚</li><li><strong>åº”ç”¨ç¨‹åºæ›´æ–°ï¼š</strong> æ¡Œé¢è½¯ä»¶ã€æ‰‹æœº App ç­‰çš„è‡ªåŠ¨æ›´æ–°æœºåˆ¶ã€‚</li><li><strong>å›ºä»¶æ›´æ–°ï¼š</strong> åµŒå…¥å¼è®¾å¤‡ã€è·¯ç”±å™¨ç­‰å›ºä»¶çš„åœ¨çº¿å‡çº§ã€‚</li><li><strong>äº‘æœåŠ¡/åŒæ­¥ï¼š</strong> éœ€è¦åŒæ­¥æˆ–æ›´æ–°å¤§é‡å¤§å‹æ–‡ä»¶æ—¶ï¼Œåªä¼ è¾“å·®å¼‚éƒ¨åˆ†ã€‚</li></ol><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>hdiffpatch</code> æ˜¯ä¸€æ¬¾ç”¨äºç”Ÿæˆå’Œåº”ç”¨äºŒè¿›åˆ¶å·®å¼‚è¡¥ä¸çš„å·¥å…·ï¼Œæ—¨åœ¨æœ€å¤§é™åº¦åœ°å‡å°‘æ›´æ–°æ—¶çš„æ•°æ®ä¼ è¾“é‡ã€‚</p><hr><p><strong>User</strong></p><p>ä¸€èˆ¬çš„NPé—®é¢˜éƒ½åªèƒ½ç”¨å›æº¯æˆ–è€…æšä¸¾</p><hr><p><strong>Cursor</strong></p><p>ä½ æå‡ºâ€œä¸€èˆ¬çš„NPé—®é¢˜éƒ½åªèƒ½ç”¨å›æº¯æˆ–è€…æšä¸¾â€è¿™ä¸ªè¯´æ³•ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šåæ˜ äº†æˆ‘ä»¬ç›®å‰å¯¹NPé—®é¢˜çš„ç†è§£ï¼Œä½†å®ƒéœ€è¦ä¸€äº›æ›´ç²¾ç¡®çš„è§£é‡Šã€‚</p><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¾„æ¸…å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><p><strong>NPé—®é¢˜ (Nondeterministic Polynomial time)</strong>:</p><ul><li>NPé—®é¢˜çš„æ­£å¼å®šä¹‰æ˜¯ï¼šä¸€ä¸ªé—®é¢˜çš„è§£å¯ä»¥åœ¨<strong>å¤šé¡¹å¼æ—¶é—´ (polynomial time)</strong> å†…è¢«<strong>éªŒè¯ (verify)</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰äººç»™ä½ ä¸€ä¸ªNPé—®é¢˜çš„ç­”æ¡ˆï¼Œä½ å¯ä»¥åœ¨å¤šé¡¹å¼æ—¶é—´å†…æ£€æŸ¥è¿™ä¸ªç­”æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚</li><li><strong>é‡è¦æç¤ºï¼š</strong> NPé—®é¢˜æœ¬èº«å¹¶æ²¡æœ‰è¯´å®ƒ<strong>å¦‚ä½•è§£å†³</strong>ï¼Œåªè¯´äº†<strong>å¦‚ä½•éªŒè¯</strong>ã€‚ä¾‹å¦‚ï¼Œç»™å®šæ—…è¡Œå•†é—®é¢˜ï¼ˆTSPï¼‰çš„ä¸€æ¡è·¯å¾„ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å¤šé¡¹å¼æ—¶é—´å†…è®¡ç®—å‡ºè¿™æ¡è·¯å¾„çš„æ€»é•¿åº¦ï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦åŒ…å«æ‰€æœ‰åŸå¸‚ã€‚</li></ul></li><li><p><strong>Pé—®é¢˜ (Polynomial time)</strong>:</p><ul><li>Pé—®é¢˜æ˜¯å¯ä»¥åœ¨<strong>å¤šé¡¹å¼æ—¶é—´</strong>å†…è¢«<strong>è§£å†³ (solve)</strong> çš„é—®é¢˜ã€‚æ‰€æœ‰çš„Pé—®é¢˜éƒ½æ˜¯NPé—®é¢˜ï¼ˆå› ä¸ºå¦‚æœèƒ½å¤šé¡¹å¼æ—¶é—´è§£å†³ï¼Œé‚£è‡ªç„¶ä¹Ÿèƒ½å¤šé¡¹å¼æ—¶é—´éªŒè¯ï¼‰ã€‚</li></ul></li><li><p><strong>NP-å®Œå…¨é—®é¢˜ (NP-Complete, NPC)</strong>:</p><ul><li>NPé—®é¢˜ä¸­æœ€â€œéš¾â€çš„ä¸€ç±»ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªNPå®Œå…¨é—®é¢˜å­˜åœ¨å¤šé¡¹å¼æ—¶é—´çš„è§£ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„NPé—®é¢˜éƒ½å­˜åœ¨å¤šé¡¹å¼æ—¶é—´çš„è§£ï¼ˆå³P=NPï¼‰ã€‚ç›®å‰ï¼Œæˆ‘ä»¬<strong>æ™®éè®¤ä¸º P â‰  NP</strong>ï¼Œè¿™æ„å‘³ç€NPå®Œå…¨é—®é¢˜åœ¨æœ€åæƒ…å†µä¸‹ä¸å­˜åœ¨å¤šé¡¹å¼æ—¶é—´çš„è§£ã€‚</li></ul></li><li><p><strong>NP-éš¾é—®é¢˜ (NP-Hard)</strong>:</p><ul><li>æ¯”NPå®Œå…¨é—®é¢˜æ›´å¹¿çš„ä¸€ç±»ã€‚å®ƒè‡³å°‘å’ŒNPå®Œå…¨é—®é¢˜ä¸€æ ·éš¾ï¼Œä½†ä¸ä¸€å®šæ˜¯NPé—®é¢˜ï¼ˆå³å®ƒçš„è§£ä¸ä¸€å®šèƒ½åœ¨å¤šé¡¹å¼æ—¶é—´éªŒè¯ï¼‰ã€‚</li></ul></li></ol><p><strong>å›åˆ°ä½ çš„è¯´æ³•ï¼šâ€œä¸€èˆ¬çš„NPé—®é¢˜éƒ½åªèƒ½ç”¨å›æº¯æˆ–è€…æšä¸¾â€ï¼š</strong></p><p>å¯¹äº<strong>NP-å®Œå…¨é—®é¢˜</strong>å’Œ<strong>NP-éš¾é—®é¢˜</strong>ï¼ˆé€šå¸¸æˆ‘ä»¬è¯´çš„â€œNPé—®é¢˜â€åœ¨å£è¯­ä¸­å¾€å¾€æŒ‡çš„å°±æ˜¯è¿™ç±»æœ€éš¾çš„é—®é¢˜ï¼‰ï¼Œåœ¨å¯»æ‰¾<strong>ç²¾ç¡®æœ€ä¼˜è§£</strong>æ—¶ï¼Œåœ¨ç›®å‰å·²çŸ¥çš„ç®—æ³•ä¸­ï¼Œç¡®å®<strong>æœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯æŒ‡æ•°çº§çš„</strong>ã€‚å›æº¯æ³• (Backtracking) å’Œæšä¸¾æ³• (Enumeration/Brute Force) éƒ½æ˜¯è¿™ç±»æŒ‡æ•°çº§ç®—æ³•çš„å…¸å‹ä»£è¡¨ï¼š</p><ul><li><strong>æšä¸¾æ³• (Enumeration / Brute Force)</strong>ï¼šéå†æ‰€æœ‰å¯èƒ½çš„è§£ï¼Œç„¶åæ£€æŸ¥å“ªä¸ªæ˜¯ç¬¦åˆæ¡ä»¶çš„ã€‚ä¾‹å¦‚ï¼Œæ—…è¡Œå•†é—®é¢˜æš´åŠ›æšä¸¾æ‰€æœ‰è·¯å¾„ã€‚</li><li><strong>å›æº¯æ³• (Backtracking)</strong>ï¼šè¿™æ˜¯ä¸€ç§ç³»ç»Ÿæœç´¢æ‰€æœ‰å¯èƒ½è§£çš„æ–¹æ³•ï¼Œå®ƒé€šè¿‡å‰ªææ¥é¿å…ä¸å¿…è¦çš„è®¡ç®—ã€‚å½“å‘ç°å½“å‰è·¯å¾„ä¸å¯èƒ½å¾—åˆ°æœ‰æ•ˆè§£æ—¶ï¼Œå°±ä¼šâ€œå›æº¯â€åˆ°ä¸Šä¸€æ­¥ï¼Œå°è¯•å…¶ä»–è·¯å¾„ã€‚è¿™æ¯”çº¯ç²¹çš„æšä¸¾æ›´æœ‰æ•ˆç‡ï¼Œä½†æœ€åæƒ…å†µä¸‹ä»ç„¶æ˜¯æŒ‡æ•°çº§çš„ã€‚</li></ul><p><strong>ç„¶è€Œï¼Œè¯´â€œåªèƒ½â€ç”¨å›æº¯æˆ–æšä¸¾å¹¶ä¸å®Œå…¨å‡†ç¡®ï¼ŒåŸå› å¦‚ä¸‹ï¼š</strong></p><ol><li><p><strong>å­˜åœ¨äºPçš„NPé—®é¢˜ï¼š</strong> è®¸å¤šNPé—®é¢˜å®é™…ä¸Šæ˜¯Pé—®é¢˜ï¼ˆä¾‹å¦‚æœ€çŸ­è·¯å¾„é—®é¢˜ã€æœ€å°ç”Ÿæˆæ ‘é—®é¢˜ç­‰ï¼‰ï¼Œå®ƒä»¬æœ‰å·²çŸ¥çš„é«˜æ•ˆå¤šé¡¹å¼æ—¶é—´ç®—æ³•ï¼Œæ ¹æœ¬ä¸éœ€è¦å›æº¯æˆ–æšä¸¾ã€‚ä½ è¯´çš„â€œä¸€èˆ¬çš„NPé—®é¢˜â€å¯èƒ½éšå«åœ°æŒ‡NPå®Œå…¨é—®é¢˜ã€‚</p></li><li><p><strong>å¯å‘å¼ç®—æ³•å’Œè¿‘ä¼¼ç®—æ³•ï¼š</strong></p><ul><li>å¯¹äºè®¸å¤šå®é™…åº”ç”¨ä¸­çš„NP-éš¾é—®é¢˜ï¼Œå½“è¾“å…¥è§„æ¨¡å¾ˆå¤§æ—¶ï¼ŒæŒ‡æ•°çº§å¤æ‚åº¦çš„å›æº¯æˆ–æšä¸¾æ–¹æ³•æ ¹æœ¬æ— æ³•åœ¨åˆç†æ—¶é—´å†…å¾—åˆ°è§£ã€‚</li><li>è¿™æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨<strong>å¯å‘å¼ç®—æ³• (Heuristics)</strong> æˆ–<strong>è¿‘ä¼¼ç®—æ³• (Approximation Algorithms)</strong>ã€‚<ul><li><strong>å¯å‘å¼ç®—æ³•</strong>ï¼šè¿™äº›ç®—æ³•ä¸ä¿è¯æ‰¾åˆ°æœ€ä¼˜è§£ï¼Œä½†èƒ½åœ¨åˆç†çš„æ—¶é—´å†…æ‰¾åˆ°ä¸€ä¸ªâ€œè¶³å¤Ÿå¥½â€çš„è§£ã€‚å®ƒä»¬å¯èƒ½é‡‡ç”¨è´ªå©ªã€å±€éƒ¨æœç´¢ã€é—ä¼ ç®—æ³•ã€æ¨¡æ‹Ÿé€€ç«ç­‰ç­–ç•¥ï¼Œè¿™äº›éƒ½<strong>ä¸æ˜¯</strong>ç®€å•çš„å›æº¯æˆ–æšä¸¾ã€‚</li><li><strong>è¿‘ä¼¼ç®—æ³•</strong>ï¼šè¿™äº›ç®—æ³•èƒ½åœ¨å¤šé¡¹å¼æ—¶é—´å†…è¿è¡Œï¼Œå¹¶ä¿è¯æ‰¾åˆ°çš„è§£ç¦»æœ€ä¼˜è§£ä¸ä¼šè¶…è¿‡æŸä¸ªç¡®å®šçš„å› å­ã€‚</li></ul></li></ul></li><li><p><strong>ç‰¹å®šç»“æ„å’Œä¼˜åŒ–ï¼š</strong> å¯¹äºæŸäº›å…·æœ‰ç‰¹å®šç»“æ„çš„NP-éš¾é—®é¢˜ï¼Œå¯èƒ½å­˜åœ¨æ¯”çº¯ç²¹çš„å›æº¯æˆ–æšä¸¾æ›´ä¼˜åŒ–çš„æŒ‡æ•°çº§ç®—æ³•ï¼Œä¾‹å¦‚åŠ¨æ€è§„åˆ’ (Dynamic Programming) åœ¨èƒŒåŒ…é—®é¢˜ç­‰é—®é¢˜ä¸­çš„åº”ç”¨ï¼Œè™½ç„¶ä»å¯èƒ½æ˜¯æŒ‡æ•°çº§ï¼Œä½†æ¯”çº¯æš´åŠ›æšä¸¾è¦å¥½ã€‚</p></li></ol><p><strong>æ€»ç»“ï¼š</strong></p><p>ä½ çš„è¯´æ³•â€œä¸€èˆ¬çš„NPé—®é¢˜éƒ½åªèƒ½ç”¨å›æº¯æˆ–è€…æšä¸¾â€æ›´å‡†ç¡®åœ°è¯´æ˜¯æŒ‡ï¼š<strong>å¯¹äºæˆ‘ä»¬ç›®å‰æ™®éè®¤ä¸ºæ— æ³•åœ¨å¤šé¡¹å¼æ—¶é—´å†…è§£å†³çš„NP-å®Œå…¨é—®é¢˜ï¼Œå¦‚æœè¿½æ±‚</strong>ç²¾ç¡®æœ€ä¼˜è§£**ï¼Œç›®å‰å·²çŸ¥çš„ç®—æ³•åœ¨æœ€åæƒ…å†µä¸‹éƒ½è¡¨ç°ä¸º<strong>æŒ‡æ•°æ—¶é—´å¤æ‚åº¦</strong>ï¼Œè€Œå›æº¯æ³•å’Œæšä¸¾æ³•æ˜¯å®ç°è¿™ç§æŒ‡æ•°çº§æœç´¢çš„å¸¸è§æ‰‹æ®µã€‚</p><p>ä½†åœ¨å®è·µä¸­ï¼Œä»¥åŠå¯¹äºæ‰€æœ‰NPé—®é¢˜çš„èŒƒç•´è€Œè¨€ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–é«˜æ•ˆçš„ç®—æ³•ï¼ˆå¯¹äºPé—®é¢˜ï¼‰ï¼Œä»¥åŠå„ç§å¯å‘å¼å’Œè¿‘ä¼¼ç®—æ³•ï¼ˆå¯¹äºNP-éš¾é—®é¢˜çš„â€œè¿‘ä¼¼â€è§£ï¼‰åœ¨ä½¿ç”¨ã€‚</p><hr><p><strong>User</strong></p><p>folkrnn
generate a folk tune with a recurrent neural network</p><p>Press to generate tune
Model
thesession.org (w/ :| |:)
Temperature
1
Seed</p><p>61649
Meter
4/4
Mode
C Major
Initial ABC
Enter start of tune in ABC notation
About Folk RNN
This website lets you generate music using an artificial intelligence called a â€œrecurrent neural networkâ€ (RNN). It&rsquo;s called â€œfolk-rnnâ€ because the RNN is trained on transcriptions of folk music. Each press of the â€˜composeâ€™ button will create a new tune, shaped by your initial input. For example, raising â€˜temperatureâ€™ will make the algorithm more adventurous. Or if a generated tune has a feature you like, you can copy that back into the â€˜Initial ABCâ€™ field and generate new tunes led by that feature.</p><p>Folk music is part of a rich cultural context that stretches back into the past, encompassing the real and the mythical, bound to the traditions of the culture in which it arises. Artificial intelligence, on the other hand, has no culture, no traditions. But it has shown great ability: beating grand masters at chess and Go, for example, or demonstrating uncanny wordplay skills when IBM Watson beat human competitors at Jeopardy. Could the power of AI be put to use to create music?
â€” â€˜Machine folkâ€™ music composed by AI shows technologyâ€™s creative side. The Conversation, March 2017
Why do this? As that article goes on to say, the original folk-rnn was developed, and its developers composed music using its successes and failures. This website aims to make that possible for everyone. Itâ€™s a tool anyone can use.</p><p>Demonstration</p><p>Frequently Asked Questions
How might I co-create with folk-rnn?
To get started, you might want to simply download a generated tune and import it into your composition app of choice. For each generated tune this site exports MIDI. The downloaded files have successfully been imported into e.g. Logic. It&rsquo;s worth noting that site is not, and never will be, a composition app where you can then hand-edit the tunes generated by folk-rnn. That&rsquo;s already well served elsewhere.</p><p>Explore the generation parameters. The â€˜aboutâ€™ section mentioned raising â€˜temperatureâ€™. 1.0 is normal, 2.0 is more wild, and 0.5 more cautious. It also mentioned copying back into the â€˜Initial ABCâ€™ field features in the generated tune you like; to make this easier clicking on notes in the staff notation will highlight the associated note in the generated ABC. Or, take some of your favourite tunes and set â€˜Initial ABCâ€™ with a snippet of ABC from there.</p><p>See these useful links:</p><p>Getting ABC - JC&rsquo;s ABC Tune Finder
Getting ABC - The Session, a community website dedicated to Irish traditional music
Transposing ABC - Mandolin Tab&rsquo;s ABC Converter
You can see a winning example of co-creation here, and more on The Machine Folk Session.</p><p>What is ABC Notation?
The transcriptions are in ABC format, which is a way of writing music with plain text. â€œIn basic form it uses the letters A through G to represent the given notes, with other elements used to place added value on these - sharp, flat, the length of the note, key, ornamentation.â€ â€“ more on wikipedia. We also transposed everything into the key of â€˜Câ€™ so folk-rnn learnt the patterns in the music rather than the differences in key.</p><p>For more on ABC itself:</p><p>Getting started with ABC
Understanding ABC
ABC format standard
What&rsquo;s the difference between the models?
The style of the generated music comes from the model chosen. Each model is the result of training the network on source material, in this case all of the tunes archived in thesession.org or all of the tunes in folkwiki.org. For tunes modelled on (mostly) celtic folk music, choose one of â€˜thesession.orgâ€™ models â€“ one variant has the repeat signs preserved (w/ :||:) and the other has the repeats unrolled (w/o :||:). For tunes modelled on swedish folk music, choose â€˜folkwiki.seâ€™.</p><p>Are there issues with playback on this site?
Sometimes, yes. The same goes for the staff notation. The open source library abcjs is used to render the tunes that folk-rnn generates, which includes the audio playback. Itâ€™s an amazing library, but is not always perfect. And sometimes this site asks the impossible, given folk-rnn doesn&rsquo;t always output entirely valid ABC. In these cases, try downloading the MIDI and playing back on your device of choice.</p><p>Credits
folk-rnn is a project funded by the UK Arts and Humanities Research Council, grant no. AH/R004706/1: &ldquo;Engaging three user communities with applications and outcomes of computational music creativity&rdquo;. The generated tunes and the patterns of use that generated them may be used for research purposes, such as this grant.</p><p>The original folk-rnn project page, where the algorithm and models were developed, is here: <a class=link href=https://github.com/IraKorshunova/folk-rnn target=_blank rel=noopener>https://github.com/IraKorshunova/folk-rnn</a>. It links to several compositions created by folk-rnn that have been performed live, analysed and so on.</p><p>Web application by Toby Harris. Please report any issues here.</p><p>ç”¨pytorchå†™ä¸€ä¸ª</p><hr><p><strong>Cursor</strong></p><p><code>folkrnn</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„é¡¹ç›®ï¼Œå®ƒåˆ©ç”¨å¾ªç¯ç¥ç»ç½‘ç»œ (RNN) æ¥ç”Ÿæˆæ°‘è°£æ›²è°ƒã€‚å¦‚æœä½ æƒ³ç”¨ PyTorch æ¥å®ç°ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªæ¶‰åŠæ•°æ®å¤„ç†ã€æ¨¡å‹æ„å»ºå’Œè®­ç»ƒã€ä»¥åŠæ–‡æœ¬ç”Ÿæˆï¼ˆè¿™é‡Œæ˜¯éŸ³ä¹çš„ABCè¡¨ç¤ºï¼‰çš„å¤æ‚ä»»åŠ¡ã€‚</p><p>æˆ‘æ— æ³•æä¾›ä¸€ä¸ªå®Œæ•´ä¸”å¯è¿è¡Œçš„ PyTorch ä»£ç ï¼Œå› ä¸ºè¿™éœ€è¦å¤„ç†å®Œæ•´çš„ABCéŸ³ä¹è§£æã€æ„å»ºå¤§è§„æ¨¡æ•°æ®é›†ã€ä»¥åŠå¤æ‚çš„è®­ç»ƒæµç¨‹ã€‚ç„¶è€Œï¼Œæˆ‘å¯ä»¥ä¸ºä½ å‹¾å‹’å‡ºä¸€ä¸ªç®€åŒ–çš„ PyTorch å®ç°çš„æ ¸å¿ƒæ€è·¯å’Œå…³é”®ç»„ä»¶ï¼Œè¿™èƒ½å¸®åŠ©ä½ ç†è§£å¦‚ä½•å¼€å§‹ã€‚</p><p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong></p><p>æˆ‘ä»¬å°†æŠŠABCéŸ³ä¹è¡¨ç¤ºçœ‹ä½œä¸€ä¸ªåºåˆ—ï¼Œç„¶åè®­ç»ƒä¸€ä¸ªRNNæ¨¡å‹ï¼Œè®©å®ƒå­¦ä¹ è¿™ä¸ªåºåˆ—çš„ç»Ÿè®¡è§„å¾‹ã€‚ç»™å®šä¸€ä¸ªèµ·å§‹ç‰‡æ®µï¼ˆæˆ–å®Œå…¨éšæœºï¼‰ï¼Œæ¨¡å‹å°±èƒ½é¢„æµ‹ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼ˆéŸ³ç¬¦ã€ç¬¦å·ç­‰ï¼‰ï¼Œä»è€Œé€æ­¥ç”Ÿæˆæ–°çš„æ›²è°ƒã€‚</p><p><strong>ä¸»è¦æ­¥éª¤ï¼š</strong></p><ol><li><p><strong>æ•°æ®å‡†å¤‡ (Data Preparation)</strong></p><ul><li>è·å–å¤§é‡çš„ABCæ ¼å¼çš„æ°‘è°£æ›²è°ƒæ•°æ®é›† (ä¾‹å¦‚ <code>thesession.org</code> çš„æ•°æ®)ã€‚</li><li><strong>è§£æABCæ–‡ä»¶ï¼š</strong> è¿™æ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚ä½ éœ€è¦ä¸€ä¸ªè§£æå™¨æ¥å¤„ç†ABCå­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢ä¸ºæ¨¡å‹å¯ä»¥ç†è§£çš„ç¦»æ•£â€œäº‹ä»¶â€åºåˆ—ã€‚ä¾‹å¦‚ï¼Œ<code>|</code> (å°èŠ‚çº¿), <code>C</code> (éŸ³ç¬¦C), <code>D</code> (éŸ³ç¬¦D), <code>,</code> (ä½å…«åº¦), <code>'</code> (é«˜å…«åº¦), <code>c2</code> (ä¸¤æ‹çš„C), <code>z</code> (ä¼‘æ­¢ç¬¦), <code>K:C</code> (Cå¤§è°ƒ), <code>M:4/4</code> (4/4æ‹) ç­‰éƒ½éœ€è¦è¢«è¯†åˆ«ã€‚</li><li><strong>æ„å»ºè¯æ±‡è¡¨ (Vocabulary):</strong> å°†æ‰€æœ‰è¿™äº›ç‹¬ç‰¹çš„â€œäº‹ä»¶â€æˆ–â€œtokenâ€æ˜ å°„åˆ°ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°IDã€‚</li><li><strong>åºåˆ—åŒ–ï¼š</strong> å°†æ¯ä¸ªæ›²è°ƒè½¬æ¢ä¸ºä¸€ä¸ªæ•´æ•°IDçš„åºåˆ—ã€‚</li><li><strong>æ‰¹å¤„ç†ï¼š</strong> åˆ›å»ºæ•°æ®åŠ è½½å™¨ï¼Œç”¨äºè®­ç»ƒæ—¶çš„æ‰¹å¤„ç†ã€‚</li></ul></li><li><p><strong>æ¨¡å‹æ„å»º (Model Architecture)</strong></p><ul><li>ä½¿ç”¨ PyTorch çš„ <code>nn.Module</code> å®šä¹‰ä¸€ä¸ªRNNæ¨¡å‹ã€‚</li><li>é€šå¸¸ä¼šåŒ…å«ï¼š<ul><li><code>nn.Embedding</code> å±‚ï¼šå°†è¾“å…¥çš„æ•´æ•°IDè½¬æ¢ä¸ºç¨ å¯†çš„å‘é‡è¡¨ç¤ºã€‚</li><li>ä¸€ä¸ªæˆ–å¤šä¸ª <code>nn.LSTM</code> æˆ– <code>nn.GRU</code> å±‚ï¼šè¿™æ˜¯æ ¸å¿ƒçš„åºåˆ—å¤„ç†å•å…ƒï¼Œå®ƒä»¬èƒ½å¤Ÿæ•æ‰åºåˆ—ä¸­çš„é•¿æœŸä¾èµ–å…³ç³»ã€‚</li><li><code>nn.Linear</code> å±‚ï¼šå°†RNNçš„è¾“å‡ºæ˜ å°„å›è¯æ±‡è¡¨çš„å¤§å°ï¼Œè¡¨ç¤ºæ¯ä¸ªtokençš„é¢„æµ‹æ¦‚ç‡ã€‚</li></ul></li></ul></li><li><p><strong>è®­ç»ƒ (Training)</strong></p><ul><li>å®šä¹‰æŸå¤±å‡½æ•° (ä¾‹å¦‚ <code>nn.CrossEntropyLoss</code>)ã€‚</li><li>å®šä¹‰ä¼˜åŒ–å™¨ (ä¾‹å¦‚ <code>torch.optim.Adam</code>)ã€‚</li><li>è¿­ä»£æ•°æ®é›†ï¼Œè¿›è¡Œå‰å‘ä¼ æ’­ã€è®¡ç®—æŸå¤±ã€åå‘ä¼ æ’­å’Œå‚æ•°æ›´æ–°ã€‚</li></ul></li><li><p><strong>ç”Ÿæˆ (Generation)</strong></p><ul><li>æ¨¡å‹è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥ç”Ÿæˆæ–°çš„æ›²è°ƒã€‚</li><li>ç»™å®šä¸€ä¸ªèµ·å§‹åºåˆ— (æˆ–ä¸€ä¸ªç‰¹æ®Šçš„ <code>BOS</code> (Begin Of Sequence) token)ã€‚</li><li>æ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokençš„æ¦‚ç‡åˆ†å¸ƒã€‚</li><li>æ ¹æ®è¿™äº›æ¦‚ç‡ï¼Œä½¿ç”¨<strong>é‡‡æ ·ç­–ç•¥</strong>ï¼ˆå¦‚å¤šé¡¹å¼é‡‡æ ·ï¼Œç”±â€œæ¸©åº¦â€å‚æ•°æ§åˆ¶ï¼‰é€‰æ‹©ä¸‹ä¸€ä¸ªtokenã€‚</li><li>å°†é€‰ä¸­çš„tokenæ·»åŠ åˆ°åºåˆ—ä¸­ï¼Œå¹¶é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°ç”Ÿæˆç‰¹å®šé•¿åº¦æˆ–é‡åˆ° <code>EOS</code> (End Of Sequence) tokenã€‚</li></ul></li></ol><p><strong>PyTorch ç®€åŒ–ä»£ç ç¤ºä¾‹ï¼š</strong></p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„æ¨¡å‹ç»“æ„å’Œç”Ÿæˆé€»è¾‘ï¼Œä¸åŒ…å«å¤æ‚çš„æ•°æ®è§£æéƒ¨åˆ†ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.nn</span> <span class=k>as</span> <span class=nn>nn</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.optim</span> <span class=k>as</span> <span class=nn>optim</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 1. æ¨¡æ‹Ÿæ•°æ®å‡†å¤‡ (å®é™…éœ€è¦å¤æ‚çš„ABCè§£æ) ---</span>
</span></span><span class=line><span class=cl><span class=c1># å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†è¯æ±‡è¡¨å’Œå°†ABCè½¬æ¢ä¸ºIDçš„æ˜ å°„</span>
</span></span><span class=line><span class=cl><span class=c1># è¿™æ˜¯ä¸€ä¸ªæç®€çš„ä¾‹å­ï¼Œå®é™…ABC tokenä¼šæ›´å¤š</span>
</span></span><span class=line><span class=cl><span class=n>vocab</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;&lt;UNK&gt;&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;&lt;EOS&gt;&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;A&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=s1>&#39;D&#39;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span> <span class=s1>&#39;E&#39;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;F&#39;</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span> <span class=s1>&#39;G&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;|&#39;</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=mi>13</span><span class=p>,</span> <span class=s1>&#39;e&#39;</span><span class=p>:</span> <span class=mi>14</span><span class=p>,</span> <span class=s1>&#39;f&#39;</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=s1>&#39;g&#39;</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span> <span class=c1># å°å†™éŸ³ç¬¦</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;C2&#39;</span><span class=p>:</span> <span class=mi>17</span><span class=p>,</span> <span class=s1>&#39;D2&#39;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=c1># å¸¦æœ‰æ‹å­çš„éŸ³ç¬¦</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... æ›´å¤šABCç¬¦å·å’ŒéŸ³ç¬¦</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>idx_to_token</span> <span class=o>=</span> <span class=p>{</span><span class=n>idx</span><span class=p>:</span> <span class=n>token</span> <span class=k>for</span> <span class=n>token</span><span class=p>,</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>vocab</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl><span class=n>vocab_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>vocab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¨¡æ‹Ÿä¸€äº›è®­ç»ƒæ•°æ® (å‡è®¾æ˜¯ABCåºåˆ—çš„IDè¡¨ç¤º)</span>
</span></span><span class=line><span class=cl><span class=c1># ä¾‹å¦‚ï¼š [&#39;&lt;BOS&gt;&#39;, &#39;M:4/4&#39;, &#39;K:C&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;|&#39;, &#39;F&#39;, &#39;G&#39;, &#39;A&#39;, &#39;|&#39;, &#39;&lt;EOS&gt;&#39;]</span>
</span></span><span class=line><span class=cl><span class=c1># ç®€åŒ–ä¸ºï¼š</span>
</span></span><span class=line><span class=cl><span class=n>train_sequences</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=c1># C D E | F G A | &lt;EOS&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=c1># A B C | D E F | &lt;EOS&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>13</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=c1># c d e | f g A | &lt;EOS&gt;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å°†åºåˆ—è½¬æ¢ä¸ºPyTorchå¼ é‡</span>
</span></span><span class=line><span class=cl><span class=c1># å¡«å……åˆ°æœ€å¤§é•¿åº¦ (è¿™é‡Œç®€åŒ–ï¼Œå®é™…éœ€è¦åŠ¨æ€å¡«å……)</span>
</span></span><span class=line><span class=cl><span class=n>max_seq_len</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>train_sequences</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>padded_sequences</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>seq</span> <span class=ow>in</span> <span class=n>train_sequences</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>padded_seq</span> <span class=o>=</span> <span class=n>seq</span> <span class=o>+</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>]]</span> <span class=o>*</span> <span class=p>(</span><span class=n>max_seq_len</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>seq</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>padded_sequences</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>padded_seq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>train_data</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>(</span><span class=n>padded_sequences</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 2. æ¨¡å‹æ„å»º ---</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FolkRNN</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>,</span> <span class=n>num_layers</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>dropout_prob</span><span class=o>=</span><span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>FolkRNN</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embedding</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¿™é‡Œä½¿ç”¨ LSTMï¼Œå› ä¸ºå®ƒåœ¨å¤„ç†é•¿åºåˆ—æ—¶è¡¨ç°è‰¯å¥½</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lstm</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>LSTM</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>,</span> <span class=n>num_layers</span><span class=p>,</span> <span class=n>batch_first</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>dropout</span><span class=o>=</span><span class=n>dropout_prob</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>hidden_dim</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>)</span> <span class=c1># çº¿æ€§å±‚å°†LSTMè¾“å‡ºæ˜ å°„åˆ°è¯æ±‡è¡¨å¤§å°</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_seq</span><span class=p>,</span> <span class=n>hidden_state</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># input_seq: (batch_size, seq_len)</span>
</span></span><span class=line><span class=cl>        <span class=n>embedded</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embedding</span><span class=p>(</span><span class=n>input_seq</span><span class=p>)</span> <span class=c1># embedded: (batch_size, seq_len, embedding_dim)</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=p>,</span> <span class=n>hidden_state</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>lstm</span><span class=p>(</span><span class=n>embedded</span><span class=p>,</span> <span class=n>hidden_state</span><span class=p>)</span> <span class=c1># output: (batch_size, seq_len, hidden_dim)</span>
</span></span><span class=line><span class=cl>        <span class=c1># å°† output reshape ä»¥ä¾¿å…¨è¿æ¥å±‚å¤„ç†</span>
</span></span><span class=line><span class=cl>        <span class=c1># output_flat = output.view(-1, output.size(-1)) # (batch_size * seq_len, hidden_dim)</span>
</span></span><span class=line><span class=cl>        <span class=c1># logits = self.fc(output_flat) # (batch_size * seq_len, vocab_size)</span>
</span></span><span class=line><span class=cl>        <span class=c1># return logits.view(input_seq.size(0), input_seq.size(1), vocab_size), hidden_state</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œé¢„æµ‹ï¼Œæˆ–è€…å¯¹æ‰€æœ‰æ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œé¢„æµ‹</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹äºè®­ç»ƒï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æ‰€æœ‰æ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œé¢„æµ‹ä¸‹ä¸€ä¸ªtoken</span>
</span></span><span class=line><span class=cl>        <span class=n>logits</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fc</span><span class=p>(</span><span class=n>output</span><span class=p>)</span> <span class=c1># (batch_size, seq_len, vocab_size)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logits</span><span class=p>,</span> <span class=n>hidden_state</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 3. è®­ç»ƒ (ç®€åŒ–) ---</span>
</span></span><span class=line><span class=cl><span class=n>embedding_dim</span> <span class=o>=</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>hidden_dim</span> <span class=o>=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=n>num_layers</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>learning_rate</span> <span class=o>=</span> <span class=mf>0.001</span>
</span></span><span class=line><span class=cl><span class=n>epochs</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>FolkRNN</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>,</span> <span class=n>num_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>criterion</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>CrossEntropyLoss</span><span class=p>(</span><span class=n>ignore_index</span><span class=o>=</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>])</span> <span class=c1># å¿½ç•¥å¡«å……ç¬¦çš„æŸå¤±</span>
</span></span><span class=line><span class=cl><span class=n>optimizer</span> <span class=o>=</span> <span class=n>optim</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>(),</span> <span class=n>lr</span><span class=o>=</span><span class=n>learning_rate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç®€å•çš„è®­ç»ƒå¾ªç¯</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;å¼€å§‹è®­ç»ƒ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>epochs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>total_loss</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>seq</span> <span class=ow>in</span> <span class=n>train_data</span><span class=p>:</span> <span class=c1># è¿™é‡Œçš„ train_data å‡è®¾å·²ç»æ˜¯ batch_size=1</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¾“å…¥æ˜¯é™¤äº†æœ€åä¸€ä¸ªtokençš„æ‰€æœ‰tokenï¼Œç›®æ ‡æ˜¯é™¤äº†ç¬¬ä¸€ä¸ªtokençš„æ‰€æœ‰token</span>
</span></span><span class=line><span class=cl>        <span class=c1># ä¾‹å¦‚ï¼Œinput = [BOS, C, D], target = [C, D, E]</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tensor</span> <span class=o>=</span> <span class=n>seq</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># æ·»åŠ  batch ç»´åº¦</span>
</span></span><span class=line><span class=cl>        <span class=n>target_tensor</span> <span class=o>=</span> <span class=n>seq</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># predictions: (batch_size, seq_len, vocab_size)</span>
</span></span><span class=line><span class=cl>        <span class=n>predictions</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>input_tensor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Reshape for CrossEntropyLoss: (N, C) and (N)</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>predictions</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>),</span> <span class=n>target_tensor</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>total_loss</span> <span class=o>+=</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Epoch </span><span class=si>{</span><span class=n>epoch</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>epochs</span><span class=si>}</span><span class=s2>, Loss: </span><span class=si>{</span><span class=n>total_loss</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_data</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;è®­ç»ƒå®Œæˆ.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 4. ç”Ÿæˆ (Generation) ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>initial_abc</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span> <span class=c1># è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># å‡†å¤‡åˆå§‹åºåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=c1># å®é™…ä¸­è¿™é‡Œéœ€è¦å°† initial_abc è§£æä¸ºIDåºåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>initial_abc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç®€å•å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„è§£æ</span>
</span></span><span class=line><span class=cl>        <span class=c1># å‡è®¾ initial_abc å·²ç»æ˜¯åƒ &#34;C D E |&#34; è¿™æ ·ç”¨ç©ºæ ¼åˆ†éš”çš„token</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;UNK&gt;&#39;</span><span class=p>])</span> <span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>initial_abc</span><span class=o>.</span><span class=n>split</span><span class=p>()</span> <span class=k>if</span> <span class=n>token</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>input_tokens</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>]]</span> <span class=o>+</span> <span class=n>input_tokens</span> <span class=c1># æ€»æ˜¯ä»¥BOSå¼€å§‹</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>]]</span> <span class=c1># ä»BOSå¼€å§‹</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>generated_tokens_idx</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>input_tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>hidden_state</span> <span class=o>=</span> <span class=kc>None</span> <span class=c1># åˆå§‹éšè—çŠ¶æ€</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_len</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_input</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>([</span><span class=n>generated_tokens_idx</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]])</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># å–æœ€åä¸€ä¸ªtokenä½œä¸ºè¾“å…¥</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># æ¨¡å‹è¾“å‡º (logits: (1, 1, vocab_size))</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span><span class=p>,</span> <span class=n>hidden_state</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>current_input</span><span class=p>,</span> <span class=n>hidden_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># ç§»é™¤å•ä¾‹ç»´åº¦å¹¶åº”ç”¨æ¸©åº¦</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span> <span class=o>=</span> <span class=n>logits</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=n>temperature</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒ</span>
</span></span><span class=line><span class=cl>            <span class=n>probabilities</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>logits</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># é‡‡æ ·ä¸‹ä¸€ä¸ªtoken</span>
</span></span><span class=line><span class=cl>            <span class=n>next_token_idx</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>multinomial</span><span class=p>(</span><span class=n>probabilities</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>generated_tokens_idx</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>next_token_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>next_token_idx</span> <span class=o>==</span> <span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;EOS&gt;&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># å°†IDåºåˆ—è½¬æ¢å›ABCå­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>    <span class=n>generated_abc_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>idx_to_token</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>generated_tokens_idx</span> <span class=k>if</span> <span class=n>idx</span> <span class=o>!=</span> <span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>generated_abc_tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç¤ºä¾‹ç”Ÿæˆ</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ç”Ÿæˆæ›²è°ƒ (æ¸©åº¦ 1.0, æ— åˆå§‹è¾“å…¥):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tune</span> <span class=o>=</span> <span class=n>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tune</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ç”Ÿæˆæ›²è°ƒ (æ¸©åº¦ 1.5, åˆå§‹è¾“å…¥ &#39;C D E |&#39;):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tune_wild</span> <span class=o>=</span> <span class=n>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>initial_abc</span><span class=o>=</span><span class=s2>&#34;C D E |&#34;</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>1.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tune_wild</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ç”Ÿæˆæ›²è°ƒ (æ¸©åº¦ 0.5, åˆå§‹è¾“å…¥ &#39;C D E |&#39;):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tune_cautious</span> <span class=o>=</span> <span class=n>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>initial_abc</span><span class=o>=</span><span class=s2>&#34;C D E |&#34;</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tune_cautious</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>ä»£ç è§£é‡Šå’ŒæœªåŒ…å«çš„éƒ¨åˆ†ï¼š</strong></p><ul><li><strong>æ•°æ®è§£æå¤æ‚æ€§ï¼š</strong> ä¸Šè¿°ä»£ç ä¸­çš„ <code>vocab</code> å’Œ <code>train_sequences</code> æ˜¯é«˜åº¦ç®€åŒ–çš„ã€‚å®é™…çš„ABCè§£æå™¨éœ€è¦èƒ½å¤Ÿå¤„ç†ï¼š<ul><li>ä¹è°±å…ƒæ•°æ® (å¦‚ <code>M:</code>, <code>K:</code>, <code>L:</code>)ã€‚</li><li>å„ç§éŸ³ç¬¦ç¬¦å· ( <code>A-G</code> ), å¤§å°å†™åŒºåˆ†å…«åº¦ï¼Œ<code>_</code> (é™), <code>^</code> (å‡), <code>=</code> (è¿˜åŸ)ã€‚</li><li>éŸ³ç¬¦é•¿åº¦ ( <code>A2</code>, <code>A/2</code> )ã€‚</li><li>ä¼‘æ­¢ç¬¦ ( <code>z</code> )ã€‚</li><li>å°èŠ‚çº¿ ( <code>|</code> ) å’Œé‡å¤æ ‡è®° ( <code>:|</code> <code>|:</code> )ã€‚</li><li>è¿éŸ³ç¬¦ã€è£…é¥°éŸ³ã€å’Œå¼¦ ( <code>[CEG]</code> )ã€‚</li><li>ä½ éœ€è¦å°†è¿™äº›å¤æ‚çš„ç¬¦å·å’Œç»“æ„æ˜ å°„æˆç¦»æ•£çš„tokenï¼Œè¿™é€šå¸¸éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–ç¼–å†™ä¸€ä¸ªä¸“é—¨çš„ABCè§£æåº“ã€‚</li></ul></li><li><strong>è®­ç»ƒæ•°æ®é›†ï¼š</strong> æˆ‘è¿™é‡Œåªæœ‰å‡ æ¡æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…è®­ç»ƒéœ€è¦æˆåƒä¸Šä¸‡æ¡æ°‘è°£æ›²è°ƒæ¥è®©æ¨¡å‹å­¦ä¹ åˆ°æœ‰æ„ä¹‰çš„æ¨¡å¼ã€‚</li><li><strong>Batching å’Œ Paddingï¼š</strong> å¯¹äºå˜é•¿åºåˆ—çš„æ‰¹å¤„ç†ï¼ŒPyTorch é€šå¸¸ä½¿ç”¨ <code>pad_sequence</code> å’Œ <code>pack_padded_sequence</code> æ¥æé«˜æ•ˆç‡å’Œæ­£ç¡®å¤„ç†å˜é•¿è¾“å…¥ã€‚</li><li><strong>æ¨¡å‹è¶…å‚æ•°è°ƒä¼˜ï¼š</strong> <code>embedding_dim</code>, <code>hidden_dim</code>, <code>num_layers</code>, <code>dropout_prob</code> ç­‰éƒ½éœ€è¦æ ¹æ®ä½ çš„æ•°æ®é›†å’Œæ€§èƒ½è¿›è¡Œè°ƒæ•´ã€‚</li><li><strong>GPU æ”¯æŒï¼š</strong> å¦‚æœä½ æœ‰GPUï¼Œéœ€è¦å°†æ¨¡å‹å’Œæ•°æ®ç§»åŠ¨åˆ°GPUä¸Š (<code>.to(device)</code>).</li><li><strong>é«˜çº§ç”Ÿæˆç­–ç•¥ï¼š</strong> é™¤äº†ç®€å•çš„å¤šé¡¹å¼é‡‡æ ·ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æŸæœç´¢ (Beam Search) ç­‰æ›´å¤æ‚çš„è§£ç ç­–ç•¥æ¥è·å¾—æ›´â€œåˆç†â€çš„ç”Ÿæˆç»“æœã€‚</li><li><strong>è¯„ä¼°æŒ‡æ ‡ï¼š</strong> éŸ³ä¹ç”Ÿæˆæ²¡æœ‰ç®€å•çš„è¯„ä¼°æŒ‡æ ‡ï¼Œé€šå¸¸æ˜¯ä¸»è§‚åˆ¤æ–­å…¶éŸ³ä¹æ€§ã€‚</li></ul><p>è¦æ„å»ºä¸€ä¸ªçœŸæ­£çš„ <code>folk-rnn</code>ï¼Œä½ éœ€è¦æŠ•å…¥å¤§é‡ç²¾åŠ›åœ¨æ•°æ®é¢„å¤„ç†ä¸Šï¼Œè¿™é€šå¸¸æ˜¯è¿™ç§æ–‡æœ¬ï¼ˆæˆ–ç¬¦å·ï¼‰ç”Ÿæˆä»»åŠ¡ä¸­æœ€ç¹çä½†å…³é”®çš„éƒ¨åˆ†ã€‚ä½ å¯ä»¥å¯»æ‰¾ç°æœ‰çš„ABCè§£æåº“ï¼Œæˆ–è€…å‚è€ƒ <code>folk-rnn</code> é¡¹ç›®çš„åŸå§‹å®ç° (å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶æ•°æ®å¤„ç†éƒ¨åˆ†)ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.nn</span> <span class=k>as</span> <span class=nn>nn</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.optim</span> <span class=k>as</span> <span class=nn>optim</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 1. æ¨¡æ‹Ÿæ•°æ®å‡†å¤‡ (å®é™…éœ€è¦å¤æ‚çš„ABCè§£æ) ---</span>
</span></span><span class=line><span class=cl><span class=c1># å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†è¯æ±‡è¡¨å’Œå°†ABCè½¬æ¢ä¸ºIDçš„æ˜ å°„</span>
</span></span><span class=line><span class=cl><span class=c1># è¿™æ˜¯ä¸€ä¸ªæç®€çš„ä¾‹å­ï¼Œå®é™…ABC tokenä¼šæ›´å¤š</span>
</span></span><span class=line><span class=cl><span class=n>vocab</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;&lt;UNK&gt;&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;&lt;EOS&gt;&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;A&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=s1>&#39;D&#39;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span> <span class=s1>&#39;E&#39;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;F&#39;</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span> <span class=s1>&#39;G&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;|&#39;</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=mi>13</span><span class=p>,</span> <span class=s1>&#39;e&#39;</span><span class=p>:</span> <span class=mi>14</span><span class=p>,</span> <span class=s1>&#39;f&#39;</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=s1>&#39;g&#39;</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span> <span class=c1># å°å†™éŸ³ç¬¦</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;C2&#39;</span><span class=p>:</span> <span class=mi>17</span><span class=p>,</span> <span class=s1>&#39;D2&#39;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=c1># å¸¦æœ‰æ‹å­çš„éŸ³ç¬¦</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... æ›´å¤šABCç¬¦å·å’ŒéŸ³ç¬¦</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>idx_to_token</span> <span class=o>=</span> <span class=p>{</span><span class=n>idx</span><span class=p>:</span> <span class=n>token</span> <span class=k>for</span> <span class=n>token</span><span class=p>,</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>vocab</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl><span class=n>vocab_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>vocab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¨¡æ‹Ÿä¸€äº›è®­ç»ƒæ•°æ® (å‡è®¾æ˜¯ABCåºåˆ—çš„IDè¡¨ç¤º)</span>
</span></span><span class=line><span class=cl><span class=c1># ä¾‹å¦‚ï¼š [&#39;&lt;BOS&gt;&#39;, &#39;M:4/4&#39;, &#39;K:C&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;|&#39;, &#39;F&#39;, &#39;G&#39;, &#39;A&#39;, &#39;|&#39;, &#39;&lt;EOS&gt;&#39;]</span>
</span></span><span class=line><span class=cl><span class=c1># ç®€åŒ–ä¸ºï¼š</span>
</span></span><span class=line><span class=cl><span class=n>train_sequences</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=c1># C D E | F G A | &lt;EOS&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=c1># A B C | D E F | &lt;EOS&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>13</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=c1># c d e | f g A | &lt;EOS&gt;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å°†åºåˆ—è½¬æ¢ä¸ºPyTorchå¼ é‡</span>
</span></span><span class=line><span class=cl><span class=c1># å¡«å……åˆ°æœ€å¤§é•¿åº¦ (è¿™é‡Œç®€åŒ–ï¼Œå®é™…éœ€è¦åŠ¨æ€å¡«å……)</span>
</span></span><span class=line><span class=cl><span class=n>max_seq_len</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>train_sequences</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>padded_sequences</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>seq</span> <span class=ow>in</span> <span class=n>train_sequences</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>padded_seq</span> <span class=o>=</span> <span class=n>seq</span> <span class=o>+</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>]]</span> <span class=o>*</span> <span class=p>(</span><span class=n>max_seq_len</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>seq</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>padded_sequences</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>padded_seq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>train_data</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>(</span><span class=n>padded_sequences</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 2. æ¨¡å‹æ„å»º ---</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FolkRNN</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>,</span> <span class=n>num_layers</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>dropout_prob</span><span class=o>=</span><span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>FolkRNN</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embedding</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¿™é‡Œä½¿ç”¨ LSTMï¼Œå› ä¸ºå®ƒåœ¨å¤„ç†é•¿åºåˆ—æ—¶è¡¨ç°è‰¯å¥½</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lstm</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>LSTM</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>,</span> <span class=n>num_layers</span><span class=p>,</span> <span class=n>batch_first</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>dropout</span><span class=o>=</span><span class=n>dropout_prob</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>hidden_dim</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>)</span> <span class=c1># çº¿æ€§å±‚å°†LSTMè¾“å‡ºæ˜ å°„åˆ°è¯æ±‡è¡¨å¤§å°</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_seq</span><span class=p>,</span> <span class=n>hidden_state</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># input_seq: (batch_size, seq_len)</span>
</span></span><span class=line><span class=cl>        <span class=n>embedded</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embedding</span><span class=p>(</span><span class=n>input_seq</span><span class=p>)</span> <span class=c1># embedded: (batch_size, seq_len, embedding_dim)</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=p>,</span> <span class=n>hidden_state</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>lstm</span><span class=p>(</span><span class=n>embedded</span><span class=p>,</span> <span class=n>hidden_state</span><span class=p>)</span> <span class=c1># output: (batch_size, seq_len, hidden_dim)</span>
</span></span><span class=line><span class=cl>        <span class=c1># å°† output reshape ä»¥ä¾¿å…¨è¿æ¥å±‚å¤„ç†</span>
</span></span><span class=line><span class=cl>        <span class=c1># output_flat = output.view(-1, output.size(-1)) # (batch_size * seq_len, hidden_dim)</span>
</span></span><span class=line><span class=cl>        <span class=c1># logits = self.fc(output_flat) # (batch_size * seq_len, vocab_size)</span>
</span></span><span class=line><span class=cl>        <span class=c1># return logits.view(input_seq.size(0), input_seq.size(1), vocab_size), hidden_state</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œé¢„æµ‹ï¼Œæˆ–è€…å¯¹æ‰€æœ‰æ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œé¢„æµ‹</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹äºè®­ç»ƒï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æ‰€æœ‰æ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œé¢„æµ‹ä¸‹ä¸€ä¸ªtoken</span>
</span></span><span class=line><span class=cl>        <span class=n>logits</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fc</span><span class=p>(</span><span class=n>output</span><span class=p>)</span> <span class=c1># (batch_size, seq_len, vocab_size)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logits</span><span class=p>,</span> <span class=n>hidden_state</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 3. è®­ç»ƒ (ç®€åŒ–) ---</span>
</span></span><span class=line><span class=cl><span class=n>embedding_dim</span> <span class=o>=</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>hidden_dim</span> <span class=o>=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=n>num_layers</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>learning_rate</span> <span class=o>=</span> <span class=mf>0.001</span>
</span></span><span class=line><span class=cl><span class=n>epochs</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>FolkRNN</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>,</span> <span class=n>num_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>criterion</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>CrossEntropyLoss</span><span class=p>(</span><span class=n>ignore_index</span><span class=o>=</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>])</span> <span class=c1># å¿½ç•¥å¡«å……ç¬¦çš„æŸå¤±</span>
</span></span><span class=line><span class=cl><span class=n>optimizer</span> <span class=o>=</span> <span class=n>optim</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>(),</span> <span class=n>lr</span><span class=o>=</span><span class=n>learning_rate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç®€å•çš„è®­ç»ƒå¾ªç¯</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;å¼€å§‹è®­ç»ƒ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>epochs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>total_loss</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>seq</span> <span class=ow>in</span> <span class=n>train_data</span><span class=p>:</span> <span class=c1># è¿™é‡Œçš„ train_data å‡è®¾å·²ç»æ˜¯ batch_size=1</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¾“å…¥æ˜¯é™¤äº†æœ€åä¸€ä¸ªtokençš„æ‰€æœ‰tokenï¼Œç›®æ ‡æ˜¯é™¤äº†ç¬¬ä¸€ä¸ªtokençš„æ‰€æœ‰token</span>
</span></span><span class=line><span class=cl>        <span class=c1># ä¾‹å¦‚ï¼Œinput = [BOS, C, D], target = [C, D, E]</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tensor</span> <span class=o>=</span> <span class=n>seq</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># æ·»åŠ  batch ç»´åº¦</span>
</span></span><span class=line><span class=cl>        <span class=n>target_tensor</span> <span class=o>=</span> <span class=n>seq</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># predictions: (batch_size, seq_len, vocab_size)</span>
</span></span><span class=line><span class=cl>        <span class=n>predictions</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>input_tensor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Reshape for CrossEntropyLoss: (N, C) and (N)</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>predictions</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>),</span> <span class=n>target_tensor</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>total_loss</span> <span class=o>+=</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Epoch </span><span class=si>{</span><span class=n>epoch</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>epochs</span><span class=si>}</span><span class=s2>, Loss: </span><span class=si>{</span><span class=n>total_loss</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_data</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;è®­ç»ƒå®Œæˆ.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 4. ç”Ÿæˆ (Generation) ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>initial_abc</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span> <span class=c1># è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># å‡†å¤‡åˆå§‹åºåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=c1># å®é™…ä¸­è¿™é‡Œéœ€è¦å°† initial_abc è§£æä¸ºIDåºåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>initial_abc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç®€å•å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„è§£æ</span>
</span></span><span class=line><span class=cl>        <span class=c1># å‡è®¾ initial_abc å·²ç»æ˜¯åƒ &#34;C D E |&#34; è¿™æ ·ç”¨ç©ºæ ¼åˆ†éš”çš„token</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;UNK&gt;&#39;</span><span class=p>])</span> <span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>initial_abc</span><span class=o>.</span><span class=n>split</span><span class=p>()</span> <span class=k>if</span> <span class=n>token</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>input_tokens</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>]]</span> <span class=o>+</span> <span class=n>input_tokens</span> <span class=c1># æ€»æ˜¯ä»¥BOSå¼€å§‹</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;BOS&gt;&#39;</span><span class=p>]]</span> <span class=c1># ä»BOSå¼€å§‹</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>generated_tokens_idx</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>input_tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>hidden_state</span> <span class=o>=</span> <span class=kc>None</span> <span class=c1># åˆå§‹éšè—çŠ¶æ€</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_len</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_input</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>([</span><span class=n>generated_tokens_idx</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]])</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># å–æœ€åä¸€ä¸ªtokenä½œä¸ºè¾“å…¥</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># æ¨¡å‹è¾“å‡º (logits: (1, 1, vocab_size))</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span><span class=p>,</span> <span class=n>hidden_state</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>current_input</span><span class=p>,</span> <span class=n>hidden_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># ç§»é™¤å•ä¾‹ç»´åº¦å¹¶åº”ç”¨æ¸©åº¦</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span> <span class=o>=</span> <span class=n>logits</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=n>temperature</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒ</span>
</span></span><span class=line><span class=cl>            <span class=n>probabilities</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>logits</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># é‡‡æ ·ä¸‹ä¸€ä¸ªtoken</span>
</span></span><span class=line><span class=cl>            <span class=n>next_token_idx</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>multinomial</span><span class=p>(</span><span class=n>probabilities</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>generated_tokens_idx</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>next_token_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>next_token_idx</span> <span class=o>==</span> <span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;EOS&gt;&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># å°†IDåºåˆ—è½¬æ¢å›ABCå­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>    <span class=n>generated_abc_tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>idx_to_token</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>generated_tokens_idx</span> <span class=k>if</span> <span class=n>idx</span> <span class=o>!=</span> <span class=n>vocab</span><span class=p>[</span><span class=s1>&#39;&lt;PAD&gt;&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>generated_abc_tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç¤ºä¾‹ç”Ÿæˆ</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ç”Ÿæˆæ›²è°ƒ (æ¸©åº¦ 1.0, æ— åˆå§‹è¾“å…¥):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tune</span> <span class=o>=</span> <span class=n>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tune</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ç”Ÿæˆæ›²è°ƒ (æ¸©åº¦ 1.5, åˆå§‹è¾“å…¥ &#39;C D E |&#39;):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tune_wild</span> <span class=o>=</span> <span class=n>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>initial_abc</span><span class=o>=</span><span class=s2>&#34;C D E |&#34;</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>1.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tune_wild</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ç”Ÿæˆæ›²è°ƒ (æ¸©åº¦ 0.5, åˆå§‹è¾“å…¥ &#39;C D E |&#39;):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tune_cautious</span> <span class=o>=</span> <span class=n>generate_tune</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>vocab</span><span class=p>,</span> <span class=n>idx_to_token</span><span class=p>,</span> <span class=n>initial_abc</span><span class=o>=</span><span class=s2>&#34;C D E |&#34;</span><span class=p>,</span> <span class=n>max_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tune_cautious</span><span class=p>)</span>
</span></span></code></pre></div><hr><p><strong>User</strong></p><p>To view keyboard shortcuts, press question mark
View keyboard shortcuts</p><p>Andrej Karpathy
9,582 posts</p><p>See new posts
Andrej Karpathy</p><p>@karpathy
Building
@EurekaLabsAI
. Previously Director of AI @ Tesla, founding team @ OpenAI, CS231n/PhD @ Stanford. I like to train large deep neural nets ğŸ§ ğŸ¤–ğŸ’¥
Stanfordkarpathy.aiJoined April 2009
983 Following
1.2M Followers
Followed by Abhishek, Ali Behrouz, and 141 others you follow
@megotannal, you arenâ€™t verified
yet</p><p>Get verified like @karpathy to stand out and get boosted reply reach.
Posts
Replies
Highlights
Articles
Media
Andrej Karpathyâ€™s posts
Andrej Karpathy
@karpathy
Â·
May 11
more context around the claude prompt
dbreunig.com
Claudeâ€™s System Prompt: Chatbots Are More Than Just Models
A couple days ago, Ãsgeir Thor Johnson convinced Claude to give up its system prompt. The prompt is a good reminder that chatbots are more than just their model. Theyâ€™re tools and instructions that&mldr;
Andrej Karpathy
@karpathy
Â·
May 6
A major mistake I made in my undergrad is that I focused way too much on mathematical lens of computing - computability, decidability, asymptotic complexity etc. And too little on physical lens - energy/heat of state change, data locality, parallelism, computer architecture. The
Show more
Andrej Karpathy
@karpathy
Â·
May 1
I attended a vibe coding hackathon recently and used the chance to build a web app (with auth, payments, deploy, etc.). I tinker but I am not a web dev by background, so besides the app, I was very interested in what it&rsquo;s like to vibe code a full web app today. As such, I wrote
Show more
Andrej Karpathy
@karpathy
Â·
May 1
&ldquo;Chatting&rdquo; with LLM feels like using an 80s computer terminal. The GUI hasn&rsquo;t been invented, yet but imo some properties of it can start to be predicted.</p><p>1 it will be visual (like GUIs of the past) because vision (pictures, charts, animations, not so much reading) is the 10-lane
Show more
Andrej Karpathy
@karpathy
Â·
Apr 30
There&rsquo;s a new paper circulating looking in detail at LMArena leaderboard: &ldquo;The Leaderboard Illusion&rdquo;
<a class=link href=https://arxiv.org/abs/2504.20879 target=_blank rel=noopener>https://arxiv.org/abs/2504.20879</a></p><p>I first became a bit suspicious when at one point a while back, a Gemini model scored #1 way above the second best, but when I tried to switch for a few
Show more
Quote
lmarena.ai
@lmarena_ai
Â·
Apr 30
Thanks for the authorsâ€™ feedback, weâ€™re always looking to improve the platform!</p><p>If a model does well on LMArena, it means that our community likes it! Yes, pre-release testing helps model providers identify which variant our community likes best. But this doesnâ€™t mean the x.com/arankomatsuzakâ€¦
Show more
Andrej Karpathy
@karpathy
Â·
Apr 25
Noticing myself adopting a certain rhythm in AI-assisted coding (i.e. code I actually and professionally care about, contrast to vibe code).</p><ol><li>Stuff everything relevant into context (this can take a while in big projects. If the project is small enough just stuff everything
Show more
Andrej Karpathy
@karpathy
Â·
Apr 25
I inherited &ldquo;AI assisted coding&rdquo; from this
@simonw
post:
<a class=link href=https://simonwillison.net/2025/Mar/19/vibe-coding/ target=_blank rel=noopener>https://simonwillison.net/2025/Mar/19/vibe-coding/</a></li></ol><p>But I think it needs work. It doesn&rsquo;t roll off the tongue.</p><p>Few days ago a friend asked me if I was vibe coding and I said no I&rsquo;m &ldquo;real coding&rdquo;. Possible candidate :D
simonwillison.net
Not all AI-assisted programming is vibe coding (but vibe coding rocks)
Vibe coding is having a moment. The term was coined by Andrej Karpathy just a few weeks ago (on February 6th) and has since been featured in the New York â€¦
Andrej Karpathy
@karpathy
Â·
Apr 22
PSA Itâ€™s a new era of ergonomics.
The primary audience of your thing (product, service, library, â€¦) is now an LLM, not a human.</p><p>LLMs donâ€™t like to navigate, they like to scrape.
LLMs donâ€™t like to see, they like to read.
LLMs donâ€™t like to click, they like to curl.</p><p>Etc etc.
Quote
Andrej Karpathy
@karpathy
Â·
Apr 22
Tired: elaborate docs pages for your product/service/library with fancy color palettes, branding, animations, transitions, dark mode, â€¦</p><p>Wired: one single docs .md file and a â€œcopy to clipboardâ€ button.
Andrej Karpathy
@karpathy
Â·
Apr 22
I was reading the docs of a service yesterday feeling like a neanderthal. The docs were asking me to go to a url and click top right and enter this and that and click submit and I was like what is this 2024?
Andrej Karpathy
@karpathy
Â·
Apr 22
Tired: elaborate docs pages for your product/service/library with fancy color palettes, branding, animations, transitions, dark mode, â€¦</p><p>Wired: one single docs .md file and a â€œcopy to clipboardâ€ button.
Andrej Karpathy
@karpathy
Â·
Apr 22
The docs also have to change in the content. Eg instead of instructing a person to go to some page and do this or that, they could show curl commands to run - actions that are a lot easier for an LLM to carry out.</p><p>Products have to change to support these too. Eg adding a
Show more
Andrej Karpathy reposted
Sander Dieleman
@sedielem
Â·
Apr 15
New blog post: let&rsquo;s talk about latents!
From sander.ai
Andrej Karpathy
@karpathy
Â·
Apr 8
Tweet of appreciation to White Lotus Season 3 which wrapped up yesterday. Consistently strong since Season 1 on all of cinematography, music, screenplay, casting and acting. Dread building. Meme minting. Cringe inducing. Always a lot to find, analyze and have fun with â¤ï¸
Andrej Karpathy
@karpathy
Â·
Apr 8
Power to the people: How LLMs flip the script on technology diffusion
Transformative technologies usually follow a top-down diffusion path: originating in government or military contexts, passing through corporations, and eventually reaching individuals - think&mldr;
You might like
OpenAI
@OpenAI
Sander Dieleman
@sedielem
Fei-Fei Li
@drfeifei
Show more
Trending now
Whatâ€™s happening
Phillies at Marlins
20 minutes ago
Sports Â· Trending
#NBAFinals2025
1,309 posts
Sports Â· Trending
Hope Liv
1,339 posts
Trending in United States
Dislocated
2,449 posts
Politics Â· Trending
NO WAR
152K posts
Show more
Terms of Service
|
Privacy Policy
|
Cookie Policy
|
Accessibility
|
Ads info
|</p><p>More
Â© 2025 X Corp.</p><p>æœ€è¿‘å‘ç”Ÿäº†ä»€ä¹ˆï¼Œè®¨è®ºä»€ä¹ˆ</p><hr><p><strong>Cursor</strong></p><p>æ ¹æ®ä½ æä¾›çš„Andre_Karpathyçš„æ¨æ–‡å†…å®¹ï¼Œæœ€è¿‘ä»–ä¸»è¦åœ¨è®¨è®ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li><p><strong>å¤§å‹è¯­è¨€æ¨¡å‹ (LLMs) çš„ç³»ç»Ÿæç¤ºå’Œå…¶æœ¬è´¨ï¼š</strong></p><ul><li>ä»–åˆ†äº«äº†å…³äº Claude æ¨¡å‹ç³»ç»Ÿæç¤ºçš„èƒŒæ™¯ä¿¡æ¯ï¼Œå¹¶å¼ºè°ƒèŠå¤©æœºå™¨äººä¸ä»…ä»…æ˜¯æ¨¡å‹æœ¬èº«ï¼Œæ›´æ˜¯å·¥å…·å’ŒæŒ‡ä»¤çš„ç»“åˆã€‚</li></ul></li><li><p><strong>LLM çš„æœªæ¥äº¤äº’ç•Œé¢ï¼š</strong></p><ul><li>ä»–è®¤ä¸ºç›®å‰ä¸LLMçš„â€œèŠå¤©â€æ„Ÿè§‰å°±åƒä½¿ç”¨80å¹´ä»£çš„è®¡ç®—æœºç»ˆç«¯ï¼Œå¹¶é¢„æµ‹æœªæ¥çš„LLMç•Œé¢å°†ä¼šæ˜¯<strong>è§†è§‰åŒ–çš„ (visual)</strong>ï¼Œå› ä¸ºè§†è§‰ï¼ˆå›¾ç‰‡ã€å›¾è¡¨ã€åŠ¨ç”»ï¼‰æ˜¯æ›´é«˜æ•ˆçš„äº¤æµæ–¹å¼ï¼Œå°±åƒè¿‡å»ä»å‘½ä»¤è¡Œåˆ°å›¾å½¢ç”¨æˆ·ç•Œé¢çš„è½¬å˜ã€‚</li></ul></li><li><p><strong>AI è¾…åŠ©ç¼–ç¨‹çš„å®è·µä¸åæ€ï¼š</strong></p><ul><li>ä»–è®¨è®ºäº†è‡ªå·±åœ¨ä½¿ç”¨AIè¾…åŠ©ç¼–ç¨‹ï¼ˆä»–ç§°ä¹‹ä¸ºâ€œreal codingâ€ï¼Œè€Œéâ€œvibe codingâ€ï¼‰æ—¶çš„èŠ‚å¥å’Œå·¥ä½œæµï¼Œä¾‹å¦‚å¦‚ä½•å°†æ‰€æœ‰ç›¸å…³å†…å®¹å¡«å……åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚</li><li>ä»–è¿˜æåˆ°äº†â€œAIè¾…åŠ©ç¼–ç¨‹â€è¿™ä¸ªæœ¯è¯­çš„æ¥æºï¼Œå¹¶è®¤ä¸ºå®ƒéœ€è¦æ”¹è¿›ã€‚</li></ul></li><li><p><strong>LLM å¯¹äº§å“è®¾è®¡å’Œæ–‡æ¡£ç¼–å†™çš„é¢ è¦†æ€§å½±å“ï¼š</strong></p><ul><li>ä»–æå‡ºäº†ä¸€ä¸ªéå¸¸é‡è¦çš„è§‚ç‚¹ï¼šç°åœ¨ä½ çš„äº§å“ã€æœåŠ¡æˆ–åº“çš„<strong>ä¸»è¦å—ä¼—æ˜¯LLMï¼Œè€Œä¸æ˜¯äººç±»</strong>ã€‚</li><li>å› æ­¤ï¼ŒLLMå–œæ¬¢<strong>æŠ“å– (scrape)</strong> è€Œä¸æ˜¯å¯¼èˆªï¼Œå–œæ¬¢<strong>é˜…è¯» (read)</strong> è€Œä¸æ˜¯æŸ¥çœ‹ï¼Œå–œæ¬¢<strong>curlå‘½ä»¤</strong>è€Œä¸æ˜¯ç‚¹å‡»ã€‚</li><li>ä»–å»ºè®®æ–‡æ¡£åº”è¯¥ä»å¤æ‚çš„é¡µé¢è½¬å˜ä¸ºå•ä¸ª<code>.md</code>æ–‡ä»¶å’Œâ€œå¤åˆ¶åˆ°å‰ªè´´æ¿â€æŒ‰é’®ï¼Œå†…å®¹ä¹Ÿåº”ç›´æ¥æä¾›<code>curl</code>å‘½ä»¤ç­‰ï¼Œä»¥ä¾¿LLMæ›´å®¹æ˜“ç†è§£å’Œæ‰§è¡Œæ“ä½œã€‚</li></ul></li><li><p><strong>å¯¹ LLM æ’è¡Œæ¦œçš„è´¨ç–‘ï¼š</strong></p><ul><li>ä»–åˆ†äº«äº†ä¸€ç¯‡å…³äºLMArenaæ’è¡Œæ¦œçš„è®ºæ–‡â€œThe Leaderboard Illusionâ€ï¼Œè¡¨è¾¾äº†å¯¹è¿™äº›æ’è¡Œæ¦œå‡†ç¡®æ€§çš„æ€€ç–‘ï¼Œè®¤ä¸ºå®ƒä»¬å¯èƒ½å­˜åœ¨â€œå¹»è§‰â€ï¼Œæ— æ³•å®Œå…¨åæ˜ æ¨¡å‹çš„çœŸå®è¡¨ç°ã€‚</li></ul></li><li><p><strong>æŠ€æœ¯æ‰©æ•£æ¨¡å¼çš„è½¬å˜ï¼š</strong></p><ul><li>ä»–æ’°å†™äº†ä¸€ç¯‡å…³äºâ€œLLMså¦‚ä½•é¢ è¦†æŠ€æœ¯æ‰©æ•£æ¨¡å¼â€çš„æ–‡ç« ï¼ŒæŒ‡å‡ºå˜é©æ€§æŠ€æœ¯é€šå¸¸éµå¾ªè‡ªä¸Šè€Œä¸‹çš„è·¯å¾„ï¼ˆæ”¿åºœ/å†›äº‹ -> ä¼ä¸š -> ä¸ªäººï¼‰ï¼Œè€ŒLLMsåˆ™å¯èƒ½ä¿ƒæˆè‡ªä¸‹è€Œä¸Šï¼ˆèµ‹èƒ½ä¸ªä½“ï¼‰çš„æ‰©æ•£ã€‚</li></ul></li><li><p><strong>ä¸ªäººå­¦ä¹ ä¸è®¡ç®—æœºç§‘å­¦çš„åæ€ï¼š</strong></p><ul><li>ä»–å›é¡¾äº†è‡ªå·±æœ¬ç§‘æ—¶çš„ä¸€ä¸ªé‡å¤§å¤±è¯¯ï¼Œå³è¿‡äºå…³æ³¨è®¡ç®—çš„æ•°å­¦ç†è®ºï¼ˆå¯è®¡ç®—æ€§ã€å¯åˆ¤å®šæ€§ã€æ¸è¿‘å¤æ‚åº¦ç­‰ï¼‰ï¼Œè€Œå¿½è§†äº†è®¡ç®—çš„<strong>ç‰©ç†å±‚é¢</strong>ï¼ˆçŠ¶æ€å˜åŒ–çš„èƒ½é‡/çƒ­é‡ã€æ•°æ®å±€éƒ¨æ€§ã€å¹¶è¡Œæ€§ã€è®¡ç®—æœºæ¶æ„ï¼‰ã€‚</li></ul></li><li><p><strong>å…¶ä»–ï¼ˆå¶å°”ï¼‰ï¼š</strong></p><ul><li>ä»–ä¹Ÿåˆ†äº«äº†ä¸€äº›éæŠ€æœ¯å†…å®¹ï¼Œä¾‹å¦‚å¯¹ã€Šç™½è²èŠ±åº¦å‡æ‘ã€‹ç¬¬ä¸‰å­£çš„å–œçˆ±ã€‚</li></ul></li></ol><p>æ€»çš„æ¥è¯´ï¼ŒAndrej Karpathy æœ€è¿‘çš„è®¨è®ºéå¸¸èšç„¦äº <strong>LLM çš„å®é™…åº”ç”¨ã€å®ƒä»¬å¯¹å¼€å‘æµç¨‹å’Œäº§å“è®¾è®¡çš„æ·±è¿œå½±å“ï¼Œä»¥åŠå¯¹AIé¢†åŸŸæŸäº›æµè¡Œè§‚å¿µï¼ˆå¦‚æ’è¡Œæ¦œï¼‰çš„æ‰¹åˆ¤æ€§æ€è€ƒ</strong>ã€‚</p><hr><p><strong>User</strong></p><p>To view keyboard shortcuts, press question mark
View keyboard shortcuts</p><p>Theo - t3.gg
51.5K posts</p><p>See new posts
Theo - t3.gg</p><p>@theo
Full time CEO
@t3dotchat
. Part time YouTuber, investor, and developer
San Francisco, CAt3.ggJoined October 2016
3,447 Following
223.4K Followers
Followed by Fernando Rojo, Lukas MÃ¶ller, and 45 others you follow
@megotannal, you arenâ€™t verified
yet</p><p>Get verified like @theo to stand out and get boosted reply reach.
Posts
Replies
Subs
Highlights
Media
Theo - t3.ggâ€™s posts
Theo - t3.gg
@theo
Â·
Jun 8
ANNOUNCING THE FIRST EVER CLONEATHON</p><p>Build an open source clone of T3 Chat, win up to $5,000</p><p>Deadline is next Wednesday. Good luck and have fun nerds ğŸ«¡
Show more replies
Theo - t3.gg
@theo
Â·
Jun 9
Clarifications
Quote
Theo - t3.gg
@theo
Â·
Jun 9
Got a handful of questions about requirements, just updated the section on the site to clarify! x.com/theo/status/19â€¦
Theo - t3.gg
@theo
Â·
Jun 16
Quote
Theo - t3.gg
@theo
Â·
Jun 16
Finally added the registration and submission portal for the T3 Chat cloneathon! I added one additional day for y&rsquo;all to polish things up and get them submitted.</p><p>Good luck to everyone participating!!! x.com/theo/status/19â€¦
Theo - t3.gg
@theo
Â·
Jun 16
Okay, Claude Code is pretty good
Theo - t3.gg
@theo
Â·
Jun 16
Switch 2 review:</p><ul><li>Too big</li><li>Zelda in 60fps is cool</li><li>Pro controller is awesome</li><li>WiFi is shit for some reason</li><li>Needs way more games</li></ul><p>Iâ€™d recommend waiting a few months. I still use my Steam Deck more ğŸ’€
Theo - t3.gg
@theo
Â·
Jun 16
More on the &ldquo;too big&rdquo; bit:</p><p>Switch 1 was really, really flat. Made the ergonomics suck. Since it was super small and light you could mostly deal with it. I still relied on my Satisfye grip (pictured)</p><p>Switch 2 is just as flat, but way bigger and heavier, so it legit sucks to
Show more
Theo - t3.gg
@theo
Â·
Jun 15
Just read a â€œsenior engineerâ€ thread about rate limiting that I immensely regret reading. Cost at least 5 IQ points.
Theo - t3.gg
@theo
Â·
Jun 15
Please donâ€™t rate limit based on IP alone - there are so many reasons why this is a terrible idea. God forbid a few users from the same college try your website
Theo - t3.gg
@theo
Â·
Jun 15
Imagine how much cooler this would be if she did it in Rust instead of Javascript
Quote
banteg
@bantg
Â·
Jun 15
guys?</p><p>You might like
Drizzle ORM
@DrizzleORM
ThePrimeagen</p><p>@ThePrimeagen
Guillermo Rauch</p><p>@rauchg
Show more
Trending now
Whatâ€™s happening
Angels at Yankees
7 minutes ago
Sports Â· Trending
Hartenstein
1,309 posts
Trending in California
Juneteenth
9,464 posts
Politics Â· Trending
Only Congress
10K posts
Politics Â· Trending
Nukes
98.5K posts
Show more
Terms of Service
|
Privacy Policy
|
Cookie Policy
|
Accessibility
|
Ads info
|</p><p>More
Â© 2025 X Corp.</p><p>çœ‹çœ‹è¿™ä¸ªï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>æ ¹æ®ä½ æä¾›çš„ Theo - t3.gg çš„æ¨æ–‡å†…å®¹ï¼Œä»–æœ€è¿‘ä¸»è¦åœ¨è®¨è®ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li><p><strong>T3 Chat Cloneathon æ´»åŠ¨ï¼š</strong></p><ul><li>ä»–å‘èµ·äº†ä¸€é¡¹åä¸ºâ€œCloneathonâ€çš„æ´»åŠ¨ï¼Œé¼“åŠ±å¼€å‘è€…æ„å»º <strong>T3 Chat çš„å¼€æºå…‹éš†ç‰ˆæœ¬</strong>ï¼Œå¹¶æä¾›æœ€é«˜5000ç¾å…ƒçš„å¥–é‡‘ã€‚</li><li>ä»–æŒç»­æ›´æ–°äº†æ´»åŠ¨çš„è¿›å±•ï¼ŒåŒ…æ‹¬æ¾„æ¸…è¦æ±‚å’Œå¼€æ”¾æ³¨å†Œä¸æäº¤å…¥å£ã€‚</li></ul></li><li><p><strong>å¯¹ Claude Code (AI ç¼–ç¨‹åŠ©æ‰‹) çš„è¯„ä»·ï¼š</strong></p><ul><li>ä»–ç®€çŸ­åœ°è¯„è®ºè¯´ï¼šâ€œOkay, Claude Code is pretty goodâ€ï¼Œè¡¨ç¤ºå¯¹Claude AIåœ¨ä»£ç ç”Ÿæˆæ–¹é¢çš„è®¤å¯ã€‚</li></ul></li><li><p><strong>å¯¹ Nintendo Switch 2 (æˆ–ç§° Switch æ–°ç‰ˆæœ¬) çš„è¯„ä»·ï¼š</strong></p><ul><li>ä»–åˆ†äº«äº†è‡ªå·±å¯¹ Switch 2 çš„åˆæ­¥â€œæµ‹è¯„â€ï¼Œä¸»è¦æåˆ°ï¼š<strong>å°ºå¯¸å¤ªå¤§</strong>ã€<strong>Zeldaåœ¨60fpsä¸‹å¾ˆé…·</strong>ã€<strong>Proæ‰‹æŸ„å¾ˆæ£’</strong>ã€<strong>WiFiä¿¡å·å·®</strong>ï¼Œä»¥åŠ<strong>æ¸¸æˆæ•°é‡ä¸è¶³</strong>ã€‚</li><li>ä»–å»ºè®®å¤§å®¶å†ç­‰å‡ ä¸ªæœˆè´­ä¹°ï¼Œå¹¶è¡¨ç¤ºè‡ªå·±ä»ç„¶æ›´å¸¸ç”¨ Steam Deckã€‚</li><li>ä»–è¿˜è¿›ä¸€æ­¥è§£é‡Šäº†â€œå¤ªå¤§â€çš„é—®é¢˜ï¼Œè®¤ä¸ºSwitch 2å’ŒSwitch 1ä¸€æ ·æ‰å¹³ï¼Œä½†æ›´å¤§æ›´é‡ï¼Œå¯¼è‡´äººä½“å·¥å­¦ä½“éªŒå¾ˆå·®ã€‚</li></ul></li><li><p><strong>å…³äºåç«¯å¼€å‘å’Œé™æµ (Rate Limiting) çš„å»ºè®®ï¼š</strong></p><ul><li>ä»–éå¸¸å¼ºçƒˆåœ°æ‰¹è¯„äº†ä»…åŸºäº <strong>IP åœ°å€è¿›è¡Œé™æµ</strong>çš„åšæ³•ï¼Œè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„ä¸»æ„ï¼Œä¼šç»™æ¥è‡ªåŒä¸€ç½‘ç»œï¼ˆå¦‚å¤§å­¦ï¼‰çš„ç”¨æˆ·å¸¦æ¥é—®é¢˜ã€‚ä»–è¡¨ç¤ºè¯»åˆ°ç›¸å…³å†…å®¹è®©ä»–â€œæ™ºå•†é™ä½äº†è‡³å°‘5ç‚¹â€ã€‚</li></ul></li><li><p><strong>å¯¹ç¼–ç¨‹è¯­è¨€çš„åå¥½ï¼ˆRust vs. JavaScriptï¼‰ï¼š</strong></p><ul><li>åœ¨çœ‹åˆ°ä¸€æ®µä»£ç åï¼Œä»–è¡¨è¾¾äº†å¸Œæœ›çœ‹åˆ°å®ƒç”¨ <strong>Rust è€Œä¸æ˜¯ JavaScript</strong> å®ç°çš„æƒ³æ³•ï¼Œæš—ç¤ºä»–å€¾å‘äºRustã€‚</li></ul></li></ol><p>æ€»çš„æ¥è¯´ï¼ŒTheo æœ€è¿‘çš„æ¨æ–‡æ¶µç›–äº† <strong>ç¤¾åŒºæ´»åŠ¨ã€å¯¹æ–°ç¡¬ä»¶å’ŒAIå·¥å…·çš„çœ‹æ³•ã€ä»¥åŠå…³äºåç«¯æ¶æ„ï¼ˆç‰¹åˆ«æ˜¯é™æµï¼‰å’Œç¼–ç¨‹è¯­è¨€é€‰æ‹©çš„ä¸“ä¸šå»ºè®®</strong>ã€‚</p><hr><p><strong>User</strong></p><p>è¿™é‡Œåœ¨è®¨è®ºä»€ä¹ˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>è¿™é‡Œè®¨è®ºçš„æ˜¯å…³äº <strong>ç¤¾ä¼šä¿éšœæ¬ºè¯ˆ (Social Security fraud) çš„ä¸€ä¸ªä¸å‡†ç¡®ç»Ÿè®¡æ•°æ®æ˜¯å¦‚ä½•è¢«æé€ å’Œä¼ æ’­çš„</strong>ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œæ–‡ç« è¯¦ç»†è®°å½•äº†ä»¥ä¸‹äº‹ä»¶ï¼š</p><ul><li><strong>èµ·æºï¼ˆ3æœˆ12æ—¥ï¼‰ï¼š</strong> æœ€åˆçš„æŠ¥å‘ŠæŒ‡å‡ºâ€œå¤§çº¦40%çš„ç¤¾ä¼šä¿éšœç›´æ¥å­˜æ¬¾æ¬ºè¯ˆä¸æŸäººæ‰“ç”µè¯ç»™SSAæ›´æ”¹ç›´æ¥å­˜æ¬¾é“¶è¡Œä¿¡æ¯æœ‰å…³â€ã€‚DOGEçš„Xè´¦æˆ·åˆ†äº«äº†è¿™ä¸ªç»Ÿè®¡æ•°æ®ï¼ŒåŸƒéš†Â·é©¬æ–¯å…‹ï¼ˆElon Muskï¼‰ä¹Ÿå¼•ç”¨å¹¶è®¤åŒäº†ã€‚</li><li><strong>æ­ªæ›²å’Œå¤¸å¤§ï¼ˆ3æœˆ27æ—¥ï¼‰ï¼š</strong> DOGEçš„ä¸€ä½å·¥ç¨‹å¸ˆåœ¨é‡‡è®¿ä¸­â€œä¼¼ä¹æ­ªæ›²â€äº†è¿™ä¸€æ•°æ®ï¼Œå£°ç§°ä»–ä»¬æ¥åˆ°çš„ç”µè¯ä¸­â€œæœ‰40%æ¥è‡ªæ¬ºè¯ˆè€…â€ã€‚å³ç¿¼å½±å“è€…è¿›ä¸€æ­¥å¤¸å¤§ï¼Œé©¬æ–¯å…‹ä¹Ÿå›åº”å¹¶â€œæ”¾å¤§äº†è¿™ä¸ªè™šå‡å£°æ˜â€ã€‚</li><li><strong>é‡å¤ä¼ æ’­ï¼ˆ3æœˆ30æ—¥ - 4æœˆ3æ—¥ï¼‰ï¼š</strong> é©¬æ–¯å…‹åœ¨ç«é€‰æ´»åŠ¨ä¸­é‡å¤äº†è¿™ä¸€è™šå‡å£°æ˜ã€‚å°½ç®¡æœºæ„å·¥ä½œäººå‘˜èµ·è‰äº†å£°æ˜è¯•å›¾çº æ­£ï¼ˆæŒ‡å‡ºå®é™…æ¬ºè¯ˆæŒ‡æ§çš„æ¯”ä¾‹ä¸º25%-30%ï¼‰ï¼Œä½†ä¸€ä½ç™½å®«åŠ©æ‰‹å´é˜»æ­¢äº†è¿™ä»½å£°æ˜çš„å‘å¸ƒï¼Œå¹¶åšæŒâ€œæ•°å­—å°±æ˜¯40%â€ã€‚æœ€ç»ˆï¼Œå‰¯æ€»ç»ŸJD Vanceä¹Ÿåœ¨é‡‡è®¿ä¸­é‡å¤äº†è¿™ä¸ªè™šå‡å£°æ˜ã€‚</li></ul><p><strong>æ ¸å¿ƒé—®é¢˜åœ¨äºï¼š</strong> ä¸€ä¸ªå…³äºâ€œ<strong>ç›´æ¥å­˜æ¬¾æ¬ºè¯ˆä¸­ä¸ç”µè¯ç›¸å…³çš„æ¯”ä¾‹</strong>â€çš„ç»Ÿè®¡æ•°æ®ï¼Œè¢«æ‰­æ›²å¹¶å¤¸å¤§ä¸ºâ€œ<strong>æ‰“ç»™ç¤¾ä¼šä¿éšœå±€çš„ç”µè¯ä¸­æœ‰40%æ˜¯æ¬ºè¯ˆ</strong>â€æˆ–â€œ<strong>40%çš„æ‰“ç”µè¯çš„äººéƒ½æ˜¯åœ¨å®æ–½æ¬ºè¯ˆ</strong>â€ï¼Œå¹¶è¢«æœ‰å½±å“åŠ›çš„äººç‰©å¹¿æ³›ä¼ æ’­ï¼Œå°½ç®¡æœ‰å†…éƒ¨å°è¯•è¿›è¡Œçº æ­£ï¼Œä½†æœ€ç»ˆè¢«é˜»æ­¢ã€‚</p><hr><p><strong>User</strong></p><p>To view keyboard shortcuts, press question mark
View keyboard shortcuts</p><p>Post</p><p>See new posts
Conversation
Evan You
@youyuxi
I can understand why Bun does it, but these attempts of nudging users away from Vite and Vitest ignores the fact that Bun&rsquo;s corresponding features are not fully equivalent replacements.</p><p>Vite & Vitest gives you:</p><ul><li>Better non-React framework support</li><li>Better production bundle quality (treeshaking, minification, chunk split control)</li><li>More abundance of ecosystem plugins</li><li>(vitest) Better test correctness (global state isolation by default)</li><li>(vitest) Browser mode so you can run your component tests in actual browsers</li><li>(vitest) IDE integrations, benchmarking, type testing, sharding&mldr;</li></ul><p>Bun is great, but make sure you understand the trade-offs of these choices! In many cases, you probably <em>should</em> use Vite and Vitest alongside Bun.
Quote
Jarred Sumner</p><p>@jarredsumner
Â·
4h
In the next version of Bun</p><p><code>bun init</code> detects if claude code is installed and adds a &ldquo;<a class=link href=http://CLAUDE.md target=_blank rel=noopener>http://CLAUDE.md</a>&rdquo; to tell claude to use bun</p><p>4:48 PM Â· Jun 17, 2025
Â·
787
Views</p><p>Relevant people
Evan You
@youyuxi
Husband / Father of two / Founder
@voidzerodev
/ Creator
@vuejs
&
@vite_js
. Chinese-only alt:
@yuxiyou
Jarred Sumner</p><p>@jarredsumner
building
@bunjavascript
. formerly:
@stripe
(twice)
@thielfellowship
. high school dropout. npm i -g bun
Trending now
Whatâ€™s happening
Cannes Lions 2025
LIVE
Business and finance Â· Trending
$PLTR
14.2K posts
Trending
Opus
7,627 posts
Politics Â· Trending
Pakistani
207K posts
Show more
Terms of Service
|
Privacy Policy
|
Cookie Policy
|
Accessibility
|
Ads info
|</p><p>More
Â© 2025 X Corp.</p><p>è¿™é‡Œåœ¨è®¨è®ºä»€ä¹ˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>è¿™é‡Œæ­£åœ¨è®¨è®º <strong>JavaScript ç”Ÿæ€ç³»ç»Ÿä¸­çš„å·¥å…·é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯ <code>Bun</code> ä¸ <code>Vite</code> å’Œ <code>Vitest</code> ä¹‹é—´çš„ç«äº‰å’Œå…¼å®¹æ€§</strong>ã€‚</p><p><strong>è®¨è®ºçš„æ ¸å¿ƒç‚¹æ˜¯ï¼š</strong></p><ol><li><p><strong>Jarred Sumner (Bun çš„åˆ›å»ºè€…) çš„ç­–ç•¥ï¼š</strong></p><ul><li>ä»–å®£å¸ƒ <code>Bun</code> çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬å°†é€šè¿‡ <code>bun init</code> å‘½ä»¤æ£€æµ‹æ˜¯å¦å®‰è£…äº†â€œClaude Codeâ€ï¼ˆå¾ˆå¯èƒ½æ˜¯æŒ‡ä¸€ä¸ªä½¿ç”¨ Claude æ¨¡å‹çš„ AI ç¼–ç¨‹åŠ©æ‰‹ï¼‰ï¼Œç„¶åç”Ÿæˆä¸€ä¸ª <code>CLAUDE.md</code> æ–‡ä»¶æ¥â€œå‘Šè¯‰ Claude ä½¿ç”¨ Bunâ€ã€‚</li><li>è¿™è¡¨æ˜ Bun æ­£åœ¨ç§¯æåœ°å°è¯•å¼•å¯¼ AI ç¼–ç¨‹åŠ©æ‰‹å’Œå¼€å‘è€…ä½¿ç”¨ Bunï¼Œä»¥ä¿ƒè¿›å…¶ç”Ÿæ€ç³»ç»Ÿçš„å‘å±•ã€‚</li></ul></li><li><p><strong>Evan You (Vue.js å’Œ Vite çš„åˆ›å»ºè€…) çš„åé©³å’Œå»ºè®®ï¼š</strong></p><ul><li>Evan You æ‰¿è®¤ Bun æœ‰æ„â€œåŠé€€â€ç”¨æˆ·ä½¿ç”¨ Vite å’Œ Vitestï¼Œä½†ä»–å¼ºè°ƒ <strong>Bun çš„å¯¹åº”åŠŸèƒ½ç›®å‰å¹¶éå®Œå…¨ç­‰åŒçš„æ›¿ä»£å“</strong>ã€‚</li><li>ä»–åˆ—ä¸¾äº† <code>Vite</code> å’Œ <code>Vitest</code> çš„å¤šé¡¹ä¼˜åŠ¿ï¼ŒåŒ…æ‹¬ï¼š<ul><li>å¯¹é React æ¡†æ¶æ›´å¥½çš„æ”¯æŒã€‚</li><li>æ›´å¥½çš„ç”Ÿäº§æ„å»ºè´¨é‡ï¼ˆæ‘‡æ ‘ä¼˜åŒ–ã€ä»£ç å‹ç¼©ã€åˆ†å—æ§åˆ¶ï¼‰ã€‚</li><li>æ›´ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿæ’ä»¶ã€‚</li><li>(Vitest) æ›´å¥½çš„æµ‹è¯•æ­£ç¡®æ€§ï¼ˆé»˜è®¤å…¨å±€çŠ¶æ€éš”ç¦»ï¼‰ã€‚</li><li>(Vitest) æµè§ˆå™¨æ¨¡å¼ï¼Œå¯åœ¨çœŸå®æµè§ˆå™¨ä¸­è¿è¡Œç»„ä»¶æµ‹è¯•ã€‚</li><li>(Vitest) IDE é›†æˆã€åŸºå‡†æµ‹è¯•ã€ç±»å‹æµ‹è¯•ã€åˆ†ç‰‡ç­‰ã€‚</li></ul></li><li>ä»–æ€»ç»“è¯´ï¼Œè™½ç„¶ Bun å¾ˆæ£’ï¼Œä½†å¼€å‘è€…éœ€è¦äº†è§£å…¶ä¸­çš„æƒè¡¡ï¼Œå¹¶å»ºè®®åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œåº”è¯¥ <strong>å°† Vite å’Œ Vitest ä¸ Bun ç»“åˆä½¿ç”¨</strong>ï¼Œè€Œä¸æ˜¯å®Œå…¨æ›¿æ¢ã€‚</li></ul></li></ol><p>æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€åœºå…³äº <strong>å‰ç«¯/JavaScript æ„å»ºå·¥å…·å’Œæµ‹è¯•æ¡†æ¶çš„é€‰æ‹©ï¼Œä»¥åŠæ–°å·¥å…· (Bun) å¦‚ä½•ä¸ç°æœ‰æˆç†Ÿå·¥å…· (Vite/Vitest) å…±å­˜å’Œç«äº‰</strong> çš„è®¨è®ºï¼Œå…¶ä¸­ä¹Ÿæ¶‰åŠåˆ°äº† AI ç¼–ç¨‹å·¥å…·å¯¹è¿™ç§é€‰æ‹©çš„å½±å“ã€‚</p><hr><p><strong>User</strong></p><p>follyæ˜¯ä»€ä¹ˆåº“ï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p><code>Folly</code> æ˜¯ <strong>Facebook Open-source Library</strong> çš„ç¼©å†™ï¼Œå®ƒæ˜¯ <strong>Facebook å¼€æºçš„ä¸€ä¸ªé«˜æ€§èƒ½ C++ åº“é›†åˆ</strong>ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œ<code>Folly</code> æ˜¯ Facebook å†…éƒ¨å¼€å‘å’Œä½¿ç”¨çš„ C++ ç»„ä»¶ã€å·¥å…·å’Œå®ç”¨ç¨‹åºçš„é›†åˆï¼Œè¿™äº›ç»„ä»¶é€šå¸¸æ—¨åœ¨è§£å†³é«˜æ€§èƒ½ã€å¤§è§„æ¨¡ç³»ç»Ÿä¸­çš„ç‰¹å®šé—®é¢˜ã€‚Facebook å°†å…¶å¼€æºï¼Œä½¿å¾—å…¶ä»–å¼€å‘è€…ä¹Ÿå¯ä»¥åˆ©ç”¨è¿™äº›ç»è¿‡å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯çš„å·¥å…·ã€‚</p><p><strong>ä¸»è¦ç‰¹ç‚¹å’Œç”¨é€”ï¼š</strong></p><ol><li><strong>é«˜æ€§èƒ½å’Œä½å»¶è¿Ÿï¼š</strong> Folly ä¸­çš„ç»„ä»¶é€šå¸¸ç»è¿‡é«˜åº¦ä¼˜åŒ–ï¼Œæ—¨åœ¨æä¾›æè‡´çš„æ€§èƒ½å’Œå°½å¯èƒ½ä½çš„å»¶è¿Ÿã€‚å®ƒåŒ…å«äº†è®¸å¤šç”¨äºå¹¶å‘ã€å†…å­˜ç®¡ç†ã€æ•°æ®ç»“æ„å’Œç½‘ç»œç¼–ç¨‹çš„ä¼˜åŒ–å®ç°ã€‚</li><li><strong>å®ç”¨å·¥å…·é›†ï¼š</strong> å®ƒä¸åƒ Boost åº“é‚£æ ·æ˜¯ä¸€ä¸ªåŒ…ç½—ä¸‡è±¡çš„é€šç”¨åº“ï¼ŒFolly æ›´ä¾§é‡äºè§£å†³ Facebook åœ¨æ„å»ºå…¶å¤§è§„æ¨¡æœåŠ¡æ—¶é‡åˆ°çš„å®é™…æ€§èƒ½å’ŒåŸºç¡€è®¾æ–½é—®é¢˜ã€‚å®ƒåŒ…å«äº†å„ç§å„æ ·çš„å®ç”¨ç¨‹åºï¼Œä»é«˜çº§æ•°æ®ç»“æ„åˆ°å†…å­˜åˆ†é…å™¨ï¼Œå†åˆ°å¼‚æ­¥ç¼–ç¨‹åŸè¯­ã€‚</li><li><strong>å¹¶å‘å’Œå¤šçº¿ç¨‹ï¼š</strong> Folly æä¾›äº†è®¸å¤šå…ˆè¿›çš„å¹¶å‘åŸè¯­ï¼Œä¾‹å¦‚é”ã€åŸå­æ“ä½œã€çº¿ç¨‹æ± ã€ä»¥åŠç”¨äºæ— é”ç¼–ç¨‹çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ <code>ConcurrentHashMap</code>ï¼‰ã€‚</li><li><strong>ç½‘ç»œå’Œå¼‚æ­¥ç¼–ç¨‹ï¼š</strong> å®ƒåŒ…å«ç”¨äºæ„å»ºé«˜æ€§èƒ½ç½‘ç»œæœåŠ¡çš„ç»„ä»¶ï¼Œä¾‹å¦‚å¼‚æ­¥ I/O (å¦‚ <code>EventBase</code>)ã€Futures/Promises (å¦‚ <code>folly::Future</code>, <code>folly::Promise</code>)ï¼Œä»¥åŠå…¶ä»–å¤„ç†äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„å·¥å…·ã€‚</li><li><strong>å†…å­˜ç®¡ç†ï¼š</strong> æä¾›äº†å„ç§å†…å­˜åˆ†é…å™¨å’Œæ™ºèƒ½æŒ‡é’ˆçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä»¥æé«˜å†…å­˜ä½¿ç”¨æ•ˆç‡å’Œæ€§èƒ½ã€‚</li><li><strong>å­—ç¬¦ä¸²å’Œå®¹å™¨ï¼š</strong> ä¼˜åŒ–äº†å­—ç¬¦ä¸²æ“ä½œï¼ˆå¦‚ <code>folly::fbstring</code>ï¼‰å’Œå¸¸è§å®¹å™¨ï¼ˆå¦‚ <code>folly::HashMap</code>ï¼‰çš„å®ç°ã€‚</li><li><strong>æ³¨é‡ç»†èŠ‚ï¼š</strong> Folly ä¸­çš„ä»£ç é€šå¸¸éå¸¸å…³æ³¨ C++ è¯­è¨€çš„ç»†èŠ‚å’Œåº•å±‚æœºåˆ¶ï¼Œä»¥æ¦¨å–æœ€å¤§çš„æ€§èƒ½ã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆå®ƒå¾ˆé‡è¦ï¼Ÿ</strong></p><p>å¯¹äºéœ€è¦æ„å»ºæé«˜æ€§èƒ½ C++ åº”ç”¨ç¨‹åºï¼ˆå°¤å…¶æ˜¯åç«¯æœåŠ¡ã€åŸºç¡€è®¾æ–½æˆ–ç½‘ç»œåº”ç”¨ï¼‰çš„å¼€å‘è€…æ¥è¯´ï¼ŒFolly æä¾›äº†ä¸€å¥—ç»è¿‡å®æˆ˜æ£€éªŒçš„è§£å†³æ–¹æ¡ˆã€‚å®ƒå±•ç¤ºäº†å¦‚ä½•åœ¨çœŸå®ä¸–ç•Œçš„å¤§è§„æ¨¡éƒ¨ç½²ä¸­åº”ç”¨é«˜çº§ C++ ç‰¹æ€§å’Œä¼˜åŒ–æŠ€å·§ã€‚</p><p><strong>æ€»ç»“ï¼š</strong></p><p><code>Folly</code> æ˜¯ä¸€ä¸ªç”± Facebook å¼€æºçš„é«˜æ€§èƒ½ C++ å·¥å…·å’Œåº“çš„é›†åˆï¼Œå®ƒæ—¨åœ¨è§£å†³å¤§è§„æ¨¡ã€é«˜å¹¶å‘ç³»ç»Ÿä¸­çš„æ€§èƒ½ç“¶é¢ˆå’Œå¤æ‚é—®é¢˜ï¼Œå°¤å…¶åœ¨å¹¶å‘ã€å¼‚æ­¥ç¼–ç¨‹å’Œå†…å­˜ç®¡ç†æ–¹é¢æä¾›äº†è®¸å¤šä¼˜åŒ–å’Œå®ç”¨çš„ç»„ä»¶ã€‚</p><hr><p><strong>User</strong></p><p>å®ç”¨å·¥å…·é›†ï¼š å®ƒä¸åƒ Boost åº“é‚£æ ·æ˜¯ä¸€ä¸ªåŒ…ç½—ä¸‡è±¡çš„é€šç”¨åº“ï¼ŒFolly æ›´ä¾§é‡äºè§£å†³ Facebook åœ¨æ„å»ºå…¶å¤§è§„æ¨¡æœåŠ¡æ—¶é‡åˆ°çš„å®é™…æ€§èƒ½å’ŒåŸºç¡€è®¾æ–½é—®é¢˜ã€‚å®ƒåŒ…å«äº†å„ç§å„æ ·çš„å®ç”¨ç¨‹åºï¼Œä»é«˜çº§æ•°æ®ç»“æ„åˆ°å†…å­˜åˆ†é…å™¨ï¼Œå†åˆ°å¼‚æ­¥ç¼–ç¨‹åŸè¯­ã€‚</p><p>æœ‰å“ªäº›å†…å®¹å‘¢ï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>Folly ä½œä¸º Facebook é’ˆå¯¹å¤§è§„æ¨¡é«˜æ€§èƒ½æœåŠ¡è®¾è®¡çš„â€œå®ç”¨å·¥å…·é›†â€ï¼Œç¡®å®åŒ…å«äº†éå¸¸å¤šçš„å†…å®¹ã€‚å®ƒä¸åƒ Boost é‚£æ ·æœ‰ä¸¥æ ¼çš„æ¨¡å—åˆ’åˆ†ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä»åŠŸèƒ½ä¸Šå°†å…¶å½’ä¸ºå‡ å¤§ç±»ï¼Œå¹¶åˆ—ä¸¾ä¸€äº›ä»£è¡¨æ€§çš„ç»„ä»¶ï¼š</p><ol><li><p><strong>å¹¶å‘å’Œå¤šçº¿ç¨‹åŸè¯­ (Concurrency and Threading Primitives):</strong></p><ul><li><strong><code>folly::SpinLock</code> / <code>folly::SharedSpinLock</code>ï¼š</strong> è‡ªæ—‹é”ï¼Œé€‚ç”¨äºé”ç«äº‰æ—¶é—´çŸ­çš„åœºæ™¯ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚</li><li><strong><code>folly::AtomicStruct</code> / <code>folly::AtomicHashMap</code>ï¼š</strong> ç”¨äºæ— é”æˆ–ä½é”æ•°æ®ç»“æ„çš„åŸºç¡€ã€‚</li><li><strong><code>folly::ProducerConsumerQueue</code>ï¼š</strong> é’ˆå¯¹å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…åœºæ™¯ä¼˜åŒ–çš„æ— é”é˜Ÿåˆ—ã€‚</li><li><strong><code>folly::ConcurrentHashMap</code>ï¼š</strong> é«˜æ€§èƒ½çš„å¹¶å‘å“ˆå¸Œè¡¨ã€‚</li><li><strong><code>folly::ThreadPoolExecutor</code> / <code>folly::CPUThreadPoolExecutor</code> / <code>folly::IOThreadPoolExecutor</code>ï¼š</strong> å„ç§ä¼˜åŒ–çš„çº¿ç¨‹æ± å®ç°ï¼Œç”¨äºç®¡ç†å’Œè°ƒåº¦ä»»åŠ¡ã€‚</li><li><strong><code>folly::Hazptr</code> / <code>folly::RCU</code>ï¼š</strong> ç”¨äºæ— é”æ•°æ®ç»“æ„çš„å®‰å…¨å†…å­˜å›æ”¶æœºåˆ¶ã€‚</li></ul></li><li><p><strong>å¼‚æ­¥ç¼–ç¨‹å’Œäº‹ä»¶é©±åŠ¨ (Asynchronous Programming and Event-Driven):</strong></p><ul><li><strong><code>folly::Future</code> / <code>folly::Promise</code>ï¼š</strong> å¼‚æ­¥æ“ä½œç»“æœçš„è¡¨ç¤ºå’Œç®¡ç†ï¼Œç±»ä¼¼ JavaScript ä¸­çš„ Promiseï¼Œä½†ä¸º C++ è®¾è®¡ã€‚è¿™æ˜¯ Folly ä¸­éå¸¸æ ¸å¿ƒå’Œå¼ºå¤§çš„éƒ¨åˆ†ã€‚</li><li><strong><code>folly::EventBase</code>ï¼š</strong> åŸºäºäº‹ä»¶å¾ªç¯ï¼ˆå¦‚ epoll/kqueueï¼‰çš„å¼‚æ­¥ I/O å’Œäº‹ä»¶ç®¡ç†ã€‚å¸¸ç”¨äºæ„å»ºé«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨ã€‚</li><li><strong><code>folly::AsyncSocket</code> / <code>folly::AsyncSSLSocket</code>ï¼š</strong> å¼‚æ­¥ç½‘ç»œå¥—æ¥å­—ï¼Œä¸ <code>EventBase</code> ç»“åˆä½¿ç”¨ã€‚</li><li><strong><code>folly::coro</code>ï¼š</strong> å¯¹ C++20 åç¨‹çš„æ”¯æŒå’Œæ‰©å±•ï¼Œä½¿å¾—å¼‚æ­¥ä»£ç å¯ä»¥ä»¥åŒæ­¥çš„æ–¹å¼ç¼–å†™ï¼Œæé«˜å¯è¯»æ€§ã€‚</li></ul></li><li><p><strong>é«˜çº§æ•°æ®ç»“æ„ (Advanced Data Structures):</strong></p><ul><li><strong><code>folly::fbstring</code>ï¼š</strong> Facebook å†…éƒ¨ä½¿ç”¨çš„ä¼˜åŒ–ç‰ˆ <code>std::string</code>ï¼Œé€šå¸¸åœ¨å°å­—ç¬¦ä¸²ä¼˜åŒ– (SSO) å’Œå†…å­˜ç®¡ç†ä¸Šæœ‰æ‰€æ”¹è¿›ã€‚</li><li><strong><code>folly::F14FastMap</code> / <code>folly::F14ValueSet</code>ï¼š</strong> é«˜æ€§èƒ½çš„å“ˆå¸Œè¡¨å’Œå“ˆå¸Œé›†åˆï¼Œæä¾›äº†æ¯” <code>std::unordered_map</code> æ›´é«˜çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å†…å­˜å±€éƒ¨æ€§å’Œé¿å…å“ˆå¸Œå†²çªæ–¹é¢ã€‚</li><li><strong><code>folly::Range</code>ï¼š</strong> è½»é‡çº§çš„åªè¯»è§†å›¾ï¼ŒæŒ‡å‘å†…å­˜ä¸­çš„è¿ç»­åºåˆ—ï¼Œé¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚</li><li><strong><code>folly::small_vector</code>ï¼š</strong> ç±»ä¼¼ <code>std::vector</code>ï¼Œä½†é’ˆå¯¹å°å°ºå¯¸å‘é‡åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼Œé¿å…å †åˆ†é…å¼€é”€ã€‚</li></ul></li><li><p><strong>å†…å­˜ç®¡ç†å’Œæ™ºèƒ½æŒ‡é’ˆ (Memory Management and Smart Pointers):</strong></p><ul><li><strong><code>folly::Optional</code>ï¼š</strong> ç±»ä¼¼äº C++17 çš„ <code>std::optional</code>ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯èƒ½å­˜åœ¨æˆ–ä¸å­˜åœ¨çš„å€¼ã€‚</li><li><strong><code>folly::Poly</code>ï¼š</strong> å¤šæ€å€¼ç±»å‹ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æŒæœ‰ä¸åŒç±»å‹ä½†ç¬¦åˆæŸä¸ªæ¥å£çš„å¯¹è±¡ï¼Œè€Œæ— éœ€å †åˆ†é…ã€‚</li><li><strong><code>folly::FixedVector</code>ï¼š</strong> å›ºå®šå®¹é‡çš„å‘é‡ã€‚</li><li><strong>è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨ï¼š</strong> Folly å†…éƒ¨å¯èƒ½ä½¿ç”¨äº†é’ˆå¯¹ç‰¹å®šåœºæ™¯ä¼˜åŒ–çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚</li></ul></li><li><p><strong>å­—ç¬¦ä¸²å’Œæ–‡æœ¬å¤„ç† (String and Text Processing):</strong></p><ul><li>é™¤äº† <code>folly::fbstring</code>ï¼Œè¿˜æœ‰ä¸€äº›ç”¨äºå­—ç¬¦ä¸²æ“ä½œã€æ ¼å¼åŒ–ã€ç¼–ç /è§£ç çš„å®ç”¨å·¥å…·ã€‚</li></ul></li><li><p><strong>è¯Šæ–­å’Œå·¥å…· (Diagnostics and Utilities):</strong></p><ul><li><strong><code>folly::Benchmark</code>ï¼š</strong> ç”¨äºå¾®åŸºå‡†æµ‹è¯•çš„æ¡†æ¶ï¼Œå¸®åŠ©å¼€å‘è€…é‡åŒ–ä»£ç æ€§èƒ½ã€‚</li><li><strong><code>folly::logging</code>ï¼š</strong> ç®€å•çš„æ—¥å¿—å·¥å…·ã€‚</li><li><strong>å„ç§åŸå­æ“ä½œã€ä½æ“ä½œã€å“ˆå¸Œå‡½æ•°ç­‰åº•å±‚ä¼˜åŒ–å·¥å…·ã€‚</strong></li></ul></li></ol><p>è¿™äº›åªæ˜¯ Folly ä¸­ä¼—å¤šç»„ä»¶çš„ä¸€éƒ¨åˆ†ã€‚å®ƒä»¬å…±åŒæ„æˆäº† Facebook æ„å»ºå…¶å¤§è§„æ¨¡ã€é«˜å¹¶å‘ã€ä½å»¶è¿ŸæœåŠ¡çš„åŸºçŸ³ã€‚å¯¹äºéœ€è¦ç±»ä¼¼æ€§èƒ½å’Œå·¥ç¨‹ä¸¥è°¨æ€§çš„ C++ é¡¹ç›®æ¥è¯´ï¼ŒFolly æä¾›äº†ä¸€ä¸ªå®è´µçš„å‚è€ƒå’Œå·¥å…·ç®±ã€‚</p><hr><p><strong>User</strong></p><p>class CausalSelfAttention(nn.Module):</p><pre><code>def __init__(self, config):
    super().__init__()
    assert config.n_embd % config.n_head == 0
    # key, query, value projections for all heads, but in a batch
    self.c_attn = nn.Linear(config.n_embd, 3 * config.n_embd)
    # output projection
    self.c_proj = nn.Linear(config.n_embd, config.n_embd)
    self.c_proj.LLMC_RESIDUAL_SCALE_FLAG = 1
    # regularization
    self.n_head = config.n_head
    self.n_embd = config.n_embd
    # not really a 'bias', more of a mask, but following the OpenAI/HF naming though
    self.register_buffer(&quot;bias&quot;, torch.tril(torch.ones(config.block_size, config.block_size))
                                 .view(1, 1, config.block_size, config.block_size))

def forward(self, x):
    B, T, C = x.size() # batch size, sequence length, embedding dimensionality (n_embd)
    # calculate query, key, values for all heads in batch and move head forward to be the batch dim
    qkv = self.c_attn(x)
    q, k, v = qkv.split(self.n_embd, dim=2)
    k = k.view(B, T, self.n_head, C // self.n_head).transpose(1, 2) # (B, nh, T, hs)
    q = q.view(B, T, self.n_head, C // self.n_head).transpose(1, 2) # (B, nh, T, hs)
    v = v.view(B, T, self.n_head, C // self.n_head).transpose(1, 2) # (B, nh, T, hs)
    if FLASH:
        # flashattention
        y = F.scaled_dot_product_attention(q, k, v, is_causal=True)
    else:
        # manual implementation of attention
        # this materializes the large (T,T) matrix for all the queries and keys
        att = (q @ k.transpose(-2, -1)) * (1.0 / math.sqrt(k.size(-1)))
        att = att.masked_fill(self.bias[:,:,:T,:T] == 0, float('-inf'))
        att = F.softmax(att, dim=-1)
        y = att @ v # (B, nh, T, T) x (B, nh, T, hs) -&gt; (B, nh, T, hs)
    y = y.transpose(1, 2).contiguous().view(B, T, C) # re-assemble all head outputs side by side
    # output projection
    y = self.c_proj(y)
    return y
</code></pre><p>è¿™æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Ÿcasualæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>æ˜¯çš„ï¼Œä½ æä¾›çš„è¿™æ®µä»£ç å®ç°çš„æ˜¯ä¸€ä¸ª <strong>å› æœè‡ªæ³¨æ„åŠ›æœºåˆ¶ (Causal Self-Attention)</strong>ã€‚</p><p>è®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼š</p><h3 id=1-è¿™æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶å—>1. è¿™æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶å—ï¼Ÿ</h3><p>æ˜¯çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤šå¤´è‡ªæ³¨æ„åŠ›ï¼ˆMulti-Head Self-Attentionï¼‰æœºåˆ¶çš„å®ç°ã€‚</p><ul><li><strong><code>self.c_attn = nn.Linear(config.n_embd, 3 * config.n_embd)</code></strong>: è¿™ä¸€å±‚è´Ÿè´£å°†è¾“å…¥ <code>x</code>ï¼ˆåŸå§‹åµŒå…¥ï¼Œç»´åº¦ä¸º <code>n_embd</code>ï¼‰åŒæ—¶çº¿æ€§æŠ•å½±åˆ°ä¸‰ä¸ªä¸åŒçš„ç©ºé—´ï¼Œå¾—åˆ° Query (æŸ¥è¯¢), Key (é”®), Value (å€¼) çš„è¡¨ç¤ºã€‚æ³¨æ„åˆ°è¾“å‡ºç»´åº¦æ˜¯ <code>3 * config.n_embd</code>ï¼Œå°±æ˜¯ä¸ºäº†ç”Ÿæˆ Q, K, Vã€‚</li><li><strong><code>qkv.split(self.n_embd, dim=2)</code></strong>: å°† <code>c_attn</code> çš„è¾“å‡ºæ²¿ç€ç»´åº¦2ï¼ˆå³åµŒå…¥ç»´åº¦ï¼‰åˆ‡åˆ†æˆ Q, K, V ä¸‰éƒ¨åˆ†ã€‚</li><li><strong><code>k.view(...).transpose(1, 2)</code> ç­‰æ“ä½œ</strong>: è¿™äº›æ“ä½œæ˜¯ä¸ºäº†å°† Q, K, V é‡æ–°å¡‘å½¢ï¼Œä»¥é€‚åº”å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—ã€‚å®ƒå°†åµŒå…¥ç»´åº¦æ‹†åˆ†æˆ <code>n_head</code> ä¸ªå¤´ï¼Œæ¯ä¸ªå¤´æœ‰ <code>C // self.n_head</code> ï¼ˆå³ <code>hs</code> æˆ– <code>head_size</code>ï¼‰çš„ç»´åº¦ï¼Œå¹¶è°ƒæ•´ç»´åº¦é¡ºåºï¼Œä½¿å¾— <code>(B, nh, T, hs)</code> æˆä¸ºè®¡ç®—çš„æ–¹ä¾¿å½¢å¼ã€‚</li><li><strong>æ³¨æ„åŠ›è®¡ç®— (<code>att = (q @ k.transpose(-2, -1)) * (1.0 / math.sqrt(k.size(-1)))</code>)</strong>: è¿™æ˜¯è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå³ Query å’Œ Key çš„ç‚¹ç§¯ï¼Œå¹¶è¿›è¡Œç¼©æ”¾ã€‚</li><li><strong><code>F.softmax(att, dim=-1)</code></strong>: å¯¹æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œ softmax å½’ä¸€åŒ–ï¼Œå¾—åˆ°æ³¨æ„åŠ›æƒé‡ã€‚</li><li><strong><code>y = att @ v</code></strong>: å°†æ³¨æ„åŠ›æƒé‡ä¸ Value ç›¸ä¹˜ï¼Œå¾—åˆ°æ¯ä¸ªå¤´çš„è¾“å‡ºã€‚</li><li><strong><code>y.transpose(1, 2).contiguous().view(B, T, C)</code></strong>: å°†æ‰€æœ‰å¤´çš„è¾“å‡ºé‡æ–°æ‹¼æ¥èµ·æ¥ï¼Œæ¢å¤åˆ°åŸå§‹çš„ <code>(B, T, C)</code> å½¢çŠ¶ã€‚</li><li><strong><code>self.c_proj = nn.Linear(config.n_embd, config.n_embd)</code></strong>: æœ€åä¸€å±‚æ˜¯ä¸€ä¸ªçº¿æ€§æŠ•å½±ï¼Œç”¨äºå°†æ‹¼æ¥åçš„å¤šå¤´æ³¨æ„åŠ›è¾“å‡ºå†æ¬¡æ˜ å°„å›åŸå§‹çš„åµŒå…¥ç»´åº¦ã€‚</li></ul><h3 id=2-casual-å› æœ-æ˜¯ä»€ä¹ˆæ„æ€>2. <code>casual</code> (å› æœ) æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h3><p>åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œ<code>causal</code>ï¼ˆå› æœï¼‰é€šå¸¸æŒ‡çš„æ˜¯ <strong>å› æœæ©ç  (Causal Masking)</strong> æˆ– <strong>è‡ªå›å½’æ©ç  (Autoregressive Masking)</strong>ã€‚</p><p>å®ƒçš„å«ä¹‰æ˜¯ï¼šåœ¨è®¡ç®—åºåˆ—ä¸­æŸä¸ªä½ç½®çš„æ³¨æ„åŠ›æ—¶ï¼Œ<strong>åªèƒ½å…³æ³¨å½“å‰ä½ç½®ä»¥åŠå®ƒä¹‹å‰ï¼ˆå·¦ä¾§ï¼‰çš„å…ƒç´ ï¼Œè€Œä¸èƒ½å…³æ³¨å®ƒä¹‹åï¼ˆå³ä¾§ï¼‰çš„å…ƒç´ </strong>ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ</strong></p><p>è¿™ç§æœºåˆ¶ä¸»è¦åº”ç”¨äº<strong>ç”Ÿæˆæ¨¡å‹</strong>ï¼Œç‰¹åˆ«æ˜¯æ–‡æœ¬ç”Ÿæˆï¼ˆå¦‚ GPT ç³»åˆ—æ¨¡å‹ï¼‰ã€‚åœ¨ç”Ÿæˆä¸€ä¸ªåºåˆ—æ—¶ï¼Œæ¨¡å‹åœ¨é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼ˆæˆ–tokenï¼‰æ—¶ï¼Œåªèƒ½ä¾æ®å·²ç»ç”Ÿæˆçš„å†å²ä¿¡æ¯ï¼Œè€Œä¸èƒ½â€œå·çœ‹â€å°šæœªç”Ÿæˆçš„æœªæ¥ä¿¡æ¯ã€‚å¦‚æœå…è®¸æ¨¡å‹çœ‹åˆ°æœªæ¥çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç”Ÿæˆï¼Œè€Œæ›´åƒä¸€ä¸ªå¡«ç©ºé¢˜ï¼Œè¿™ä¼šç ´åæ¨¡å‹çš„è‡ªå›å½’æ€§è´¨ã€‚</p><p><strong>åœ¨ä½ çš„ä»£ç ä¸­å¦‚ä½•ä½“ç°ï¼Ÿ</strong></p><p>è¿™æ®µä»£ç é€šè¿‡ä»¥ä¸‹ä¸¤è¡Œå®ç°äº†å› æœæ©ç ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;bias&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>tril</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                     <span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=n>att</span> <span class=o>=</span> <span class=n>att</span><span class=o>.</span><span class=n>masked_fill</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bias</span><span class=p>[:,:,:</span><span class=n>T</span><span class=p>,:</span><span class=n>T</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>))</span>
</span></span></code></pre></div><ul><li><strong><code>torch.tril(torch.ones(config.block_size, config.block_size))</code></strong>:<ul><li><code>torch.ones(config.block_size, config.block_size)</code> åˆ›å»ºä¸€ä¸ª <code>block_size x block_size</code> çš„å…¨1çŸ©é˜µã€‚</li><li><code>torch.tril()</code> (lower triangular) å‡½æ•°ä¼šå°†è¿™ä¸ªçŸ©é˜µçš„ä¸Šä¸‰è§’éƒ¨åˆ†ï¼ˆå¯¹è§’çº¿ä»¥ä¸Šï¼‰è®¾ç½®ä¸º0ï¼Œåªä¿ç•™ä¸‹ä¸‰è§’éƒ¨åˆ†å’Œå¯¹è§’çº¿ä¸º1ã€‚</li><li>ä¾‹å¦‚ï¼Œå¦‚æœ <code>block_size</code> æ˜¯ 4ï¼Œå®ƒä¼šç”Ÿæˆï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[[1., 0., 0., 0.],
</span></span><span class=line><span class=cl> [1., 1., 0., 0.],
</span></span><span class=line><span class=cl> [1., 1., 1., 0.],
</span></span><span class=line><span class=cl> [1., 1., 1., 1.]]
</span></span></code></pre></div></li></ul></li><li><strong><code>att = att.masked_fill(self.bias[:,:,:T,:T] == 0, float('-inf'))</code></strong>:<ul><li><code>self.bias[:,:,:T,:T]</code> å–å‡ºå½“å‰åºåˆ—é•¿åº¦ <code>T</code> å¯¹åº”çš„æ©ç éƒ¨åˆ†ã€‚</li><li><code>self.bias == 0</code> çš„åœ°æ–¹å¯¹åº”ç€æœªæ¥ï¼ˆå³ä¾§ï¼‰çš„tokenã€‚</li><li><code>masked_fill()</code> å‡½æ•°ä¼šå°†æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µ <code>att</code> ä¸­ï¼Œé‚£äº›åœ¨æ©ç ä¸­ä¸º0ï¼ˆå³å¯¹åº”æœªæ¥tokenï¼‰çš„ä½ç½®å¡«å……ä¸º <code>float('-inf')</code>ï¼ˆè´Ÿæ— ç©·å¤§ï¼‰ã€‚</li><li>å½“è¿™äº›è´Ÿæ— ç©·å¤§çš„å€¼ç»è¿‡ <code>F.softmax()</code> æ—¶ï¼Œå®ƒä»¬çš„æ¦‚ç‡ä¼šå˜æˆæ¥è¿‘äº0ï¼Œä»è€Œæœ‰æ•ˆåœ°â€œå±è”½â€äº†æ¨¡å‹å¯¹æœªæ¥ä¿¡æ¯çš„æ³¨æ„åŠ›ï¼Œå®ç°äº†å› æœæ€§ã€‚</li></ul></li></ul><p><strong>æ€»ç»“ï¼š</strong> è¿™æ®µ <code>CausalSelfAttention</code> ä»£ç æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„ Transformer è§£ç å™¨ï¼ˆDecoderï¼‰éƒ¨åˆ†ä¸­ä½¿ç”¨çš„è‡ªæ³¨æ„åŠ›æ¨¡å—ï¼Œå®ƒé€šè¿‡å› æœæ©ç ç¡®ä¿æ¨¡å‹åœ¨ç”Ÿæˆåºåˆ—æ—¶åªä¾èµ–äºå·²çŸ¥çš„å†å²ä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;bias&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>tril</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                     <span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>block_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=n>att</span> <span class=o>=</span> <span class=n>att</span><span class=o>.</span><span class=n>masked_fill</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bias</span><span class=p>[:,:,:</span><span class=n>T</span><span class=p>,:</span><span class=n>T</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>        [[1., 0., 0., 0.],
</span></span><span class=line><span class=cl>         [1., 1., 0., 0.],
</span></span><span class=line><span class=cl>         [1., 1., 1., 0.],
</span></span><span class=line><span class=cl>         [1., 1., 1., 1.]]
</span></span></code></pre></div><hr><p><strong>User</strong></p><p>åƒparleyè¿™æ ·çš„æ–‡æœ¬æ¸²æŸ“å™¨éœ€è¦å¤„ç†IMEä¹ˆï¼Ÿè¿˜æ˜¯çª—å£winitå¤„ç†</p><hr><p><strong>Cursor</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œå®ƒæ¶‰åŠåˆ°äº†å›¾å½¢åº”ç”¨ç¨‹åºä¸­è¾“å…¥å¤„ç†å’Œæ¸²æŸ“çš„åˆ†å±‚ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼š</p><p><strong><code>winit</code> (æˆ–ä»»ä½•å…¶ä»–çª—å£åº“) è´Ÿè´£å¤„ç† IME äº‹ä»¶ã€‚<code>parley</code> (æ–‡æœ¬æ¸²æŸ“å™¨) è´Ÿè´£æ¸²æŸ“ <code>winit</code> ä¼ ç»™åº”ç”¨ç¨‹åºï¼Œå†ç”±åº”ç”¨ç¨‹åºé€»è¾‘å¤„ç†è¿‡çš„æ–‡æœ¬ã€‚</strong></p><p>è®©æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š</p><ol><li><p><strong><code>winit</code> (çª—å£ç®¡ç†åº“) çš„èŒè´£ï¼š</strong></p><ul><li><code>winit</code> æ˜¯ä¸€ä¸ªä½çº§åˆ«çš„åº“ï¼Œå®ƒä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç†çª—å£ã€å¤„ç†è¾“å…¥äº‹ä»¶ï¼ˆé”®ç›˜ã€é¼ æ ‡ã€è§¦æ‘¸ï¼‰ä»¥åŠç®¡ç†äº‹ä»¶å¾ªç¯ã€‚</li><li>IME (Input Method Editorï¼Œè¾“å…¥æ³•ç¼–è¾‘å™¨) æ˜¯æ“ä½œç³»ç»Ÿå±‚é¢çš„åŠŸèƒ½ï¼Œç”¨äºè¾“å…¥ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ç­‰å¤æ‚å­—ç¬¦ã€‚å½“ç”¨æˆ·é€šè¿‡IMEè¾“å…¥æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šç”Ÿæˆç‰¹å®šçš„IMEäº‹ä»¶ã€‚</li><li><code>winit</code> çš„ä»»åŠ¡å°±æ˜¯<strong>æ•è·è¿™äº›æ“ä½œç³»ç»Ÿå±‚é¢çš„ IME äº‹ä»¶</strong>ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·æ­£åœ¨è¾“å…¥æ‹¼éŸ³æˆ–ç¬”ç”»æ—¶çš„é¢„ç¼–è¾‘å­—ç¬¦ä¸²ï¼Œä»¥åŠæœ€ç»ˆç¡®è®¤çš„å­—ç¬¦ï¼‰ï¼Œå¹¶å°†å…¶<strong>ä½œä¸ºäº‹ä»¶ä¼ é€’ç»™ä½ çš„åº”ç”¨ç¨‹åº</strong>ã€‚</li><li><code>winit</code> è¿˜ä¼šæä¾›APIè®©åº”ç”¨ç¨‹åºå‘Šè¯‰å®ƒIMEå€™é€‰çª—å£åº”è¯¥å‡ºç°åœ¨å±å¹•çš„å“ªä¸ªä½ç½®ï¼ˆé€šå¸¸æ˜¯æ ¹æ®å½“å‰æ–‡æœ¬å…‰æ ‡çš„ä½ç½®ï¼‰ã€‚</li></ul></li><li><p><strong>åº”ç”¨ç¨‹åºé€»è¾‘ (ä½ çš„ä»£ç ) çš„èŒè´£ï¼š</strong></p><ul><li>å½“ <code>winit</code> æ•è·åˆ°IMEäº‹ä»¶å¹¶ä¼ é€’ç»™ä½ çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºéœ€è¦<strong>è§£æå¹¶å¤„ç†è¿™äº›äº‹ä»¶</strong>ã€‚</li><li>è¿™é€šå¸¸æ„å‘³ç€ä½ çš„åº”ç”¨ç¨‹åºéœ€è¦ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨çš„æ–‡æœ¬ç¼“å†²åŒºï¼Œä»¥åŠä¸€ä¸ªå½“å‰æ­£åœ¨è¾“å…¥ï¼ˆé¢„ç¼–è¾‘ï¼‰çš„æ–‡æœ¬å­—ç¬¦ä¸²ã€‚</li><li>å½“IMEå‘é€<strong>é¢„ç¼–è¾‘æ–‡æœ¬</strong>æ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºéœ€è¦å°†è¿™äº›æ–‡æœ¬æ˜¾ç¤ºåœ¨å…‰æ ‡ä½ç½®ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªä¸‹åˆ’çº¿æˆ–å…¶ä»–é«˜äº®è¡¨ç¤ºè¿™æ˜¯æœªæäº¤çš„æ–‡æœ¬ã€‚</li><li>å½“IMEå‘é€<strong>æœ€ç»ˆæäº¤çš„å­—ç¬¦</strong>æ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºéœ€è¦å°†è¿™äº›å­—ç¬¦æ’å…¥åˆ°å…¶å†…éƒ¨æ–‡æœ¬ç¼“å†²åŒºä¸­ã€‚</li><li>åº”ç”¨ç¨‹åºè¿˜éœ€è¦ç®¡ç†å…‰æ ‡ä½ç½®ï¼Œå¹¶é€šçŸ¥ <code>winit</code> å½“å‰å…‰æ ‡çš„å±å¹•åæ ‡ï¼Œä»¥ä¾¿IMEå¯ä»¥æ­£ç¡®æ˜¾ç¤ºå…¶å€™é€‰çª—å£ã€‚</li></ul></li><li><p><strong><code>parley</code> (æ–‡æœ¬æ¸²æŸ“å™¨) çš„èŒè´£ï¼š</strong></p><ul><li><code>parley</code> ä½œä¸ºä¸€ä¸ªæ–‡æœ¬æ¸²æŸ“å™¨ï¼Œå®ƒçš„æ ¸å¿ƒä»»åŠ¡æ˜¯<strong>å°†æ–‡æœ¬å­—ç¬¦ä¸²ï¼ˆåŒ…å«å­—ç¬¦ã€å­—ä½“ã€å¤§å°ã€é¢œè‰²ç­‰ä¿¡æ¯ï¼‰è½¬æ¢ä¸ºå±å¹•ä¸Šçš„åƒç´ </strong>ã€‚</li><li>å®ƒ<strong>ä¸ç›´æ¥å¤„ç†IMEäº‹ä»¶</strong>ï¼Œå®ƒåªæ¥æ”¶ç”±åº”ç”¨ç¨‹åºé€»è¾‘æä¾›çš„<strong>æœ€ç»ˆè¦æ¸²æŸ“çš„æ–‡æœ¬æ•°æ®</strong>ã€‚</li><li>ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·é€šè¿‡IMEè¾“å…¥â€œnihaoâ€å¹¶æ˜¾ç¤ºä¸ºâ€œä½ å¥½â€çš„é¢„ç¼–è¾‘çŠ¶æ€æ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¼šå‘Šè¯‰ <code>parley</code> æ¸²æŸ“â€œä½ å¥½â€ï¼ˆå¹¶å¯èƒ½æŒ‡ç¤ºå…¶ç»˜åˆ¶ä¸‹åˆ’çº¿ï¼‰ã€‚å½“ç”¨æˆ·æŒ‰ä¸‹å›è½¦ç¡®è®¤åï¼Œä½ çš„åº”ç”¨ç¨‹åºä¼šæ›´æ–°å…¶å†…éƒ¨æ–‡æœ¬ï¼Œç„¶åå‘Šè¯‰ <code>parley</code> æ¸²æŸ“æ–°çš„å®Œæ•´æ–‡æœ¬ã€‚</li></ul></li></ol><p><strong>æ€»ç»“ï¼š</strong></p><ul><li><strong><code>winit</code>ï¼š</strong> è´Ÿè´£ä¸æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬IMEï¼‰äº¤äº’ï¼Œæ¥æ”¶å¹¶åˆ†å‘åŸå§‹è¾“å…¥äº‹ä»¶ã€‚</li><li><strong>åº”ç”¨ç¨‹åºé€»è¾‘ï¼š</strong> è´Ÿè´£å¤„ç† <code>winit</code> ä¼ æ¥çš„IMEäº‹ä»¶ï¼Œç®¡ç†å†…éƒ¨æ–‡æœ¬çŠ¶æ€ï¼ˆåŒ…æ‹¬é¢„ç¼–è¾‘æ–‡æœ¬å’Œæœ€ç»ˆæ–‡æœ¬ï¼‰ï¼Œä»¥åŠå†³å®šIMEå€™é€‰çª—å£çš„ä½ç½®ã€‚</li><li><strong><code>parley</code>ï¼š</strong> è´Ÿè´£æ ¹æ®åº”ç”¨ç¨‹åºæä¾›çš„æ–‡æœ¬å†…å®¹ï¼ˆåŒ…æ‹¬é¢„ç¼–è¾‘æ–‡æœ¬ï¼‰è¿›è¡Œé«˜æ•ˆçš„å­—ä½“å¸ƒå±€ã€å­—å½¢æ¸²æŸ“å’Œæ˜¾ç¤ºã€‚</li></ul><p>æ‰€ä»¥ï¼Œè™½ç„¶ <code>parley</code> ä¸ç›´æ¥å¤„ç†IMEï¼Œä½†ä½ çš„åº”ç”¨ç¨‹åºéœ€è¦å°† <code>winit</code> æä¾›çš„IMEä¿¡æ¯æ­£ç¡®åœ°ä¼ ç»™ <code>parley</code> è¿›è¡Œæ¸²æŸ“ã€‚IMEå¤„ç†æ˜¯ä¸€ä¸ªåä½œè¿‡ç¨‹ï¼Œæ¶‰åŠæ“ä½œç³»ç»Ÿã€çª—å£åº“ã€åº”ç”¨ç¨‹åºå’Œæ¸²æŸ“å™¨ã€‚</p><hr><p><strong>User</strong></p><p>use std::ffi::{c_void, OsString};
use std::os::windows::prelude::OsStringExt;
use std::ptr::null_mut;</p><p>use dpi::{Position, Size};
use windows_sys::Win32::Foundation::{POINT, RECT};
use windows_sys::Win32::UI::Input::Ime::{
ImmAssociateContextEx, ImmGetCompositionStringW, ImmGetContext, ImmReleaseContext,
ImmSetCandidateWindow, ImmSetCompositionWindow, ATTR_TARGET_CONVERTED,
ATTR_TARGET_NOTCONVERTED, CANDIDATEFORM, CFS_EXCLUDE, CFS_POINT, COMPOSITIONFORM, GCS_COMPATTR,
GCS_COMPSTR, GCS_CURSORPOS, GCS_RESULTSTR, HIMC, IACE_CHILDREN, IACE_DEFAULT,
};
use windows_sys::Win32::UI::WindowsAndMessaging::{GetSystemMetrics, SM_IMMENABLED};</p><p>use crate::HWND;</p><p>pub struct ImeContext {
hwnd: HWND,
himc: HIMC,
}</p><p>impl ImeContext {
pub unsafe fn current(hwnd: HWND) -> Self {
let himc = unsafe { ImmGetContext(hwnd) };
ImeContext { hwnd, himc }
}</p><pre><code>pub unsafe fn get_composing_text_and_cursor(
    &amp;self,
) -&gt; Option&lt;(String, Option&lt;usize&gt;, Option&lt;usize&gt;)&gt; {
    let text = unsafe { self.get_composition_string(GCS_COMPSTR) }?;
    let attrs = unsafe { self.get_composition_data(GCS_COMPATTR) }.unwrap_or_default();

    let mut first = None;
    let mut last = None;
    let mut boundary_before_char = 0;
    let mut attr_idx = 0;

    for chr in text.chars() {
        let Some(attr) = attrs.get(attr_idx).copied() else {
            break;
        };

        let char_is_targeted =
            attr as u32 == ATTR_TARGET_CONVERTED || attr as u32 == ATTR_TARGET_NOTCONVERTED;

        if first.is_none() &amp;&amp; char_is_targeted {
            first = Some(boundary_before_char);
        } else if first.is_some() &amp;&amp; last.is_none() &amp;&amp; !char_is_targeted {
            last = Some(boundary_before_char);
        }

        boundary_before_char += chr.len_utf8();
        attr_idx += chr.len_utf16();
    }

    if first.is_some() &amp;&amp; last.is_none() {
        last = Some(text.len());
    } else if first.is_none() {
        // IME haven't split words and select any clause yet, so trying to retrieve normal
        // cursor.
        let cursor = unsafe { self.get_composition_cursor(&amp;text) };
        first = cursor;
        last = cursor;
    }

    Some((text, first, last))
}

pub unsafe fn get_composed_text(&amp;self) -&gt; Option&lt;String&gt; {
    unsafe { self.get_composition_string(GCS_RESULTSTR) }
}

unsafe fn get_composition_cursor(&amp;self, text: &amp;str) -&gt; Option&lt;usize&gt; {
    let cursor = unsafe { ImmGetCompositionStringW(self.himc, GCS_CURSORPOS, null_mut(), 0) };
    (cursor &gt;= 0).then(|| text.chars().take(cursor as _).map(|c| c.len_utf8()).sum())
}

unsafe fn get_composition_string(&amp;self, gcs_mode: u32) -&gt; Option&lt;String&gt; {
    let data = unsafe { self.get_composition_data(gcs_mode) }?;
    let (prefix, shorts, suffix) = unsafe { data.align_to::&lt;u16&gt;() };
    if prefix.is_empty() &amp;&amp; suffix.is_empty() {
        OsString::from_wide(shorts).into_string().ok()
    } else {
        None
    }
}

unsafe fn get_composition_data(&amp;self, gcs_mode: u32) -&gt; Option&lt;Vec&lt;u8&gt;&gt; {
    let size = match unsafe { ImmGetCompositionStringW(self.himc, gcs_mode, null_mut(), 0) } {
        0 =&gt; return Some(Vec::new()),
        size if size &lt; 0 =&gt; return None,
        size =&gt; size,
    };

    let mut buf = Vec::&lt;u8&gt;::with_capacity(size as _);
    let size = unsafe {
        ImmGetCompositionStringW(
            self.himc,
            gcs_mode,
            buf.as_mut_ptr() as *mut c_void,
            size as _,
        )
    };

    if size &lt; 0 {
        None
    } else {
        unsafe { buf.set_len(size as _) };
        Some(buf)
    }
}

pub unsafe fn set_ime_cursor_area(&amp;self, spot: Position, size: Size, scale_factor: f64) {
    if !unsafe { ImeContext::system_has_ime() } {
        return;
    }

    let (x, y) = spot.to_physical::&lt;i32&gt;(scale_factor).into();
    let (width, height): (i32, i32) = size.to_physical::&lt;i32&gt;(scale_factor).into();
    let rc_area = RECT { left: x, top: y, right: x + width, bottom: y + height };
    let candidate_form = CANDIDATEFORM {
        dwIndex: 0,
        dwStyle: CFS_EXCLUDE,
        ptCurrentPos: POINT { x, y },
        rcArea: rc_area,
    };
    let composition_form = COMPOSITIONFORM {
        dwStyle: CFS_POINT,
        ptCurrentPos: POINT { x, y: y + height },
        rcArea: rc_area,
    };

    unsafe {
        ImmSetCompositionWindow(self.himc, &amp;composition_form);
        ImmSetCandidateWindow(self.himc, &amp;candidate_form);
    }
}

pub unsafe fn set_ime_allowed(hwnd: HWND, allowed: bool) {
    if !unsafe { ImeContext::system_has_ime() } {
        return;
    }

    if allowed {
        unsafe { ImmAssociateContextEx(hwnd, null_mut(), IACE_DEFAULT) };
    } else {
        unsafe { ImmAssociateContextEx(hwnd, null_mut(), IACE_CHILDREN) };
    }
}

unsafe fn system_has_ime() -&gt; bool {
    unsafe { GetSystemMetrics(SM_IMMENABLED) != 0 }
}
</code></pre><p>}</p><p>impl Drop for ImeContext {
fn drop(&amp;mut self) {
unsafe { ImmReleaseContext(self.hwnd, self.himc) };
}
}</p><p>è¿™ä¸€æ®µæ˜¯windowsä¸Šçš„winitçš„ä¸€éƒ¨åˆ†ä»£ç </p><hr><p><strong>Cursor</strong></p><p>è¿™æ®µ Rust ä»£ç æ˜¯ <code>winit</code> åº“åœ¨ Windows å¹³å°ä¸Šå¤„ç† <strong>è¾“å…¥æ³•ç¼–è¾‘å™¨ (IME)</strong> çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p>å®ƒå°è£…äº† Windows IMM (Input Method Manager) APIï¼Œä½¿å¾—åº”ç”¨ç¨‹åºèƒ½å¤Ÿä¸ç”¨æˆ·çš„è¾“å…¥æ³•è¿›è¡Œäº¤äº’ï¼Œä»è€Œæ­£ç¡®åœ°æ˜¾ç¤ºé¢„ç¼–è¾‘æ–‡æœ¬ã€ç®¡ç†å…‰æ ‡ä½ç½®ä»¥åŠæ¥æ”¶æœ€ç»ˆæäº¤çš„æ–‡æœ¬ã€‚</p><h3 id=ä¸»è¦ç»“æ„å’ŒåŠŸèƒ½>ä¸»è¦ç»“æ„å’ŒåŠŸèƒ½ï¼š</h3><h4 id=struct-imecontext><code>struct ImeContext</code></h4><ul><li><strong><code>hwnd: HWND</code></strong>: è¿™æ˜¯ä¸€ä¸ª Windows çª—å£å¥æŸ„ï¼ˆHandle to Windowï¼‰ã€‚è¡¨ç¤ºè¿™ä¸ª IME ä¸Šä¸‹æ–‡æ˜¯ä¸å“ªä¸ªå…·ä½“çš„çª—å£å…³è”çš„ã€‚</li><li><strong><code>himc: HIMC</code></strong>: è¿™æ˜¯ Windows IME è¾“å…¥ä¸Šä¸‹æ–‡å¥æŸ„ï¼ˆHandle to Input Method Contextï¼‰ã€‚IME API ä¸­çš„è®¸å¤šæ“ä½œéƒ½éœ€è¦è¿™ä¸ªå¥æŸ„æ¥æ ‡è¯†å½“å‰çš„è¾“å…¥çŠ¶æ€ã€‚</li></ul><h4 id=impl-imecontext-æ–¹æ³•è§£æ><code>impl ImeContext</code> æ–¹æ³•è§£æï¼š</h4><ol><li><p><strong><code>unsafe fn current(hwnd: HWND) -> Self</code></strong></p><ul><li>ä½œç”¨ï¼šè·å–ç»™å®šçª—å£çš„å½“å‰ IME ä¸Šä¸‹æ–‡å¥æŸ„ (<code>HIMC</code>)ã€‚</li><li>å®ç°ï¼šè°ƒç”¨ <code>windows_sys::Win32::UI::Input::Ime::ImmGetContext(hwnd)</code>ã€‚è¿™æ˜¯è·å– IME ä¸Šä¸‹æ–‡çš„å…¥å£ç‚¹ã€‚</li><li><code>unsafe</code>ï¼šè¡¨ç¤ºè¿™ä¸ªå‡½æ•°è°ƒç”¨äº† FFIï¼ˆå¤–éƒ¨å‡½æ•°æ¥å£ï¼‰ï¼Œç›´æ¥ä¸ Windows API äº¤äº’ï¼Œéœ€è¦è°ƒç”¨è€…ç¡®ä¿å†…å­˜å®‰å…¨å’Œæ­£ç¡®çš„å‚æ•°ã€‚</li></ul></li><li><p><strong><code>unsafe fn get_composing_text_and_cursor(&amp;self) -> Option&lt;(String, Option&lt;usize>, Option&lt;usize>)></code></strong></p><ul><li>ä½œç”¨ï¼šè·å–ç”¨æˆ·å½“å‰æ­£åœ¨é€šè¿‡ IME è¾“å…¥çš„â€œé¢„ç¼–è¾‘â€æ–‡æœ¬ï¼ˆcomposition stringï¼‰ï¼Œä»¥åŠæ–‡æœ¬ä¸­è¢«é€‰ä¸­æˆ–æ­£åœ¨è½¬æ¢çš„åŒºåŸŸçš„èµ·å§‹å’Œç»“æŸå­—èŠ‚ç´¢å¼•ï¼ˆç”¨äºé«˜äº®æˆ–ä¸‹åˆ’çº¿ï¼‰ï¼Œå’Œå…‰æ ‡ä½ç½®ã€‚</li><li>å®ç°ï¼š<ul><li><code>self.get_composition_string(GCS_COMPSTR)</code>ï¼šè·å–é¢„ç¼–è¾‘å­—ç¬¦ä¸²ã€‚</li><li><code>self.get_composition_data(GCS_COMPATTR)</code>ï¼šè·å–é¢„ç¼–è¾‘å­—ç¬¦ä¸²çš„å±æ€§ï¼ˆå¦‚å“ªäº›éƒ¨åˆ†å·²è½¬æ¢ï¼Œå“ªäº›æ˜¯ç›®æ ‡ï¼‰ã€‚</li><li>é€šè¿‡éå†æ–‡æœ¬å­—ç¬¦å’Œå±æ€§ï¼Œè®¡ç®— <code>first</code> (ç›®æ ‡åŒºåŸŸå¼€å§‹) å’Œ <code>last</code> (ç›®æ ‡åŒºåŸŸç»“æŸ) çš„å­—èŠ‚åç§»ã€‚</li><li>å¦‚æœ IME è¿˜æ²¡æœ‰å¼€å§‹åˆ†è¯æˆ–é€‰æ‹©ï¼Œå®ƒä¼šå°è¯•ä½¿ç”¨ <code>self.get_composition_cursor</code> è·å–å¸¸è§„å…‰æ ‡ä½ç½®ã€‚</li></ul></li><li>è¿”å›ï¼šä¸€ä¸ª <code>Option</code>ï¼ŒåŒ…å« (é¢„ç¼–è¾‘å­—ç¬¦ä¸², ç›®æ ‡åŒºåŸŸå¼€å§‹ç´¢å¼•, ç›®æ ‡åŒºåŸŸç»“æŸç´¢å¼•)ã€‚</li></ul></li><li><p><strong><code>unsafe fn get_composed_text(&amp;self) -> Option&lt;String></code></strong></p><ul><li>ä½œç”¨ï¼šè·å–ç”¨æˆ·å·²ç»é€šè¿‡ IME ç¡®è®¤å¹¶æäº¤çš„æœ€ç»ˆæ–‡æœ¬ï¼ˆresult stringï¼‰ã€‚</li><li>å®ç°ï¼šè°ƒç”¨ <code>self.get_composition_string(GCS_RESULTSTR)</code>ã€‚</li></ul></li><li><p><strong><code>unsafe fn get_composition_cursor(&amp;self, text: &amp;str) -> Option&lt;usize></code> (ç§æœ‰è¾…åŠ©å‡½æ•°)</strong></p><ul><li>ä½œç”¨ï¼šè·å–é¢„ç¼–è¾‘å­—ç¬¦ä¸²ä¸­å…‰æ ‡çš„é€»è¾‘ä½ç½®ï¼ˆåŸºäº UTF-8 å­—èŠ‚åç§»ï¼‰ã€‚</li><li>å®ç°ï¼šè°ƒç”¨ <code>ImmGetCompositionStringW(self.himc, GCS_CURSORPOS, ...)</code> è·å– UTF-16 å­—ç¬¦ç´¢å¼•ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸º UTF-8 å­—èŠ‚åç§»ã€‚</li></ul></li><li><p><strong><code>unsafe fn get_composition_string(&amp;self, gcs_mode: u32) -> Option&lt;String></code> (ç§æœ‰è¾…åŠ©å‡½æ•°)</strong></p><ul><li>ä½œç”¨ï¼šé€šç”¨åœ°ä» IME è·å–å­—ç¬¦ä¸²æ•°æ®ï¼ˆæ— è®ºæ˜¯é¢„ç¼–è¾‘è¿˜æ˜¯ç»“æœå­—ç¬¦ä¸²ï¼‰ã€‚</li><li>å®ç°ï¼š<ul><li>é¦–å…ˆè°ƒç”¨ <code>ImmGetCompositionStringW</code> ä¼ å…¥ <code>null_mut()</code> å’Œ <code>0</code> æ¥è·å–æ‰€éœ€çš„ç¼“å†²åŒºå¤§å°ã€‚</li><li>ç„¶ååˆ†é…ç›¸åº”å¤§å°çš„ <code>Vec&lt;u8></code> ç¼“å†²åŒºã€‚</li><li>å†æ¬¡è°ƒç”¨ <code>ImmGetCompositionStringW</code> å°†æ•°æ®å¡«å……åˆ°ç¼“å†²åŒºä¸­ã€‚</li><li>ç”±äº Windows API è¿”å›çš„æ˜¯ UTF-16 ç¼–ç çš„å®½å­—ç¬¦ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>OsString::from_wide(shorts).into_string().ok()</code> å°†å…¶è½¬æ¢ä¸º Rust çš„ <code>String</code>ã€‚</li></ul></li></ul></li><li><p><strong><code>unsafe fn get_composition_data(&amp;self, gcs_mode: u32) -> Option&lt;Vec&lt;u8>></code> (ç§æœ‰è¾…åŠ©å‡½æ•°)</strong></p><ul><li>ä½œç”¨ï¼šè·å–åŸå§‹çš„å­—èŠ‚æ•°æ®ï¼ˆä¾‹å¦‚å±æ€§æ•°æ®ï¼‰ã€‚ä¸ <code>get_composition_string</code> ç±»ä¼¼ï¼Œä½†è¿”å› <code>Vec&lt;u8></code> è€Œä¸æ˜¯ <code>String</code>ã€‚</li></ul></li><li><p><strong><code>pub unsafe fn set_ime_cursor_area(&amp;self, spot: Position, size: Size, scale_factor: f64)</code></strong></p><ul><li>ä½œç”¨ï¼šå‘Šè¯‰ IME åº”ç”¨ç¨‹åºä¸­å½“å‰æ–‡æœ¬è¾“å…¥åŒºåŸŸçš„å±å¹•ä½ç½®å’Œå¤§å°ï¼Œä»¥ä¾¿ IME èƒ½å¤Ÿæ­£ç¡®åœ°å®šä½å…¶å€™é€‰è¯çª—å£ã€‚</li><li>å®ç°ï¼š<ul><li>å°†é€»è¾‘åƒç´ ä½ç½®å’Œå¤§å°è½¬æ¢ä¸ºç‰©ç†åƒç´ ï¼ˆè€ƒè™‘åˆ°ç¼©æ”¾å› å­ <code>scale_factor</code>ï¼‰ã€‚</li><li>æ„å»º <code>RECT</code> (åŒºåŸŸ) å’Œ <code>POINT</code> (ç‚¹) ç»“æ„ã€‚</li><li><code>ImmSetCompositionWindow</code>: è®¾ç½®ç»„åˆçª—å£ï¼ˆé€šå¸¸æ˜¯é¢„ç¼–è¾‘æ–‡æœ¬ä¸‹æ–¹æ˜¾ç¤ºé«˜äº®/ä¸‹åˆ’çº¿çš„åŒºåŸŸï¼‰çš„ä½ç½®ã€‚</li><li><code>ImmSetCandidateWindow</code>: è®¾ç½®å€™é€‰è¯çª—å£ï¼ˆæ˜¾ç¤ºå€™é€‰è¯åˆ—è¡¨ï¼‰çš„ä½ç½®å’Œæ ·å¼ã€‚</li></ul></li></ul></li><li><p><strong><code>pub unsafe fn set_ime_allowed(hwnd: HWND, allowed: bool)</code></strong></p><ul><li>ä½œç”¨ï¼šæ§åˆ¶ç‰¹å®šçª—å£æ˜¯å¦å…è®¸ä½¿ç”¨ IMEã€‚</li><li>å®ç°ï¼šè°ƒç”¨ <code>ImmAssociateContextEx</code>ã€‚<ul><li><code>IACE_DEFAULT</code>ï¼šå°†é»˜è®¤ IME ä¸Šä¸‹æ–‡ä¸çª—å£å…³è”ï¼ˆå…è®¸ IMEï¼‰ã€‚</li><li><code>IACE_CHILDREN</code>ï¼šé€šå¸¸ç”¨äºç¦æ­¢ IMEï¼Œæˆ–è€…å°† IME ä¸Šä¸‹æ–‡ä¼ é€’ç»™å­çª—å£ï¼ˆä¾‹å¦‚ï¼Œåœ¨è‡ªå®šä¹‰æ§ä»¶ä¸­æ¥ç®¡ IME å¤„ç†ï¼‰ã€‚</li></ul></li></ul></li><li><p><strong><code>unsafe fn system_has_ime() -> bool</code> (ç§æœ‰è¾…åŠ©å‡½æ•°)</strong></p><ul><li>ä½œç”¨ï¼šæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å¯ç”¨äº† IMEã€‚</li><li>å®ç°ï¼šè°ƒç”¨ <code>GetSystemMetrics(SM_IMMENABLED)</code>ã€‚</li></ul></li></ol><h4 id=impl-drop-for-imecontext><code>impl Drop for ImeContext</code></h4><ul><li><strong><code>fn drop(&amp;mut self)</code></strong><ul><li>ä½œç”¨ï¼šå½“ <code>ImeContext</code> å®ä¾‹è¢«é”€æ¯æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾å…¶æŒæœ‰çš„ IME ä¸Šä¸‹æ–‡å¥æŸ„ã€‚</li><li>å®ç°ï¼šè°ƒç”¨ <code>ImmReleaseContext(self.hwnd, self.himc)</code>ã€‚è¿™æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå¦‚æœ <code>HIMC</code> ä¸è¢«é‡Šæ”¾ï¼Œä¼šå¯¼è‡´èµ„æºæ³„æ¼ã€‚</li></ul></li></ul><h3 id=æ€»ç»“>æ€»ç»“ï¼š</h3><p>è¿™æ®µä»£ç æ˜¯ <code>winit</code> åœ¨ Windows ä¸Šå®ç° IME <strong>äº‹ä»¶å¤„ç†</strong>å’Œ<strong>ç•Œé¢å®šä½</strong>çš„å…³é”®ã€‚å®ƒè´Ÿè´£ï¼š</p><ul><li><strong>è·å– IME è¾“å…¥çŠ¶æ€ï¼š</strong> è·å–ç”¨æˆ·æ­£åœ¨è¾“å…¥çš„é¢„ç¼–è¾‘æ–‡æœ¬ã€å…‰æ ‡ä½ç½®ã€å·²æäº¤çš„æ–‡æœ¬ã€‚</li><li><strong>ç®¡ç† IME ç•Œé¢ï¼š</strong> å‘Šè¯‰æ“ä½œç³»ç»Ÿ IME å€™é€‰è¯çª—å£å’Œç»„åˆçª—å£åº”è¯¥å‡ºç°åœ¨å±å¹•çš„å“ªä¸ªä½ç½®ï¼Œä»¥ä¾¿ä¸åº”ç”¨ç¨‹åºçš„æ–‡æœ¬è¾“å…¥åŒºåŸŸå¯¹é½ã€‚</li><li><strong>å¯ç”¨/ç¦ç”¨ IMEï¼š</strong> æ§åˆ¶ç‰¹å®šçª—å£æ˜¯å¦å“åº” IME è¾“å…¥ã€‚</li></ul><p>æ­£å¦‚ä¹‹å‰æ‰€è®¨è®ºçš„ï¼Œè¿™æ®µä»£ç å±äº <code>winit</code> åº“çš„èŒƒç•´ï¼Œå®ƒå¤„ç†çš„æ˜¯åº•å±‚æ“ä½œç³»ç»Ÿçš„è¾“å…¥æ³•äº‹ä»¶ã€‚åº”ç”¨ç¨‹åºå±‚ä¼šæ¥æ”¶ <code>winit</code> ä¼ é€’è¿‡æ¥çš„è¿™äº›è§£æå¥½çš„æ–‡æœ¬å’Œå…‰æ ‡ä¿¡æ¯ï¼Œç„¶åä½¿ç”¨åƒ <code>parley</code> è¿™æ ·çš„æ–‡æœ¬æ¸²æŸ“å™¨æ¥å°†å…¶æ­£ç¡®åœ°ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</p><hr><p><strong>User</strong></p><p>é‚£winitå’ŒIMEç›¸å…³çš„APIé•¿ä»€ä¹ˆæ ·å­ï¼Ÿparleyæ˜¯å¦‚ä½•ä½¿ç”¨winitå¯¹åº”çš„apiçš„</p><hr><p><strong>Cursor</strong></p><p>æ˜¯çš„ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬å‰é¢è®¨è®ºçš„æ ¸å¿ƒåˆ†å±‚æ¦‚å¿µã€‚</p><p><code>winit</code> ä½œä¸ºçª—å£ç®¡ç†åº“ï¼Œå®ƒçš„èŒè´£æ˜¯å¤„ç†ä¸æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬IMEï¼‰çš„åº•å±‚äº¤äº’ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯è½¬åŒ–ä¸ºåº”ç”¨ç¨‹åºå¯ä»¥ç†è§£çš„äº‹ä»¶ã€‚<code>parley</code> ä½œä¸ºä¸€ä¸ªçº¯ç²¹çš„æ–‡æœ¬æ¸²æŸ“åº“ï¼Œå®ƒåªå…³å¿ƒå¦‚ä½•é«˜æ•ˆã€æ­£ç¡®åœ°æ˜¾ç¤ºå­—ç¬¦ï¼Œè€Œä¸å…³å¿ƒå­—ç¬¦ä»ä½•è€Œæ¥ã€‚</p><p>ä¸‹é¢è¯¦ç»†è¯´æ˜ <code>winit</code> å’Œ IME ç›¸å…³çš„ API é•¿ä»€ä¹ˆæ ·å­ï¼Œä»¥åŠåº”ç”¨ç¨‹åºå¦‚ä½•å°† <code>winit</code> çš„æ•°æ®ä¼ é€’ç»™ <code>parley</code>ã€‚</p><hr><h3 id=1-winit-å’Œ-ime-ç›¸å…³çš„-api-äº‹ä»¶å’Œæ–¹æ³•>1. <code>winit</code> å’Œ IME ç›¸å…³çš„ API (äº‹ä»¶å’Œæ–¹æ³•)</h3><p><code>winit</code> é€šè¿‡ <code>winit::event::Event::WindowEvent</code> æšä¸¾ä¸­çš„ <code>Ime</code> å˜ä½“æ¥å‘åº”ç”¨ç¨‹åºæŠ¥å‘Š IME ç›¸å…³äº‹ä»¶ã€‚åŒæ—¶ï¼Œ<code>winit</code> çš„ <code>Window</code> å¯¹è±¡ä¸Šä¹Ÿæœ‰æ–¹æ³•æ¥æ§åˆ¶ IME çš„è¡Œä¸ºã€‚</p><h4 id=a-winit-å‘é€çš„-ime-äº‹ä»¶>A. <code>winit</code> å‘é€çš„ IME äº‹ä»¶</h4><p>å½“ç”¨æˆ·é€šè¿‡ IME è¾“å…¥æ—¶ï¼Œä½ çš„ <code>winit</code> äº‹ä»¶å¾ªç¯ä¼šæ¥æ”¶åˆ°è¿™äº›äº‹ä»¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>winit</span>::<span class=n>event</span>::<span class=p>{</span><span class=n>Event</span><span class=p>,</span><span class=w> </span><span class=n>WindowEvent</span><span class=p>,</span><span class=w> </span><span class=n>Ime</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ... å…¶ä»–useå£°æ˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>event_loop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EventLoop</span>::<span class=n>new</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowBuilder</span>::<span class=n>new</span><span class=p>().</span><span class=n>build</span><span class=p>(</span><span class=o>&amp;</span><span class=n>event_loop</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>composing_text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w> </span><span class=c1>// åº”ç”¨ç¨‹åºç»´æŠ¤çš„é¢„ç¼–è¾‘æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>final_text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>     </span><span class=c1>// åº”ç”¨ç¨‹åºç»´æŠ¤çš„æœ€ç»ˆæ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>event_loop</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>elwt</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Event</span>::<span class=n>WindowEvent</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>window_id</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>window_id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>window</span><span class=p>.</span><span class=n>id</span><span class=p>()</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>match</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowEvent</span>::<span class=n>Ime</span><span class=p>(</span><span class=n>ime_event</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>match</span><span class=w> </span><span class=n>ime_event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Commit</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME æäº¤äº†æœ€ç»ˆçš„æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=n>final_text</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>text</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>composing_text</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w> </span><span class=c1>// æ¸…ç©ºé¢„ç¼–è¾‘æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Committed: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>text</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Preedit</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>text</span><span class=p>,</span><span class=w> </span><span class=n>cursor</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME æ­£åœ¨è¿›è¡Œé¢„ç¼–è¾‘ï¼Œtext æ˜¯å½“å‰é¢„ç¼–è¾‘çš„å­—ç¬¦ä¸²
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=c1>// cursor æ˜¯ä¸€ä¸ª Option&lt;(start_byte, end_byte)&gt;ï¼Œè¡¨ç¤ºå…‰æ ‡ä½ç½®æˆ–é€‰ä¸­èŒƒå›´
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=n>composing_text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>text</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// åº”ç”¨ç¨‹åºéœ€è¦æ ¹æ® cursor æ¥ç»˜åˆ¶ä¸‹åˆ’çº¿ç­‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Preedit: &#39;</span><span class=si>{}</span><span class=s>&#39;, Cursor: </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>composing_text</span><span class=p>,</span><span class=w> </span><span class=n>cursor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Enabled</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME è¢«å¯ç”¨ (ä¾‹å¦‚ï¼Œç„¦ç‚¹è¿›å…¥äº†æ–‡æœ¬è¾“å…¥æ¡†)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;IME Enabled&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Disabled</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME è¢«ç¦ç”¨ (ä¾‹å¦‚ï¼Œç„¦ç‚¹ç¦»å¼€äº†æ–‡æœ¬è¾“å…¥æ¡†)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;IME Disabled&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>composing_text</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w> </span><span class=c1>// æ¸…ç©ºé¢„ç¼–è¾‘æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowEvent</span>::<span class=n>KeyboardInput</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* ... */</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// å¤„ç†é IME çš„é”®ç›˜è¾“å…¥ï¼Œå¦‚ Backspace, Enter, Ctrl+C ç­‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong><code>Ime::Commit(String)</code></strong>: å½“ç”¨æˆ·åœ¨ IME ä¸­æœ€ç»ˆç¡®è®¤äº†è¾“å…¥ï¼ˆä¾‹å¦‚ï¼ŒæŒ‰å›è½¦é€‰æ‹©äº†å€™é€‰è¯ï¼‰æ—¶è§¦å‘ã€‚<code>text</code> åŒ…å«æœ€ç»ˆè¾“å…¥çš„å­—ç¬¦ä¸²ã€‚</li><li><strong><code>Ime::Preedit { text: String, cursor: Option&lt;(usize, usize)> }</code></strong>: å½“ç”¨æˆ·æ­£åœ¨é€šè¿‡ IME è¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œè¾“å…¥æ‹¼éŸ³æˆ–ç¬”ç”»ï¼‰æ—¶ï¼ŒIME ä¼šå®æ—¶æä¾›å½“å‰çš„é¢„ç¼–è¾‘å­—ç¬¦ä¸²å’Œå…‰æ ‡/é€‰ä¸­åŒºåŸŸä¿¡æ¯ã€‚<code>text</code> æ˜¯é¢„ç¼–è¾‘å­—ç¬¦ä¸²ï¼Œ<code>cursor</code> æ˜¯ä¸€ä¸ªå…ƒç»„ï¼ŒæŒ‡ç¤ºé¢„ç¼–è¾‘å­—ç¬¦ä¸²ä¸­è¢«é€‰ä¸­æˆ–æ­£åœ¨è½¬æ¢çš„åŒºåŸŸçš„å­—èŠ‚èŒƒå›´ã€‚</li><li><strong><code>Ime::Enabled</code> / <code>Ime::Disabled</code></strong>: å½“ IME çŠ¶æ€æ”¹å˜æ—¶è§¦å‘ï¼Œé€šå¸¸åœ¨ä½ è°ƒç”¨ <code>window.set_ime_allowed()</code> æˆ–ç³»ç»Ÿè‡ªåŠ¨å“åº”ç„¦ç‚¹å˜åŒ–æ—¶ã€‚</li></ul><h4 id=b-winit-æä¾›çš„-ime-æ§åˆ¶æ–¹æ³•>B. <code>winit</code> æä¾›çš„ IME æ§åˆ¶æ–¹æ³•</h4><p><code>winit::window::Window</code> å¯¹è±¡ä¸Šæä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œå…è®¸åº”ç”¨ç¨‹åºé€šçŸ¥ <code>winit</code> å½“å‰ IME ç›¸å…³çš„çŠ¶æ€ï¼Œè¿›è€Œå½±å“æ“ä½œç³»ç»Ÿçš„ IME è¡Œä¸ºï¼š</p><ul><li><p><strong><code>window.set_ime_position(&amp;self, x: i32, y: i32)</code></strong>:</p><ul><li>ä½œç”¨ï¼šå‘Šè¯‰æ“ä½œç³»ç»Ÿ IME å€™é€‰çª—å£åº”è¯¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å“ªä¸ªä½ç½®ã€‚<code>x</code> å’Œ <code>y</code> æ˜¯çª—å£åæ ‡ç³»ä¸‹çš„ç‰©ç†åƒç´ åæ ‡ã€‚</li><li>åœ¨ä¸Šé¢çš„ Windows IME ä»£ç ç‰‡æ®µä¸­ï¼Œ<code>set_ime_cursor_area</code> å†…éƒ¨å°±æ˜¯è°ƒç”¨äº†ç±»ä¼¼çš„ <code>ImmSetCompositionWindow</code> å’Œ <code>ImmSetCandidateWindow</code> æ¥è®¾ç½®è¿™äº›ä½ç½®ã€‚</li><li>åº”ç”¨ç¨‹åºä¼šåœ¨æ–‡æœ¬å…‰æ ‡ç§»åŠ¨æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œç¡®ä¿ IME å€™é€‰çª—å£å§‹ç»ˆè·Ÿéšå…‰æ ‡ã€‚</li></ul></li><li><p><strong><code>window.set_ime_allowed(&amp;self, allowed: bool)</code></strong>:</p><ul><li>ä½œç”¨ï¼šæ§åˆ¶è¯¥çª—å£æ˜¯å¦å…è®¸ IME è¾“å…¥ã€‚å½“æ–‡æœ¬è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶é€šå¸¸è®¾ç½®ä¸º <code>true</code>ï¼Œå½“å¤±å»ç„¦ç‚¹æ—¶è®¾ç½®ä¸º <code>false</code>ã€‚</li><li>è¿™å¯¹åº”äºå‰é¢ Windows IME ä»£ç ç‰‡æ®µä¸­çš„ <code>ImmAssociateContextEx</code> è°ƒç”¨ã€‚</li></ul></li></ul><hr><h3 id=2-parley-å¦‚ä½•ä½¿ç”¨-winit-å¯¹åº”çš„-api>2. <code>parley</code> å¦‚ä½•ä½¿ç”¨ <code>winit</code> å¯¹åº”çš„ API</h3><p><strong><code>parley</code> ä½œä¸ºæ–‡æœ¬æ¸²æŸ“åº“ï¼Œå®ƒæœ¬èº«ä¸ç›´æ¥ä½¿ç”¨ <code>winit</code> çš„ IME APIã€‚</strong></p><p><code>parley</code> çš„è§’è‰²æ˜¯<strong>æ¥æ”¶åº”ç”¨ç¨‹åºå‡†å¤‡å¥½çš„æ–‡æœ¬å’Œå¸ƒå±€æŒ‡ä»¤ï¼Œç„¶åç”Ÿæˆå¯ä»¥åœ¨ GPU ä¸Šç»˜åˆ¶çš„å­—å½¢æ•°æ®</strong>ã€‚</p><p><strong>å®é™…çš„å·¥ä½œæµæ˜¯ï¼š</strong></p><ol><li><p><strong><code>winit</code> æ•è· IME äº‹ä»¶</strong> (ä¾‹å¦‚ <code>Ime::Preedit</code> æˆ– <code>Ime::Commit</code>) å¹¶å°†å…¶åˆ†æ´¾ç»™ä½ çš„åº”ç”¨ç¨‹åºã€‚</p></li><li><p><strong>ä½ çš„åº”ç”¨ç¨‹åºé€»è¾‘å¤„ç† <code>winit</code> çš„ IME äº‹ä»¶ï¼š</strong></p><ul><li>å½“æ”¶åˆ° <code>Ime::Preedit { text, cursor }</code> æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šæ›´æ–°ä¸€ä¸ªå†…éƒ¨çš„â€œé¢„ç¼–è¾‘æ–‡æœ¬â€å˜é‡ (<code>composing_text</code>)ï¼Œä»¥åŠå…‰æ ‡/é€‰ä¸­åŒºåŸŸä¿¡æ¯ã€‚</li><li>å½“æ”¶åˆ° <code>Ime::Commit(text)</code> æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šå°†è¿™ä¸ª <code>text</code> è¿½åŠ åˆ°å®ƒçš„â€œæœ€ç»ˆæ–‡æœ¬â€ç¼“å†²åŒº (<code>final_text</code>) ä¸­ï¼Œå¹¶æ¸…ç©ºâ€œé¢„ç¼–è¾‘æ–‡æœ¬â€å˜é‡ã€‚</li><li>åŒæ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šæ ¹æ®æ–‡æœ¬å…‰æ ‡çš„ä½ç½®ï¼Œè®¡ç®—å‡ºè¯¥å…‰æ ‡åœ¨å±å¹•ä¸Šçš„ç‰©ç†åæ ‡ï¼Œå¹¶è°ƒç”¨ <code>window.set_ime_position(x, y)</code> å‘Šè¯‰ <code>winit</code>ï¼ˆä»è€Œå‘Šè¯‰æ“ä½œç³»ç»Ÿ IMEï¼‰å€™é€‰çª—å£åº”è¯¥æ˜¾ç¤ºåœ¨å“ªé‡Œã€‚</li></ul></li><li><p><strong>ä½ çš„åº”ç”¨ç¨‹åºå°†ç»„åˆåçš„æ–‡æœ¬ä¼ é€’ç»™ <code>parley</code> è¿›è¡Œæ¸²æŸ“ï¼š</strong></p><ul><li>åœ¨æ¯ä¸€å¸§æ¸²æŸ“æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šå°† <code>final_text</code> å’Œ <code>composing_text</code> ç»„åˆèµ·æ¥ã€‚</li><li>å®ƒä¼šå°†ç»„åˆåçš„å®Œæ•´å­—ç¬¦ä¸²ä¼ é€’ç»™ <code>parley</code>ã€‚</li><li>åº”ç”¨ç¨‹åºè¿˜ä¼šå‘Šè¯‰ <code>parley</code> å¦‚ä½•æ¸²æŸ“ <code>composing_text</code> éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š<ul><li>æä¾›é¢å¤–çš„æ ·å¼ä¿¡æ¯ç»™ <code>parley</code>ï¼Œä¾‹å¦‚è®© <code>parley</code> åœ¨é¢„ç¼–è¾‘æ–‡æœ¬ä¸‹æ–¹ç»˜åˆ¶ä¸€ä¸ªä¸‹åˆ’çº¿ã€‚</li><li><code>parley</code> ä¼šæ ¹æ®è¿™äº›æ ·å¼ä¿¡æ¯è¿›è¡Œæ–‡æœ¬å¸ƒå±€å’Œå­—å½¢æ¸²æŸ“ã€‚</li></ul></li><li><code>parley</code> æ¥æ”¶åˆ°è¿™äº›ä¿¡æ¯åï¼Œå°±ä¼šè®¡ç®—å‡ºæ‰€æœ‰å­—å½¢çš„ä½ç½®å’Œå½¢çŠ¶ï¼Œå¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚</li><li>åº”ç”¨ç¨‹åºæ‹¿åˆ° <code>parley</code> è¿”å›çš„å­—å½¢æ•°æ®åï¼Œå†ä½¿ç”¨å›¾å½¢ API (å¦‚ Vulkan, OpenGL, wgpu ç­‰) å°†å…¶ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</li></ul></li></ol><p><strong>ç®€åŒ–çš„æ•°æ®æµï¼š</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ç”¨æˆ·è¾“å…¥ (é€šè¿‡ IME)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>winit (æ•è· OS IME äº‹ä»¶)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>åº”ç”¨ç¨‹åºäº‹ä»¶å¾ªç¯ (å¤„ç† winit::event::Ime äº‹ä»¶)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>åº”ç”¨ç¨‹åºçŠ¶æ€ (æ›´æ–° final_text, composing_text, cursor_pos)
</span></span><span class=line><span class=cl>    â†“ (æ ¹æ® cursor_pos è°ƒç”¨)
</span></span><span class=line><span class=cl>winit.set_ime_position() --- é€šçŸ¥ OS IME çª—å£ä½ç½®
</span></span><span class=line><span class=cl>    â†“ (å°† final_text + composing_text ç»„åˆ)
</span></span><span class=line><span class=cl>parley (è¿›è¡Œæ–‡æœ¬å¸ƒå±€å’Œå­—å½¢æ¸²æŸ“ï¼Œæ ¹æ®åº”ç”¨ç¨‹åºæä¾›çš„æ ·å¼æ¸²æŸ“ composing_text çš„ä¸‹åˆ’çº¿ç­‰)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>åº”ç”¨ç¨‹åºå›¾å½¢æ¸²æŸ“å±‚ (ç»˜åˆ¶å­—å½¢åˆ°å±å¹•)
</span></span></code></pre></div><p>å› æ­¤ï¼Œ<code>parley</code> å¹¶ä¸ç›´æ¥ä¸ IME æˆ– <code>winit</code> äº¤äº’ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªé«˜æ•ˆçš„â€œç»˜å›¾å‘˜â€ï¼Œå¬ä»åº”ç”¨ç¨‹åºçš„æŒ‡ç¤ºæ¥æ¸²æŸ“æ–‡æœ¬ã€‚æ‰€æœ‰çš„ IME é€»è¾‘å’Œä¸ <code>winit</code> çš„äº¤äº’éƒ½å‘ç”Ÿåœ¨åº”ç”¨ç¨‹åºçš„å±‚é¢ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>winit</span>::<span class=n>event</span>::<span class=p>{</span><span class=n>Event</span><span class=p>,</span><span class=w> </span><span class=n>WindowEvent</span><span class=p>,</span><span class=w> </span><span class=n>Ime</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ... å…¶ä»–useå£°æ˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>event_loop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EventLoop</span>::<span class=n>new</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowBuilder</span>::<span class=n>new</span><span class=p>().</span><span class=n>build</span><span class=p>(</span><span class=o>&amp;</span><span class=n>event_loop</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>composing_text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w> </span><span class=c1>// åº”ç”¨ç¨‹åºç»´æŠ¤çš„é¢„ç¼–è¾‘æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>final_text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>     </span><span class=c1>// åº”ç”¨ç¨‹åºç»´æŠ¤çš„æœ€ç»ˆæ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>event_loop</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>elwt</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Event</span>::<span class=n>WindowEvent</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>window_id</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>window_id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>window</span><span class=p>.</span><span class=n>id</span><span class=p>()</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>match</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowEvent</span>::<span class=n>Ime</span><span class=p>(</span><span class=n>ime_event</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>match</span><span class=w> </span><span class=n>ime_event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Commit</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME æäº¤äº†æœ€ç»ˆçš„æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=n>final_text</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>text</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>composing_text</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w> </span><span class=c1>// æ¸…ç©ºé¢„ç¼–è¾‘æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Committed: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>text</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Preedit</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>text</span><span class=p>,</span><span class=w> </span><span class=n>cursor</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME æ­£åœ¨è¿›è¡Œé¢„ç¼–è¾‘ï¼Œtext æ˜¯å½“å‰é¢„ç¼–è¾‘çš„å­—ç¬¦ä¸²
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=c1>// cursor æ˜¯ä¸€ä¸ª Option&lt;(start_byte, end_byte)&gt;ï¼Œè¡¨ç¤ºå…‰æ ‡ä½ç½®æˆ–é€‰ä¸­èŒƒå›´
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=n>composing_text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>text</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// åº”ç”¨ç¨‹åºéœ€è¦æ ¹æ® cursor æ¥ç»˜åˆ¶ä¸‹åˆ’çº¿ç­‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Preedit: &#39;</span><span class=si>{}</span><span class=s>&#39;, Cursor: </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>composing_text</span><span class=p>,</span><span class=w> </span><span class=n>cursor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Enabled</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME è¢«å¯ç”¨ (ä¾‹å¦‚ï¼Œç„¦ç‚¹è¿›å…¥äº†æ–‡æœ¬è¾“å…¥æ¡†)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;IME Enabled&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Ime</span>::<span class=n>Disabled</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// IME è¢«ç¦ç”¨ (ä¾‹å¦‚ï¼Œç„¦ç‚¹ç¦»å¼€äº†æ–‡æœ¬è¾“å…¥æ¡†)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;IME Disabled&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>composing_text</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w> </span><span class=c1>// æ¸…ç©ºé¢„ç¼–è¾‘æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowEvent</span>::<span class=n>KeyboardInput</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* ... */</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// å¤„ç†é IME çš„é”®ç›˜è¾“å…¥ï¼Œå¦‚ Backspace, Enter, Ctrl+C ç­‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>ç”¨æˆ·è¾“å…¥ (é€šè¿‡ IME)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>winit (æ•è· OS IME äº‹ä»¶)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>åº”ç”¨ç¨‹åºäº‹ä»¶å¾ªç¯ (å¤„ç† winit::event::Ime äº‹ä»¶)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>åº”ç”¨ç¨‹åºçŠ¶æ€ (æ›´æ–° final_text, composing_text, cursor_pos)
</span></span><span class=line><span class=cl>    â†“ (æ ¹æ® cursor_pos è°ƒç”¨)
</span></span><span class=line><span class=cl>winit.set_ime_position() --- é€šçŸ¥ OS IME çª—å£ä½ç½®
</span></span><span class=line><span class=cl>    â†“ (å°† final_text + composing_text ç»„åˆ)
</span></span><span class=line><span class=cl>parley (è¿›è¡Œæ–‡æœ¬å¸ƒå±€å’Œå­—å½¢æ¸²æŸ“ï¼Œæ ¹æ®åº”ç”¨ç¨‹åºæä¾›çš„æ ·å¼æ¸²æŸ“ composing_text çš„ä¸‹åˆ’çº¿ç­‰)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>åº”ç”¨ç¨‹åºå›¾å½¢æ¸²æŸ“å±‚ (ç»˜åˆ¶å­—å½¢åˆ°å±å¹•)
</span></span></code></pre></div><hr><p><strong>User</strong></p><p>// Copyright 2024 the Parley Authors
// SPDX-License-Identifier: Apache-2.0 OR MIT</p><p>//! A simple plain text editor and related types.</p><p>use crate::{
FontContext, LayoutContext, Rect, StyleProperty, StyleSet,
layout::{
Affinity, Alignment, AlignmentOptions, Layout,
cursor::{Cursor, Selection},
},
resolve::ResolvedStyle,
style::Brush,
};
use alloc::{borrow::ToOwned, string::String, vec::Vec};
use core::{
cmp::PartialEq,
default::Default,
fmt::{Debug, Display},
num::NonZeroUsize,
ops::Range,
};</p><p>#[cfg(feature = &ldquo;accesskit&rdquo;)]
use crate::layout::LayoutAccessibility;
#[cfg(feature = &ldquo;accesskit&rdquo;)]
use accesskit::{Node, NodeId, TreeUpdate};</p><p>/// Opaque representation of a generation.
///
/// Obtained from [<code>PlainEditor::generation</code>].
// Overflow handling: the generations are only compared,
// so wrapping is fine. This could only fail if exactly
// <code>u32::MAX</code> generations happen between drawing
// operations. This is implausible and so can be ignored.
#[derive(PartialEq, Eq, Default, Clone, Copy)]
pub struct Generation(u32);</p><p>impl Generation {
/// Make it not what it currently is.
pub(crate) fn nudge(&amp;mut self) {
self.0 = self.0.wrapping_add(1);
}
}</p><p>/// A string which is potentially discontiguous in memory.
///
/// This is returned by [<code>PlainEditor::text</code>], as the IME preedit
/// area needs to be efficiently excluded from its return value.
#[derive(Debug, Clone, Copy)]
pub struct SplitString&lt;&lsquo;source>([&&lsquo;source str; 2]);</p><p>impl&lt;&lsquo;source> SplitString&lt;&lsquo;source> {
/// Get the characters of this string.
pub fn chars(self) -> impl Iterator&lt;Item = char> + &lsquo;source {
self.into_iter().flat_map(str::chars)
}
}</p><p>impl PartialEq&lt;&&rsquo;_ str> for SplitString&lt;&rsquo;<em>> {
fn eq(&amp;self, other: &&&rsquo;</em> str) -> bool {
let [a, b] = self.0;
let mid = a.len();
// When our MSRV is 1.80 or above, use split_at_checked instead.
// is_char_boundary checks bounds
let (a_1, b_1) = if other.is_char_boundary(mid) {
other.split_at(mid)
} else {
return false;
};</p><pre><code>    a_1 == a &amp;&amp; b_1 == b
}
</code></pre><p>}
// We intentionally choose not to:
// impl PartialEq<self> for SplitString&lt;&rsquo;_> {}
// for simplicity, as the impl wouldn&rsquo;t be useful and is non-trivial</p><p>impl Display for SplitString&lt;&rsquo;<em>> {
fn fmt(&amp;self, f: &amp;mut core::fmt::Formatter&lt;&rsquo;</em>>) -> core::fmt::Result {
let [a, b] = self.0;
write!(f, &ldquo;{a}{b}&rdquo;)
}
}</p><p>/// Iterate through the source strings.
impl&lt;&lsquo;source> IntoIterator for SplitString&lt;&lsquo;source> {
type Item = &&lsquo;source str;
type IntoIter = &lt;[&&lsquo;source str; 2] as IntoIterator>::IntoIter;
fn into_iter(self) -> Self::IntoIter {
self.0.into_iter()
}
}</p><p>/// Basic plain text editor with a single style applied to the entire text.
///
/// Internally, this is a wrapper around a string buffer and its corresponding [<code>Layout</code>],
/// which is kept up-to-date as needed.
/// This layout is invalidated by a number.
#[derive(Clone)]
pub struct PlainEditor<t>
where
T: Brush + Clone + Debug + PartialEq + Default,
{
layout: Layout<t>,
buffer: String,
default_style: StyleSet<t>,
#[cfg(feature = &ldquo;accesskit&rdquo;)]
layout_access: LayoutAccessibility,
selection: Selection,
/// Byte offsets of IME composing preedit text in the text buffer.
/// <code>None</code> if the IME is not currently composing.
compose: Option&lt;Range<usize>>,
/// Whether the cursor should be shown. The IME can request to hide the cursor.
show_cursor: bool,
width: Option<f32>,
scale: f32,
quantize: bool,
// Simple tracking of when the layout needs to be updated
// before it can be used for <code>Selection</code> calculations or
// for drawing.
// Not all operations on <code>PlainEditor</code> need to operate on a
// clean layout, and not all operations trigger a layout.
layout_dirty: bool,
// TODO: We could avoid redoing the full text layout if only
// linebreaking or alignment were changed.
// linebreak_dirty: bool,
// alignment_dirty: bool,
alignment: Alignment,
generation: Generation,
}</p><p>impl<t> PlainEditor<t>
where
T: Brush,
{
/// Create a new editor, with default font size <code>font_size</code>.
pub fn new(font_size: f32) -> Self {
Self {
default_style: StyleSet::new(font_size),
buffer: Default::default(),
layout: Default::default(),
#[cfg(feature = &ldquo;accesskit&rdquo;)]
layout_access: Default::default(),
selection: Default::default(),
compose: None,
show_cursor: true,
width: None,
scale: 1.0,
quantize: true,
layout_dirty: true,
alignment: Alignment::Start,
// We don&rsquo;t use the <code>default</code> value to start with, as our consumers
// will choose to use that as their initial value, but will probably need
// to redraw if they haven&rsquo;t already.
generation: Generation(1),
}
}
}</p><p>/// A short-lived wrapper around [<code>PlainEditor</code>].
///
/// This can perform operations which require the editor&rsquo;s layout to
/// be up-to-date by refreshing it as necessary.
pub struct PlainEditorDriver&lt;&lsquo;a, T>
where
T: Brush + Clone + Debug + PartialEq + Default,
{
pub editor: &&lsquo;a mut PlainEditor<t>,
pub font_cx: &&lsquo;a mut FontContext,
pub layout_cx: &&lsquo;a mut LayoutContext<t>,
}</p><p>impl<t> PlainEditorDriver&lt;&rsquo;_, T>
where
T: Brush + Clone + Debug + PartialEq + Default,
{
// &mdash; MARK: Forced relayout &mdash;
/// Insert at cursor, or replace selection.
pub fn insert_or_replace_selection(&amp;mut self, s: &amp;str) {
self.editor
.replace_selection(self.font_cx, self.layout_cx, s);
}</p><pre><code>/// Delete the selection.
pub fn delete_selection(&amp;mut self) {
    self.insert_or_replace_selection(&quot;&quot;);
}

/// Delete the specified numbers of bytes before the selection.
/// The selection is moved to the left by that number of bytes
/// but otherwise unchanged.
///
/// The deleted range is clamped to the start of the buffer.
/// No-op if the start of the range is not a char boundary.
pub fn delete_bytes_before_selection(&amp;mut self, len: NonZeroUsize) {
    let old_selection = self.editor.selection;
    let selection_range = old_selection.text_range();
    let range = selection_range.start.saturating_sub(len.get())..selection_range.start;
    if range.is_empty() || !self.editor.buffer.is_char_boundary(range.start) {
        return;
    }
    self.editor.buffer.replace_range(range.clone(), &quot;&quot;);
    self.editor
        .update_compose_for_replaced_range(range.clone(), 0);
    self.update_layout();
    let old_anchor = old_selection.anchor();
    let old_focus = old_selection.focus();
    // When doing the equivalent of a backspace on a collapsed selection,
    // always use downstream affinity, as `backdelete` does.
    let (anchor_affinity, focus_affinity) = if old_selection.is_collapsed() {
        (Affinity::Downstream, Affinity::Downstream)
    } else {
        (old_anchor.affinity(), old_focus.affinity())
    };
    self.editor.set_selection(Selection::new(
        Cursor::from_byte_index(
            &amp;self.editor.layout,
            old_anchor.index() - range.len(),
            anchor_affinity,
        ),
        Cursor::from_byte_index(
            &amp;self.editor.layout,
            old_focus.index() - range.len(),
            focus_affinity,
        ),
    ));
}

/// Delete the specified numbers of bytes after the selection.
/// The selection is unchanged.
///
/// The deleted range is clamped to the end of the buffer.
/// No-op if the end of the range is not a char boundary.
pub fn delete_bytes_after_selection(&amp;mut self, len: NonZeroUsize) {
    let selection_range = self.editor.selection.text_range();
    let range = selection_range.end
        ..selection_range
            .end
            .saturating_add(len.get())
            .min(self.editor.buffer.len());
    if range.is_empty() || !self.editor.buffer.is_char_boundary(range.end) {
        return;
    }
    self.editor.buffer.replace_range(range.clone(), &quot;&quot;);
    self.editor.update_compose_for_replaced_range(range, 0);
    self.update_layout();
}

/// Delete the selection or the next cluster (typical â€˜deleteâ€™ behavior).
pub fn delete(&amp;mut self) {
    if self.editor.selection.is_collapsed() {
        // Upstream cluster range
        if let Some(range) = self
            .editor
            .selection
            .focus()
            .logical_clusters(&amp;self.editor.layout)[1]
            .as_ref()
            .map(|cluster| cluster.text_range())
            .and_then(|range| (!range.is_empty()).then_some(range))
        {
            self.editor.buffer.replace_range(range.clone(), &quot;&quot;);
            self.editor.update_compose_for_replaced_range(range, 0);
            self.update_layout();
        }
    } else {
        self.delete_selection();
    }
}

/// Delete the selection or up to the next word boundary (typical â€˜ctrl + deleteâ€™ behavior).
pub fn delete_word(&amp;mut self) {
    if self.editor.selection.is_collapsed() {
        let focus = self.editor.selection.focus();
        let start = focus.index();
        let end = focus.next_logical_word(&amp;self.editor.layout).index();
        if self.editor.buffer.get(start..end).is_some() {
            self.editor.buffer.replace_range(start..end, &quot;&quot;);
            self.editor.update_compose_for_replaced_range(start..end, 0);
            self.update_layout();
            self.editor.set_selection(
                Cursor::from_byte_index(&amp;self.editor.layout, start, Affinity::Downstream)
                    .into(),
            );
        }
    } else {
        self.delete_selection();
    }
}

/// Delete the selection or the previous cluster (typical â€˜backspaceâ€™ behavior).
pub fn backdelete(&amp;mut self) {
    if self.editor.selection.is_collapsed() {
        // Upstream cluster
        if let Some(cluster) = self
            .editor
            .selection
            .focus()
            .logical_clusters(&amp;self.editor.layout)[0]
            .clone()
        {
            let range = cluster.text_range();
            let end = range.end;
            let start = if cluster.is_hard_line_break() || cluster.is_emoji() {
                // For newline sequences and emoji, delete the previous cluster
                range.start
            } else {
                // Otherwise, delete the previous character
                let Some((start, _)) = self
                    .editor
                    .buffer
                    .get(..end)
                    .and_then(|str| str.char_indices().next_back())
                else {
                    return;
                };
                start
            };
            self.editor.buffer.replace_range(start..end, &quot;&quot;);
            self.editor.update_compose_for_replaced_range(start..end, 0);
            self.update_layout();
            self.editor.set_selection(
                Cursor::from_byte_index(&amp;self.editor.layout, start, Affinity::Downstream)
                    .into(),
            );
        }
    } else {
        self.delete_selection();
    }
}

/// Delete the selection or back to the previous word boundary (typical â€˜ctrl + backspaceâ€™ behavior).
pub fn backdelete_word(&amp;mut self) {
    if self.editor.selection.is_collapsed() {
        let focus = self.editor.selection.focus();
        let end = focus.index();
        let start = focus.previous_logical_word(&amp;self.editor.layout).index();
        if self.editor.buffer.get(start..end).is_some() {
            self.editor.buffer.replace_range(start..end, &quot;&quot;);
            self.editor.update_compose_for_replaced_range(start..end, 0);
            self.update_layout();
            self.editor.set_selection(
                Cursor::from_byte_index(&amp;self.editor.layout, start, Affinity::Downstream)
                    .into(),
            );
        }
    } else {
        self.delete_selection();
    }
}

// --- MARK: IME ---
/// Set the IME preedit composing text.
///
/// This starts composing. Composing is reset by calling [`clear_compose`](Self::clear_compose).
/// Alternatively, the preedit text can be committed by calling [`finish_compose`](Self::finish_compose).
///
/// The selection and preedit region can be manipulated independently while composing
/// is active.
///
/// The preedit text replaces the current selection if this call starts composing.
///
/// The selection is updated based on `cursor`, which contains the byte offsets relative to the
/// start of the preedit text. If `cursor` is `None`, the selection and caret are hidden.
pub fn set_compose(&amp;mut self, text: &amp;str, cursor: Option&lt;(usize, usize)&gt;) {
    debug_assert!(!text.is_empty());
    debug_assert!(cursor.map(|cursor| cursor.1 &lt;= text.len()).unwrap_or(true));

    let start = if let Some(preedit_range) = &amp;self.editor.compose {
        self.editor
            .buffer
            .replace_range(preedit_range.clone(), text);
        preedit_range.start
    } else {
        if self.editor.selection.is_collapsed() {
            self.editor
                .buffer
                .insert_str(self.editor.selection.text_range().start, text);
        } else {
            self.editor
                .buffer
                .replace_range(self.editor.selection.text_range(), text);
        }
        self.editor.selection.text_range().start
    };
    self.editor.compose = Some(start..start + text.len());
    self.editor.show_cursor = cursor.is_some();
    self.update_layout();

    // Select the location indicated by the IME. If `cursor` is none, collapse the selection to
    // a caret at the start of the preedit text. As `self.editor.show_cursor` is `false`, it
    // won't show up.
    let cursor = cursor.unwrap_or((0, 0));
    self.editor.set_selection(Selection::new(
        self.editor.cursor_at(start + cursor.0),
        self.editor.cursor_at(start + cursor.1),
    ));
}

/// Set the preedit range to a range of byte indices.
/// This leaves the selection and cursor unchanged.
///
/// No-op if either index is not a char boundary.
pub fn set_compose_byte_range(&amp;mut self, start: usize, end: usize) {
    if self.editor.buffer.is_char_boundary(start) &amp;&amp; self.editor.buffer.is_char_boundary(end) {
        self.editor.compose = Some(start..end);
        self.update_layout();
    }
}

/// Stop IME composing.
///
/// This removes the IME preedit text, shows the cursor if it was hidden,
/// and moves the cursor to the start of the former preedit region.
pub fn clear_compose(&amp;mut self) {
    if let Some(preedit_range) = self.editor.compose.take() {
        self.editor.buffer.replace_range(preedit_range.clone(), &quot;&quot;);
        self.editor.show_cursor = true;
        self.update_layout();

        self.editor
            .set_selection(self.editor.cursor_at(preedit_range.start).into());
    }
}

/// Commit the IME preedit text, if any.
///
/// This doesn't change the selection, but shows the cursor if
/// it was hidden.
pub fn finish_compose(&amp;mut self) {
    if self.editor.compose.take().is_some() {
        self.editor.show_cursor = true;
        self.update_layout();
    }
}

// --- MARK: Cursor Movement ---
/// Move the cursor to the cluster boundary nearest this point in the layout.
pub fn move_to_point(&amp;mut self, x: f32, y: f32) {
    self.refresh_layout();
    self.editor
        .set_selection(Selection::from_point(&amp;self.editor.layout, x, y));
}

/// Move the cursor to a byte index.
///
/// No-op if index is not a char boundary.
pub fn move_to_byte(&amp;mut self, index: usize) {
    if self.editor.buffer.is_char_boundary(index) {
        self.refresh_layout();
        self.editor
            .set_selection(self.editor.cursor_at(index).into());
    }
}

/// Move the cursor to the start of the buffer.
pub fn move_to_text_start(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(self.editor.selection.move_lines(
        &amp;self.editor.layout,
        isize::MIN,
        false,
    ));
}

/// Move the cursor to the start of the physical line.
pub fn move_to_line_start(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.line_start(&amp;self.editor.layout, false));
}

/// Move the cursor to the end of the buffer.
pub fn move_to_text_end(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(self.editor.selection.move_lines(
        &amp;self.editor.layout,
        isize::MAX,
        false,
    ));
}

/// Move the cursor to the end of the physical line.
pub fn move_to_line_end(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.line_end(&amp;self.editor.layout, false));
}

/// Move up to the closest physical cluster boundary on the previous line, preserving the horizontal position for repeated movements.
pub fn move_up(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .previous_line(&amp;self.editor.layout, false),
    );
}

/// Move down to the closest physical cluster boundary on the next line, preserving the horizontal position for repeated movements.
pub fn move_down(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.next_line(&amp;self.editor.layout, false));
}

/// Move to the next cluster left in visual order.
pub fn move_left(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .previous_visual(&amp;self.editor.layout, false),
    );
}

/// Move to the next cluster right in visual order.
pub fn move_right(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .next_visual(&amp;self.editor.layout, false),
    );
}

/// Move to the next word boundary left.
pub fn move_word_left(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .previous_visual_word(&amp;self.editor.layout, false),
    );
}

/// Move to the next word boundary right.
pub fn move_word_right(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .next_visual_word(&amp;self.editor.layout, false),
    );
}

/// Select the whole buffer.
pub fn select_all(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        Selection::from_byte_index(&amp;self.editor.layout, 0_usize, Affinity::default())
            .move_lines(&amp;self.editor.layout, isize::MAX, true),
    );
}

/// Collapse selection into caret.
pub fn collapse_selection(&amp;mut self) {
    self.editor.set_selection(self.editor.selection.collapse());
}

/// Move the selection focus point to the start of the buffer.
pub fn select_to_text_start(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(self.editor.selection.move_lines(
        &amp;self.editor.layout,
        isize::MIN,
        true,
    ));
}

/// Move the selection focus point to the start of the physical line.
pub fn select_to_line_start(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.line_start(&amp;self.editor.layout, true));
}

/// Move the selection focus point to the end of the buffer.
pub fn select_to_text_end(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(self.editor.selection.move_lines(
        &amp;self.editor.layout,
        isize::MAX,
        true,
    ));
}

/// Move the selection focus point to the end of the physical line.
pub fn select_to_line_end(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.line_end(&amp;self.editor.layout, true));
}

/// Move the selection focus point up to the nearest cluster boundary on the previous line, preserving the horizontal position for repeated movements.
pub fn select_up(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .previous_line(&amp;self.editor.layout, true),
    );
}

/// Move the selection focus point down to the nearest cluster boundary on the next line, preserving the horizontal position for repeated movements.
pub fn select_down(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.next_line(&amp;self.editor.layout, true));
}

/// Move the selection focus point to the next cluster left in visual order.
pub fn select_left(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .previous_visual(&amp;self.editor.layout, true),
    );
}

/// Move the selection focus point to the next cluster right in visual order.
pub fn select_right(&amp;mut self) {
    self.refresh_layout();
    self.editor
        .set_selection(self.editor.selection.next_visual(&amp;self.editor.layout, true));
}

/// Move the selection focus point to the next word boundary left.
pub fn select_word_left(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .previous_visual_word(&amp;self.editor.layout, true),
    );
}

/// Move the selection focus point to the next word boundary right.
pub fn select_word_right(&amp;mut self) {
    self.refresh_layout();
    self.editor.set_selection(
        self.editor
            .selection
            .next_visual_word(&amp;self.editor.layout, true),
    );
}

/// Select the word at the point.
pub fn select_word_at_point(&amp;mut self, x: f32, y: f32) {
    self.refresh_layout();
    self.editor
        .set_selection(Selection::word_from_point(&amp;self.editor.layout, x, y));
}

/// Select the physical line at the point.
pub fn select_line_at_point(&amp;mut self, x: f32, y: f32) {
    self.refresh_layout();
    let line = Selection::line_from_point(&amp;self.editor.layout, x, y);
    self.editor.set_selection(line);
}

/// Move the selection focus point to the cluster boundary closest to point.
pub fn extend_selection_to_point(&amp;mut self, x: f32, y: f32) {
    self.refresh_layout();
    // FIXME: This is usually the wrong way to handle selection extension for mouse moves, but not a regression.
    self.editor.set_selection(
        self.editor
            .selection
            .extend_to_point(&amp;self.editor.layout, x, y),
    );
}

/// Move the selection focus point to a byte index.
///
/// No-op if index is not a char boundary.
pub fn extend_selection_to_byte(&amp;mut self, index: usize) {
    if self.editor.buffer.is_char_boundary(index) {
        self.refresh_layout();
        self.editor
            .set_selection(self.editor.selection.extend(self.editor.cursor_at(index)));
    }
}

/// Select a range of byte indices.
///
/// No-op if either index is not a char boundary.
pub fn select_byte_range(&amp;mut self, start: usize, end: usize) {
    if self.editor.buffer.is_char_boundary(start) &amp;&amp; self.editor.buffer.is_char_boundary(end) {
        self.refresh_layout();
        self.editor.set_selection(Selection::new(
            self.editor.cursor_at(start),
            self.editor.cursor_at(end),
        ));
    }
}

#[cfg(feature = &quot;accesskit&quot;)]
/// Select inside the editor based on the selection provided by accesskit.
pub fn select_from_accesskit(&amp;mut self, selection: &amp;accesskit::TextSelection) {
    self.refresh_layout();
    if let Some(selection) = Selection::from_access_selection(
        selection,
        &amp;self.editor.layout,
        &amp;self.editor.layout_access,
    ) {
        self.editor.set_selection(selection);
    }
}

// --- MARK: Rendering ---
#[cfg(feature = &quot;accesskit&quot;)]
/// Perform an accessibility update.
pub fn accessibility(
    &amp;mut self,
    update: &amp;mut TreeUpdate,
    node: &amp;mut Node,
    next_node_id: impl FnMut() -&gt; NodeId,
    x_offset: f64,
    y_offset: f64,
) -&gt; Option&lt;()&gt; {
    self.refresh_layout();
    self.editor
        .accessibility_unchecked(update, node, next_node_id, x_offset, y_offset);
    Some(())
}

/// Get the up-to-date layout for this driver.
pub fn layout(&amp;mut self) -&gt; &amp;Layout&lt;T&gt; {
    self.editor.layout(self.font_cx, self.layout_cx)
}

// --- MARK: Internal helpers---
/// Update the layout if needed.
pub fn refresh_layout(&amp;mut self) {
    self.editor.refresh_layout(self.font_cx, self.layout_cx);
}

/// Update the layout unconditionally.
fn update_layout(&amp;mut self) {
    self.editor.update_layout(self.font_cx, self.layout_cx);
}
</code></pre><p>}</p><p>impl<t> PlainEditor<t>
where
T: Brush + Clone + Debug + PartialEq + Default,
{
/// Run a series of [<code>PlainEditorDriver</code>] methods.
///
/// This type is only used to simplify methods which require both
/// the editor and the provided contexts.
pub fn driver&lt;&lsquo;drv>(
&&lsquo;drv mut self,
font_cx: &&lsquo;drv mut FontContext,
layout_cx: &&lsquo;drv mut LayoutContext<t>,
) -> PlainEditorDriver&lt;&lsquo;drv, T> {
PlainEditorDriver {
editor: self,
font_cx,
layout_cx,
}
}</p><pre><code>/// Borrow the current selection. The indices returned by functions
/// such as [`Selection::text_range`] refer to the raw text buffer,
/// including the IME preedit region, which can be accessed via
/// [`PlainEditor::raw_text`].
pub fn raw_selection(&amp;self) -&gt; &amp;Selection {
    &amp;self.selection
}

/// Borrow the current IME preedit range, if any. These indices refer
/// to the raw text buffer, which can be accessed via [`PlainEditor::raw_text`].
pub fn raw_compose(&amp;self) -&gt; &amp;Option&lt;Range&lt;usize&gt;&gt; {
    &amp;self.compose
}

/// If the current selection is not collapsed, returns the text content of
/// that selection.
pub fn selected_text(&amp;self) -&gt; Option&lt;&amp;str&gt; {
    if self.is_composing() {
        return None;
    }
    if !self.selection.is_collapsed() {
        self.buffer.get(self.selection.text_range())
    } else {
        None
    }
}

/// Get rectangles, and their corresponding line indices, representing the selected portions of
/// text.
pub fn selection_geometry(&amp;self) -&gt; Vec&lt;(Rect, usize)&gt; {
    // We do not check `self.show_cursor` here, as the IME handling code collapses the
    // selection to a caret in that case.
    self.selection.geometry(&amp;self.layout)
}

/// Invoke a callback with each rectangle representing the selected portions of text, and the
/// indices of the lines to which they belong.
pub fn selection_geometry_with(&amp;self, f: impl FnMut(Rect, usize)) {
    // We do not check `self.show_cursor` here, as the IME handling code collapses the
    // selection to a caret in that case.
    self.selection.geometry_with(&amp;self.layout, f);
}

/// Get a rectangle representing the current caret cursor position.
///
/// There is not always a caret. For example, the IME may have indicated the caret should be
/// hidden.
pub fn cursor_geometry(&amp;self, size: f32) -&gt; Option&lt;Rect&gt; {
    self.show_cursor
        .then(|| self.selection.focus().geometry(&amp;self.layout, size))
}

/// Get a rectangle bounding the text the user is currently editing.
///
/// This is useful for suggesting an exclusion area to the platform for, e.g., IME candidate
/// box placement. This bounds the area of the preedit text if present, otherwise it bounds the
/// selection on the focused line.
pub fn ime_cursor_area(&amp;self) -&gt; Rect {
    let (area, focus) = if let Some(preedit_range) = &amp;self.compose {
        let selection = Selection::new(
            self.cursor_at(preedit_range.start),
            self.cursor_at(preedit_range.end),
        );

        // Bound the entire preedit text.
        let mut area = None;
        selection.geometry_with(&amp;self.layout, |rect, _| {
            let area = area.get_or_insert(rect);
            *area = area.union(rect);
        });

        (
            area.unwrap_or_else(|| selection.focus().geometry(&amp;self.layout, 0.)),
            selection.focus(),
        )
    } else {
        // Bound the selected parts of the focused line only.
        let focus = self.selection.focus().geometry(&amp;self.layout, 0.);
        let mut area = focus;
        self.selection.geometry_with(&amp;self.layout, |rect, _| {
            if rect.y0 == focus.y0 {
                area = area.union(rect);
            }
        });

        (area, self.selection.focus())
    };

    // Ensure some context is captured even for tiny or collapsed selections by including a
    // region surrounding the selection. Doing this unconditionally, the IME candidate box
    // usually does not need to jump around when composing starts or the preedit is added to.
    let [upstream, downstream] = focus.logical_clusters(&amp;self.layout);
    let font_size = downstream
        .or(upstream)
        .map(|cluster| cluster.run().font_size())
        .unwrap_or(ResolvedStyle::&lt;T&gt;::default().font_size);
    // Using 0.6 as an estimate of the average advance
    let inflate = 3. * 0.6 * font_size as f64;
    let editor_width = self.width.map(f64::from).unwrap_or(f64::INFINITY);
    Rect {
        x0: (area.x0 - inflate).max(0.),
        x1: (area.x1 + inflate).min(editor_width),
        y0: area.y0,
        y1: area.y1,
    }
}

/// Borrow the text content of the buffer.
///
/// The return value is a `SplitString` because it
/// excludes the IME preedit region.
pub fn text(&amp;self) -&gt; SplitString&lt;'_&gt; {
    if let Some(preedit_range) = &amp;self.compose {
        SplitString([
            &amp;self.buffer[..preedit_range.start],
            &amp;self.buffer[preedit_range.end..],
        ])
    } else {
        SplitString([&amp;self.buffer, &quot;&quot;])
    }
}

/// Borrow the text content of the buffer, including the IME preedit
/// region if any.
///
/// Application authors should generally prefer [`text`](Self::text). That method excludes the
/// IME preedit contents, which are not meaningful for applications to access; the
/// in-progress IME content is not itself what the user intends to write.
pub fn raw_text(&amp;self) -&gt; &amp;str {
    &amp;self.buffer
}

/// Get the current `Generation` of the layout, to decide whether to draw.
///
/// You should store the generation the editor was at when you last drew it, and then redraw
/// when the generation is different (`Generation` is [`PartialEq`], so supports the equality `==` operation).
pub fn generation(&amp;self) -&gt; Generation {
    self.generation
}

/// Replace the whole text buffer.
pub fn set_text(&amp;mut self, is: &amp;str) {
    self.buffer.clear();
    self.buffer.push_str(is);
    self.layout_dirty = true;
    self.compose = None;
}

/// Set the width of the layout.
pub fn set_width(&amp;mut self, width: Option&lt;f32&gt;) {
    self.width = width;
    self.layout_dirty = true;
}

/// Set the alignment of the layout.
pub fn set_alignment(&amp;mut self, alignment: Alignment) {
    self.alignment = alignment;
    self.layout_dirty = true;
}

/// Set the scale for the layout.
pub fn set_scale(&amp;mut self, scale: f32) {
    self.scale = scale;
    self.layout_dirty = true;
}

/// Set whether to quantize the layout coordinates.
///
/// Set `quantize` as `true` to have the layout coordinates aligned to pixel boundaries.
/// That is the easiest way to avoid blurry text and to receive ready-to-paint layout metrics.
///
/// For advanced rendering use cases you can set `quantize` as `false` and receive
/// fractional coordinates. This ensures the most accurate results if you want to perform
/// some post-processing on the coordinates before painting. To avoid blurry text you will
/// still need to quantize the coordinates just before painting.
///
/// Your should round at least the following:
/// * Glyph run baseline
/// * Inline box baseline
///   - `box.y = (box.y + box.height).round() - box.height`
/// * Selection geometry's `y0` &amp; `y1`
/// * Cursor geometry's `y0` &amp; `y1`
///
/// Keep in mind that for the simple `f32::round` to be effective,
/// you need to first ensure the coordinates are in physical pixel space.
pub fn set_quantize(&amp;mut self, quantize: bool) {
    self.quantize = quantize;
    self.layout_dirty = true;
}

/// Modify the styles provided for this editor.
pub fn edit_styles(&amp;mut self) -&gt; &amp;mut StyleSet&lt;T&gt; {
    self.layout_dirty = true;
    &amp;mut self.default_style
}

/// Whether the editor is currently in IME composing mode.
pub fn is_composing(&amp;self) -&gt; bool {
    self.compose.is_some()
}

/// Get the full read-only details from the layout, which will be updated if necessary.
///
/// If the required contexts are not available, then [`refresh_layout`](Self::refresh_layout) can
/// be called in a scope when they are available, and [`try_layout`](Self::try_layout) can
/// be used instead.
pub fn layout(
    &amp;mut self,
    font_cx: &amp;mut FontContext,
    layout_cx: &amp;mut LayoutContext&lt;T&gt;,
) -&gt; &amp;Layout&lt;T&gt; {
    self.refresh_layout(font_cx, layout_cx);
    &amp;self.layout
}

// --- MARK: Raw APIs ---
/// Get the full read-only details from the layout, if valid.
///
/// Returns `None` if the layout is not up-to-date.
/// You can call [`refresh_layout`](Self::refresh_layout) before using this method,
/// to ensure that the layout is up-to-date.
///
/// The [`layout`](Self::layout) method should generally be preferred.
pub fn try_layout(&amp;self) -&gt; Option&lt;&amp;Layout&lt;T&gt;&gt; {
    if self.layout_dirty {
        None
    } else {
        Some(&amp;self.layout)
    }
}

#[cfg(feature = &quot;accesskit&quot;)]
#[inline]
/// Perform an accessibility update if the layout is valid.
///
/// Returns `None` if the layout is not up-to-date.
/// You can call [`refresh_layout`](Self::refresh_layout) before using this method,
/// to ensure that the layout is up-to-date.
/// The [`accessibility`](PlainEditorDriver::accessibility) method on the driver type
/// should be preferred if the contexts are available, which will do this automatically.
pub fn try_accessibility(
    &amp;mut self,
    update: &amp;mut TreeUpdate,
    node: &amp;mut Node,
    next_node_id: impl FnMut() -&gt; NodeId,
    x_offset: f64,
    y_offset: f64,
) -&gt; Option&lt;()&gt; {
    if self.layout_dirty {
        return None;
    }
    self.accessibility_unchecked(update, node, next_node_id, x_offset, y_offset);
    Some(())
}

/// Update the layout if it is dirty.
///
/// This should only be used alongside [`try_layout`](Self::try_layout)
/// or [`try_accessibility`](Self::try_accessibility), if those will be
/// called in a scope where the contexts are not available.
pub fn refresh_layout(&amp;mut self, font_cx: &amp;mut FontContext, layout_cx: &amp;mut LayoutContext&lt;T&gt;) {
    if self.layout_dirty {
        self.update_layout(font_cx, layout_cx);
    }
}

// --- MARK: Internal Helpers ---
/// Make a cursor at a given byte index.
fn cursor_at(&amp;self, index: usize) -&gt; Cursor {
    // TODO: Do we need to be non-dirty?
    // FIXME: `Selection` should make this easier
    if index &gt;= self.buffer.len() {
        Cursor::from_byte_index(&amp;self.layout, self.buffer.len(), Affinity::Upstream)
    } else {
        Cursor::from_byte_index(&amp;self.layout, index, Affinity::Downstream)
    }
}

fn update_compose_for_replaced_range(&amp;mut self, old_range: Range&lt;usize&gt;, new_len: usize) {
    if new_len == old_range.len() {
        return;
    }
    let Some(compose) = &amp;mut self.compose else {
        return;
    };
    if compose.end &lt;= old_range.start {
        return;
    }
    if compose.start &gt;= old_range.end {
        if new_len &gt; old_range.len() {
            let diff = new_len - old_range.len();
            *compose = compose.start + diff..compose.end + diff;
        } else {
            let diff = old_range.len() - new_len;
            *compose = compose.start - diff..compose.end - diff;
        }
        return;
    }
    if new_len &lt; old_range.len() {
        if compose.start &gt;= (old_range.start + new_len) {
            self.compose = None;
            return;
        }
        compose.end = compose.end.min(old_range.start + new_len);
    }
}

fn replace_selection(
    &amp;mut self,
    font_cx: &amp;mut FontContext,
    layout_cx: &amp;mut LayoutContext&lt;T&gt;,
    s: &amp;str,
) {
    let range = self.selection.text_range();
    let start = range.start;
    if self.selection.is_collapsed() {
        self.buffer.insert_str(start, s);
    } else {
        self.buffer.replace_range(range.clone(), s);
    }
    self.update_compose_for_replaced_range(range, s.len());

    self.update_layout(font_cx, layout_cx);
    let new_index = start.saturating_add(s.len());
    let affinity = if s.ends_with(&quot;\n&quot;) {
        Affinity::Downstream
    } else {
        Affinity::Upstream
    };
    self.set_selection(Cursor::from_byte_index(&amp;self.layout, new_index, affinity).into());
}

/// Update the selection, and nudge the `Generation` if something other than `h_pos` changed.
fn set_selection(&amp;mut self, new_sel: Selection) {
    if new_sel.focus() != self.selection.focus() || new_sel.anchor() != self.selection.anchor()
    {
        self.generation.nudge();
    }

    // This debug code is quite useful when diagnosing selection problems.
    #[cfg(feature = &quot;std&quot;)]
    #[allow(clippy::print_stderr)] // reason = &quot;unreachable debug code&quot;
    if false {
        let focus = new_sel.focus();
        let cluster = focus.logical_clusters(&amp;self.layout);
        let dbg = (
            cluster[0].as_ref().map(|c| &amp;self.buffer[c.text_range()]),
            focus.index(),
            focus.affinity(),
            cluster[1].as_ref().map(|c| &amp;self.buffer[c.text_range()]),
        );
        eprint!(&quot;{dbg:?}&quot;);
        let cluster = focus.visual_clusters(&amp;self.layout);
        let dbg = (
            cluster[0].as_ref().map(|c| &amp;self.buffer[c.text_range()]),
            cluster[0]
                .as_ref()
                .map(|c| if c.is_word_boundary() { &quot; W&quot; } else { &quot;&quot; })
                .unwrap_or_default(),
            focus.index(),
            focus.affinity(),
            cluster[1].as_ref().map(|c| &amp;self.buffer[c.text_range()]),
            cluster[1]
                .as_ref()
                .map(|c| if c.is_word_boundary() { &quot; W&quot; } else { &quot;&quot; })
                .unwrap_or_default(),
        );
        eprintln!(&quot; | visual: {dbg:?}&quot;);
    }
    self.selection = new_sel;
}
/// Update the layout.
fn update_layout(&amp;mut self, font_cx: &amp;mut FontContext, layout_cx: &amp;mut LayoutContext&lt;T&gt;) {
    let mut builder =
        layout_cx.ranged_builder(font_cx, &amp;self.buffer, self.scale, self.quantize);
    for prop in self.default_style.inner().values() {
        builder.push_default(prop.to_owned());
    }
    if let Some(preedit_range) = &amp;self.compose {
        builder.push(StyleProperty::Underline(true), preedit_range.clone());
    }
    self.layout = builder.build(&amp;self.buffer);
    self.layout.break_all_lines(self.width);
    self.layout
        .align(self.width, self.alignment, AlignmentOptions::default());
    self.selection = self.selection.refresh(&amp;self.layout);
    self.layout_dirty = false;
    self.generation.nudge();
}

#[cfg(feature = &quot;accesskit&quot;)]
/// Perform an accessibility update, assuming that the layout is valid.
///
/// The wrapper [`accessibility`](PlainEditorDriver::accessibility) on the driver type should
/// be preferred.
///
/// You should always call [`refresh_layout`](Self::refresh_layout) before using this method,
/// with no other modifying method calls in between.
fn accessibility_unchecked(
    &amp;mut self,
    update: &amp;mut TreeUpdate,
    node: &amp;mut Node,
    next_node_id: impl FnMut() -&gt; NodeId,
    x_offset: f64,
    y_offset: f64,
) {
    self.layout_access.build_nodes(
        &amp;self.buffer,
        &amp;self.layout,
        update,
        node,
        next_node_id,
        x_offset,
        y_offset,
    );
    if self.show_cursor {
        if let Some(selection) = self
            .selection
            .to_access_selection(&amp;self.layout, &amp;self.layout_access)
        {
            node.set_text_selection(selection);
        }
    } else {
        node.clear_text_selection();
    }
    node.add_action(accesskit::Action::SetTextSelection);
}
</code></pre><p>}</p><hr><p><strong>Cursor</strong></p><p>è¿™æ®µ Rust ä»£ç æ˜¯ <code>parley</code> åº“ä¸­ä¸€ä¸ªåä¸º <code>PlainEditor</code> çš„ç»„ä»¶çš„å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ª<strong>ç®€å•çš„çº¯æ–‡æœ¬ç¼–è¾‘å™¨</strong>ã€‚å®ƒè´Ÿè´£ç®¡ç†æ–‡æœ¬å†…å®¹ã€å…‰æ ‡ã€é€‰æ‹©åŒºåŸŸä»¥åŠæœ€é‡è¦çš„æ˜¯â€”â€”<strong>é›†æˆè¾“å…¥æ³•ç¼–è¾‘å™¨ (IME) çš„é¢„ç¼–è¾‘åŠŸèƒ½</strong>ã€‚</p><p>ç»“åˆæˆ‘ä»¬ä¹‹å‰å…³äº <code>winit</code> å’Œ IME çš„è®¨è®ºï¼Œè¿™æ®µä»£ç å±•ç¤ºäº†åº”ç”¨ç¨‹åºï¼ˆä½¿ç”¨ <code>parley</code>ï¼‰æ˜¯å¦‚ä½•å¤„ç† <code>winit</code> æä¾›çš„ IME äº‹ä»¶çš„ã€‚</p><h3 id=plaineditor-çš„æ ¸å¿ƒèŒè´£><code>PlainEditor</code> çš„æ ¸å¿ƒèŒè´£ï¼š</h3><ol><li><strong>æ–‡æœ¬ç¼“å†²ç®¡ç† (<code>buffer: String</code>)ï¼š</strong> å­˜å‚¨å®é™…çš„æ–‡æœ¬å†…å®¹ã€‚</li><li><strong>æ–‡æœ¬å¸ƒå±€ (<code>layout: Layout&lt;T></code>)ï¼š</strong> ä½¿ç”¨ <code>parley</code> çš„å¸ƒå±€å¼•æ“å¯¹æ–‡æœ¬è¿›è¡Œæ’ç‰ˆï¼ŒåŒ…æ‹¬æ–­è¡Œã€å¯¹é½ã€å­—å½¢å®šä½ç­‰ã€‚</li><li><strong>å…‰æ ‡å’Œé€‰æ‹©ç®¡ç† (<code>selection: Selection</code>)ï¼š</strong> è·Ÿè¸ªç”¨æˆ·å½“å‰çš„å…‰æ ‡ä½ç½®å’Œæ–‡æœ¬é€‰æ‹©åŒºåŸŸã€‚</li><li><strong>IME é¢„ç¼–è¾‘æ–‡æœ¬å¤„ç† (<code>compose: Option&lt;Range&lt;usize>></code>, <code>show_cursor: bool</code>)ï¼š</strong> è¿™æ˜¯å…³é”®éƒ¨åˆ†ï¼Œå®ƒä¸“é—¨å¤„ç† IME çš„ä¸­é—´è¾“å…¥çŠ¶æ€ï¼Œä¾‹å¦‚ç”¨æˆ·è¾“å…¥æ‹¼éŸ³æ—¶æ˜¾ç¤ºçš„æœªç¡®è®¤å­—ç¬¦ã€‚</li><li><strong>æ–‡æœ¬ç¼–è¾‘æ“ä½œï¼š</strong> æä¾›æ’å…¥ã€åˆ é™¤ã€å›é€€ã€ç§»åŠ¨å…‰æ ‡ç­‰åŸºæœ¬çš„æ–‡æœ¬ç¼–è¾‘åŠŸèƒ½ã€‚</li><li><strong>å¸ƒå±€æ›´æ–°æœºåˆ¶ (<code>layout_dirty: bool</code>, <code>generation: Generation</code>)ï¼š</strong> è·Ÿè¸ªæ–‡æœ¬æˆ–å¸ƒå±€å±æ€§çš„å˜åŒ–ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶é‡æ–°è®¡ç®—æ–‡æœ¬å¸ƒå±€ã€‚</li></ol><h3 id=ä¸-ime-ç›¸å…³çš„å…³é”®å­—æ®µå’Œæ–¹æ³•>ä¸ IME ç›¸å…³çš„å…³é”®å­—æ®µå’Œæ–¹æ³•ï¼š</h3><ol><li><p><strong><code>compose: Option&lt;Range&lt;usize>></code></strong>:</p><ul><li>è¿™æ˜¯ä¸€ä¸ª <code>Option&lt;Range&lt;usize>></code> å­—æ®µï¼Œç”¨äºå­˜å‚¨å½“å‰ IME <strong>é¢„ç¼–è¾‘æ–‡æœ¬</strong>åœ¨ <code>PlainEditor</code> å†…éƒ¨ <code>buffer</code> ä¸­çš„å­—èŠ‚èŒƒå›´ã€‚</li><li>å¦‚æœ <code>compose</code> ä¸º <code>Some(range)</code>ï¼Œåˆ™è¡¨ç¤ºå½“å‰æœ‰é¢„ç¼–è¾‘æ–‡æœ¬æ­£åœ¨è¾“å…¥ä¸­ï¼Œå…¶å†…å®¹ä½äº <code>buffer[range]</code>ã€‚</li><li>å¦‚æœ <code>compose</code> ä¸º <code>None</code>ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰é¢„ç¼–è¾‘æ–‡æœ¬ã€‚</li></ul></li><li><p><strong><code>show_cursor: bool</code></strong>:</p><ul><li>IME æœ‰æ—¶ä¼šè¦æ±‚éšè—åº”ç”¨ç¨‹åºçš„å…‰æ ‡ï¼ˆä¾‹å¦‚ï¼Œå½“ IME è‡ªå·±çš„å€™é€‰çª—å£æ˜¾ç¤ºæ—¶ï¼‰ã€‚è¿™ä¸ªå­—æ®µç”¨äºè·Ÿè¸ª IME æ˜¯å¦è¦æ±‚éšè—å…‰æ ‡ã€‚</li></ul></li><li><p><strong><code>pub fn text(&amp;self) -> SplitString&lt;'_></code></strong>:</p><ul><li>è¿™ä¸ªæ–¹æ³•è¿”å› <code>SplitString</code>ï¼Œä¸€ä¸ªå·§å¦™çš„å­—ç¬¦ä¸²è§†å›¾ï¼Œå®ƒ<strong>ä¼šè‡ªåŠ¨æ’é™¤</strong> <code>compose</code> å­—æ®µæŒ‡ç¤ºçš„ IME é¢„ç¼–è¾‘åŒºåŸŸã€‚</li><li>è¿™æ„å‘³ç€ï¼Œå½“ <code>compose</code> å­˜åœ¨æ—¶ï¼Œå¤–éƒ¨åº”ç”¨é€šè¿‡ <code>text()</code> è·å–çš„å­—ç¬¦ä¸²æ˜¯<strong>ä¸åŒ…å«</strong>é¢„ç¼–è¾‘æ–‡æœ¬çš„ï¼ŒåªåŒ…å«å·²ç¡®è®¤çš„æ–‡æœ¬ã€‚è¿™å¯¹äºåº”ç”¨ç¨‹åºè¿›è¡Œæ–‡æœ¬å¤„ç†ï¼ˆå¦‚ä¿å­˜ã€å¤åˆ¶ï¼‰éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸åªå…³å¿ƒæœ€ç»ˆæ–‡æœ¬ã€‚</li></ul></li><li><p><strong><code>pub fn raw_text(&amp;self) -> &amp;str</code></strong>:</p><ul><li>ä¸ <code>text()</code> ç›¸åï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› <code>buffer</code> çš„å®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬ IME é¢„ç¼–è¾‘åŒºåŸŸã€‚è¿™åœ¨æŸäº›è°ƒè¯•æˆ–ç‰¹æ®Šåœºæ™¯ä¸‹å¯èƒ½æœ‰ç”¨ã€‚</li></ul></li><li><p><strong><code>pub fn is_composing(&amp;self) -> bool</code></strong>:</p><ul><li>ç®€å•æ£€æŸ¥ <code>self.compose</code> æ˜¯å¦ä¸º <code>Some</code>ï¼Œç”¨äºåˆ¤æ–­å½“å‰æ˜¯å¦å¤„äº IME é¢„ç¼–è¾‘æ¨¡å¼ã€‚</li></ul></li><li><p><strong><code>PlainEditorDriver::set_compose(&amp;mut self, text: &amp;str, cursor: Option&lt;(usize, usize)>)</code></strong>:</p><ul><li>è¿™æ˜¯åº”ç”¨ç¨‹åºç”¨äºæ¥æ”¶ <code>winit::event::Ime::Preedit</code> äº‹ä»¶åè°ƒç”¨çš„å…³é”®æ–¹æ³•ã€‚</li><li>å®ƒå°† <code>winit</code> ä¼ æ¥çš„<strong>é¢„ç¼–è¾‘æ–‡æœ¬ <code>text</code></strong> æ’å…¥æˆ–æ›¿æ¢åˆ° <code>PlainEditor</code> çš„ <code>buffer</code> ä¸­ã€‚</li><li>å®ƒä¼šæ›´æ–° <code>self.editor.compose</code> æ¥æ ‡è®°è¿™éƒ¨åˆ†æ–‡æœ¬ä¸ºé¢„ç¼–è¾‘åŒºåŸŸã€‚</li><li>å®ƒè¿˜ä¼šæ ¹æ® <code>cursor</code> ä¿¡æ¯æ›´æ–° <code>PlainEditor</code> å†…éƒ¨çš„ <code>selection</code> å’Œ <code>show_cursor</code> çŠ¶æ€ã€‚</li><li><strong>æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šè§¦å‘ <code>self.update_layout()</code>ã€‚</strong></li></ul></li><li><p><strong><code>PlainEditorDriver::clear_compose(&amp;mut self)</code></strong>:</p><ul><li>å½“ IME é¢„ç¼–è¾‘ç»“æŸä½†æœªç¡®è®¤ï¼ˆä¾‹å¦‚ç”¨æˆ·æŒ‰ä¸‹äº† Escï¼‰æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚</li><li>å®ƒä¼šä» <code>buffer</code> ä¸­ç§»é™¤é¢„ç¼–è¾‘æ–‡æœ¬ï¼Œæ¸…ç©º <code>compose</code> å­—æ®µï¼Œå¹¶é‡æ–°æ˜¾ç¤ºå…‰æ ‡ã€‚</li></ul></li><li><p><strong><code>PlainEditorDriver::finish_compose(&amp;mut self)</code></strong>:</p><ul><li>å½“ IME é¢„ç¼–è¾‘æ–‡æœ¬è¢«ç”¨æˆ·ç¡®è®¤ï¼ˆä¾‹å¦‚æŒ‰å›è½¦ï¼‰æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚</li><li>å®ƒæ¸…ç©º <code>compose</code> å­—æ®µï¼Œä½†<strong>ä¸ä» <code>buffer</code> ä¸­åˆ é™¤æ–‡æœ¬</strong>ï¼Œå› ä¸ºæ–‡æœ¬å·²ç»è¢«ç”¨æˆ·ç¡®è®¤å¹¶æˆä¸ºå¸¸è§„æ–‡æœ¬çš„ä¸€éƒ¨åˆ†ã€‚åŒæ—¶é‡æ–°æ˜¾ç¤ºå…‰æ ‡ã€‚</li></ul></li><li><p><strong><code>pub fn ime_cursor_area(&amp;self) -> Rect</code></strong>:</p><ul><li>è¿™ä¸ªæ–¹æ³•è®¡ç®—å¹¶è¿”å›å½“å‰ IME é¢„ç¼–è¾‘æ–‡æœ¬åŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰æˆ–å½“å‰å…‰æ ‡/é€‰æ‹©åŒºåŸŸçš„å±å¹•è¾¹ç•ŒçŸ©å½¢ã€‚</li><li><strong>è¿™ä¸ªè¿”å›å€¼æ­£æ˜¯åº”ç”¨ç¨‹åºä¼šä¼ é€’ç»™ <code>winit</code> çš„ <code>window.set_ime_position()</code> æ–¹æ³•ï¼Œä»¥ä¾¿æ“ä½œç³»ç»Ÿèƒ½åœ¨æ­¤åŒºåŸŸæ˜¾ç¤º IME å€™é€‰è¯çª—å£ã€‚</strong></li></ul></li><li><p><strong><code>fn update_layout(&amp;mut self, ...)</code> (å†…éƒ¨è¾…åŠ©æ–¹æ³•)</strong>:</p><ul><li>è¿™æ˜¯è¿›è¡Œå®é™…æ–‡æœ¬å¸ƒå±€çš„åœ°æ–¹ã€‚</li><li>å½“ <code>set_compose</code> è¢«è°ƒç”¨æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šé‡æ–°å¸ƒå±€æ–‡æœ¬ã€‚</li><li><strong>ç‰¹åˆ«åœ°ï¼Œå®ƒä¼šæ£€æŸ¥ <code>self.compose</code> æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±ä¼šåœ¨å¸ƒå±€æ—¶ä¸ºé¢„ç¼–è¾‘æ–‡æœ¬èŒƒå›´åº”ç”¨ <code>StyleProperty::Underline(true)</code> æ ·å¼ã€‚</strong> è¿™å°±æ˜¯ <code>parley</code> å¦‚ä½•çŸ¥é“è¦ç»˜åˆ¶ä¸‹åˆ’çº¿çš„æ–¹å¼ã€‚</li></ul></li></ol><h3 id=parley-å¦‚ä½•ä¸-winit-äº¤äº’çš„æ€»ç»“><code>parley</code> å¦‚ä½•ä¸ <code>winit</code> äº¤äº’çš„æ€»ç»“ï¼š</h3><ol><li><code>winit</code> ä»æ“ä½œç³»ç»Ÿæ¥æ”¶åŸå§‹ IME äº‹ä»¶ (<code>Ime::Preedit</code>, <code>Ime::Commit</code> ç­‰)ã€‚</li><li>åº”ç”¨ç¨‹åºé€šè¿‡ <code>winit</code> çš„äº‹ä»¶å¾ªç¯è·å–è¿™äº›äº‹ä»¶ã€‚</li><li><strong>åº”ç”¨ç¨‹åºæ¥æ”¶åˆ° <code>Ime::Preedit</code> äº‹ä»¶æ—¶ï¼š</strong><ul><li>è°ƒç”¨ <code>PlainEditorDriver::set_compose()</code>ï¼Œå°†é¢„ç¼–è¾‘æ–‡æœ¬å’Œå…‰æ ‡ä¿¡æ¯ä¼ é€’ç»™ <code>parley</code> çš„ç¼–è¾‘å™¨ç»„ä»¶ã€‚</li><li>è°ƒç”¨ <code>PlainEditor::ime_cursor_area()</code> è·å–é¢„ç¼–è¾‘æ–‡æœ¬çš„å±å¹•åŒºåŸŸã€‚</li><li>å°†è¯¥åŒºåŸŸä¿¡æ¯ä¼ é€’ç»™ <code>winit</code> çš„ <code>window.set_ime_position()</code> æ–¹æ³•ï¼Œä»¥ä¾¿æ“ä½œç³»ç»Ÿå¯ä»¥æ­£ç¡®æ”¾ç½® IME å€™é€‰çª—å£ã€‚</li></ul></li><li><strong>åº”ç”¨ç¨‹åºæ¥æ”¶åˆ° <code>Ime::Commit</code> äº‹ä»¶æ—¶ï¼š</strong><ul><li>è°ƒç”¨ <code>PlainEditorDriver::finish_compose()</code> æˆ– <code>clear_compose()</code> æ¥å¤„ç†å·²ç¡®è®¤æˆ–å–æ¶ˆçš„é¢„ç¼–è¾‘æ–‡æœ¬ã€‚</li></ul></li><li><strong>æ¸²æŸ“æ—¶ï¼š</strong><ul><li>åº”ç”¨ç¨‹åºä» <code>PlainEditorDriver::layout()</code> è·å–æœ€æ–°çš„æ–‡æœ¬å¸ƒå±€ã€‚</li><li><code>parley</code> åœ¨å¸ƒå±€æ—¶ï¼Œå·²ç»æ ¹æ® <code>PlainEditor</code> å†…éƒ¨ <code>compose</code> çŠ¶æ€ä¸ºé¢„ç¼–è¾‘æ–‡æœ¬åº”ç”¨äº†ä¸‹åˆ’çº¿æ ·å¼ã€‚</li><li>åº”ç”¨ç¨‹åºæ ¹æ® <code>parley</code> æä¾›çš„å¸ƒå±€æ•°æ®ï¼ˆåŒ…æ‹¬å­—å½¢å’Œæ ·å¼ï¼‰ï¼Œä½¿ç”¨åº•å±‚å›¾å½¢ API å°†æ–‡æœ¬ç»˜åˆ¶åˆ°å±å¹•ä¸Šï¼Œå…¶ä¸­é¢„ç¼–è¾‘æ–‡æœ¬ä¼šè‡ªåŠ¨å¸¦ä¸Šä¸‹åˆ’çº¿ã€‚</li></ul></li></ol><p>æ‰€ä»¥ï¼Œè¿™æ®µ <code>parley</code> ä»£ç æ­£æ˜¯<strong>åº”ç”¨ç¨‹åºå±‚é¢</strong>å¦‚ä½•å¤„ç† IME è¾“å…¥å’Œæ¸²æŸ“é¢„ç¼–è¾‘æ–‡æœ¬çš„<strong>å…·ä½“å®ç°</strong>ï¼Œå®ƒæ‰®æ¼”ç€ <code>winit</code> å’Œå®é™…æ¸²æŸ“ä¹‹é—´çš„<strong>ä¸­é—´ç®¡ç†å±‚</strong>çš„è§’è‰²ã€‚</p><hr><p><strong>User</strong></p><pre><code>    let render_state = match &amp;mut self.state {
        RenderState::Active(state) if state.window.id() == window_id =&gt; state,
        _ =&gt; return,
    };

    render_state
        .access_adapter
        .process_event(&amp;render_state.window, &amp;event);
    self.editor.handle_event(event.clone());
    if self.last_drawn_generation != self.editor.generation() {
        render_state.window.request_redraw();
        let area = self.editor.editor().ime_cursor_area();
        if self.last_sent_ime_cursor_area != area {
            self.last_sent_ime_cursor_area = area;
            // Note: on X11 `set_ime_cursor_area` may cause the exclusion area to be obscured
            // until https://github.com/rust-windowing/winit/pull/3966 is in the Winit release
            // used by this example.
            render_state.window.set_ime_cursor_area(
                PhysicalPosition::new(
                    area.x0 + text::INSET as f64,
                    area.y0 + text::INSET as f64,
                ),
                PhysicalSize::new(area.width(), area.height()),
            );
        }
    }
</code></pre><p>çœ‹çœ‹è¿™ä¸ªï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>è¿™æ®µ Rust ä»£ç æ˜¯åº”ç”¨ç¨‹åºä¸»äº‹ä»¶å¾ªç¯ä¸­å¤„ç†çª—å£äº‹ä»¶çš„ä¸€ä¸ªç‰‡æ®µï¼Œå®ƒå±•ç¤ºäº† <code>winit</code>ã€<code>parley</code> (é€šè¿‡ <code>self.editor</code> é—´æ¥ä½¿ç”¨) ä»¥åŠå¯è®¿é—®æ€§ (AccessKit) ä¹‹é—´æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ã€‚</p><p>å®ƒä¸»è¦åœ¨åšä»¥ä¸‹äº‹æƒ…ï¼š</p><ol><li><p><strong>ç¡®å®šæ´»åŠ¨çª—å£çš„æ¸²æŸ“çŠ¶æ€ï¼š</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>render_state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>state</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RenderState</span>::<span class=n>Active</span><span class=p>(</span><span class=n>state</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>window</span><span class=p>.</span><span class=n>id</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>window_id</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>è¿™æ®µä»£ç é¦–å…ˆæ£€æŸ¥å½“å‰çš„äº‹ä»¶ (<code>event</code>) æ˜¯å¦å±äºä¸€ä¸ªå¤„äºâ€œæ´»åŠ¨â€çŠ¶æ€çš„çª—å£ (<code>window_id</code>)ã€‚å¦‚æœåŒ¹é…ï¼Œå®ƒä¼šè·å–åˆ°è¯¥çª—å£çš„æ¸²æŸ“çŠ¶æ€ (<code>render_state</code>)ï¼Œå…¶ä¸­åŒ…å«äº† <code>winit</code> çš„ <code>Window</code> å¯¹è±¡ã€‚å¦‚æœä¸æ˜¯ç›®æ ‡çª—å£æˆ–çª—å£ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸å¤„ç†è¯¥äº‹ä»¶ã€‚</p></li><li><p><strong>å¤„ç†å¯è®¿é—®æ€§äº‹ä»¶ï¼š</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>        </span><span class=n>render_state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>access_adapter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>process_event</span><span class=p>(</span><span class=o>&amp;</span><span class=n>render_state</span><span class=p>.</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>è¿™è¡Œä»£ç å°†å½“å‰ <code>winit</code> äº‹ä»¶ (<code>event</code>) ä¼ é€’ç»™ä¸€ä¸ªå¯è®¿é—®æ€§é€‚é…å™¨ (<code>access_adapter</code>)ã€‚è¿™é€šå¸¸æ˜¯ä¸ºäº†æ”¯æŒè¾…åŠ©æŠ€æœ¯ï¼ˆå¦‚å±å¹•é˜…è¯»å™¨ï¼‰ï¼Œå°† UI å˜åŒ–å’Œç”¨æˆ·äº¤äº’æŠ¥å‘Šç»™æ“ä½œç³»ç»Ÿæˆ–å¯è®¿é—®æ€§æœåŠ¡ã€‚åœ¨ <code>parley</code> çš„ä»£ç ä¸­çœ‹åˆ°äº† <code>accesskit</code> çš„ featureï¼Œè¿™è¡¨æ˜ <code>access_adapter</code> å¯èƒ½æ˜¯ <code>accesskit</code> ç›¸å…³çš„é›†æˆã€‚</p></li><li><p><strong>å¤„ç†ç¼–è¾‘å™¨äº‹ä»¶ï¼š</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>editor</span><span class=p>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=n>clone</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></div><p>è¿™æ˜¯å…³é”®çš„ä¸€æ­¥ã€‚å®ƒå°† <code>winit</code> æ•è·åˆ°çš„äº‹ä»¶ï¼ˆä¾‹å¦‚é”®ç›˜è¾“å…¥ã€é¼ æ ‡ç‚¹å‡»ã€IME äº‹ä»¶ç­‰ï¼‰è½¬å‘ç»™åº”ç”¨ç¨‹åºå†…éƒ¨çš„æ–‡æœ¬ç¼–è¾‘å™¨é€»è¾‘ (<code>self.editor</code>)ã€‚</p><ul><li>è¿™ä¸ª <code>self.editor</code> å†…éƒ¨å¾ˆå¯èƒ½å°è£…äº† <code>parley</code> çš„ <code>PlainEditorDriver</code>ï¼Œå¹¶åœ¨å…¶ <code>handle_event</code> æ–¹æ³•ä¸­åŒ…å«å¤„ç† <code>winit::event::Ime</code> äº‹ä»¶çš„é€»è¾‘ï¼ˆä¾‹å¦‚è°ƒç”¨ <code>PlainEditorDriver::set_compose</code>ã€<code>clear_compose</code>ã€<code>finish_compose</code>ï¼‰ã€‚</li><li>å®ƒä¹Ÿå¯èƒ½å¤„ç†å¸¸è§„çš„é”®ç›˜è¾“å…¥ï¼ˆä¾‹å¦‚è°ƒç”¨ <code>insert_or_replace_selection</code>ã€<code>delete</code>ã€<code>move_left</code> ç­‰ï¼‰ã€‚</li></ul></li><li><p><strong>æ£€æŸ¥å¹¶è¯·æ±‚é‡ç»˜ (Redraw) å’Œæ›´æ–° IME åŒºåŸŸï¼š</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>last_drawn_generation</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>editor</span><span class=p>.</span><span class=n>generation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>render_state</span><span class=p>.</span><span class=n>window</span><span class=p>.</span><span class=n>request_redraw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>area</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>editor</span><span class=p>.</span><span class=n>editor</span><span class=p>().</span><span class=n>ime_cursor_area</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>last_sent_ime_cursor_area</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>area</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>last_sent_ime_cursor_area</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>area</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Note: on X11 `set_ime_cursor_area` may cause the exclusion area to be obscured
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=c1>// until https://github.com/rust-windowing/winit/pull/3966 is in the Winit release
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=c1>// used by this example.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=n>render_state</span><span class=p>.</span><span class=n>window</span><span class=p>.</span><span class=n>set_ime_cursor_area</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>PhysicalPosition</span>::<span class=n>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>area</span><span class=p>.</span><span class=n>x0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>text</span>::<span class=no>INSET</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>area</span><span class=p>.</span><span class=n>y0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>text</span>::<span class=no>INSET</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>PhysicalSize</span>::<span class=n>new</span><span class=p>(</span><span class=n>area</span><span class=p>.</span><span class=n>width</span><span class=p>(),</span><span class=w> </span><span class=n>area</span><span class=p>.</span><span class=n>height</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong><code>if self.last_drawn_generation != self.editor.generation()</code></strong>: è¿™æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚<code>self.editor.generation()</code> æ˜¯ä¸€ä¸ªâ€œä»£æ•°â€æˆ–â€œç‰ˆæœ¬å·â€ï¼Œåœ¨ <code>parley</code> çš„ <code>PlainEditor</code> å†…éƒ¨ï¼Œåªè¦æ–‡æœ¬å†…å®¹ã€å…‰æ ‡ä½ç½®ã€é€‰æ‹©çŠ¶æ€æˆ– IME é¢„ç¼–è¾‘åŒºåŸŸå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸ª <code>generation</code> å°±ä¼šâ€œnudgeâ€ï¼ˆé€’å¢ï¼‰ã€‚é€šè¿‡æ¯”è¾ƒä¸Šæ¬¡ç»˜åˆ¶æ—¶çš„ä»£æ•°ä¸å½“å‰çš„ä»£æ•°ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ç»˜åˆ¶ã€‚</li><li><strong><code>render_state.window.request_redraw()</code></strong>: å¦‚æœ <code>generation</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œè¯´æ˜ç¼–è¾‘å™¨çš„å†…å®¹æˆ–çŠ¶æ€éœ€è¦æ›´æ–°ï¼Œå› æ­¤å‘ <code>winit</code> è¯·æ±‚ä¸€ä¸ªçª—å£é‡ç»˜äº‹ä»¶ã€‚</li><li><strong><code>let area = self.editor.editor().ime_cursor_area();</code></strong>: è°ƒç”¨ <code>parley</code> <code>PlainEditor</code> çš„ <code>ime_cursor_area()</code> æ–¹æ³•ï¼Œè·å–å½“å‰æ–‡æœ¬è¾“å…¥åŒºåŸŸï¼ˆç‰¹åˆ«æ˜¯é¢„ç¼–è¾‘æ–‡æœ¬æˆ–å…‰æ ‡ï¼‰åœ¨åº”ç”¨ç¨‹åºçª—å£ä¸­çš„è¾¹ç•ŒçŸ©å½¢ã€‚è¿™ä¸ªåŒºåŸŸæ˜¯ IME åº”è¯¥æ˜¾ç¤ºå…¶å€™é€‰è¯çª—å£çš„åœ°æ–¹ã€‚</li><li><strong><code>if self.last_sent_ime_cursor_area != area { ... }</code></strong>: æ£€æŸ¥è®¡ç®—å‡ºçš„ IME åŒºåŸŸæ˜¯å¦ä¸ä¸Šæ¬¡å‘é€ç»™ <code>winit</code> çš„åŒºåŸŸä¸åŒã€‚è¿™å¯ä»¥é¿å…ä¸å¿…è¦çš„ API è°ƒç”¨ã€‚</li><li><strong><code>render_state.window.set_ime_cursor_area(...)</code></strong>: è¿™æ˜¯å°†åº”ç”¨ç¨‹åºè®¡ç®—å‡ºçš„ IME åŒºåŸŸä½ç½®<strong>åé¦ˆç»™ <code>winit</code></strong> çš„å…³é”®ä¸€æ­¥ã€‚<code>winit</code> ä¼šå°†æ­¤ä¿¡æ¯ä¼ é€’ç»™æ“ä½œç³»ç»Ÿï¼ˆWindows IMM APIã€X11 IM åè®®ç­‰ï¼‰ï¼Œä»è€Œä½¿ IME å€™é€‰çª—å£æ­£ç¡®åœ°è·Ÿéšå…‰æ ‡æˆ–é¢„ç¼–è¾‘æ–‡æœ¬ã€‚<code>PhysicalPosition</code> å’Œ <code>PhysicalSize</code> è¡¨æ˜è¿™é‡Œä½¿ç”¨çš„æ˜¯ç‰©ç†åƒç´ åæ ‡ï¼Œ<code>text::INSET</code> å¯èƒ½æ˜¯ä¸ºäº†åœ¨å®é™…æ–‡æœ¬åŒºåŸŸå‘¨å›´å¢åŠ ä¸€äº›è¾¹è·ã€‚</li></ul></li></ol><p><strong>æ€»ç»“ï¼š</strong></p><p>è¿™æ®µä»£ç ç‰‡æ®µå®Œç¾åœ°ä½“ç°äº† <code>winit</code> å’Œ <code>parley</code>ï¼ˆä½œä¸ºåº”ç”¨ç¨‹åºå†…éƒ¨çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼‰åœ¨ IME å¤„ç†ä¸Šçš„åˆ†å·¥ä¸åä½œï¼š</p><ul><li><code>self.editor.handle_event(event.clone())</code>ï¼š<code>self.editor</code> <strong>æ¥æ”¶</strong> <code>winit</code> ä¼ æ¥çš„ IME äº‹ä»¶ï¼Œå¹¶æ®æ­¤æ›´æ–°å…¶å†…éƒ¨çš„æ–‡æœ¬å’Œå¸ƒå±€çŠ¶æ€ï¼ˆåŒ…æ‹¬é¢„ç¼–è¾‘æ–‡æœ¬çš„æ˜¾ç¤ºï¼‰ã€‚</li><li><code>self.editor.editor().ime_cursor_area()</code>ï¼š<code>self.editor</code> <strong>è®¡ç®—</strong>å‡º IME å€™é€‰çª—å£åº”è¯¥å‡ºç°çš„ä½ç½®ã€‚</li><li><code>render_state.window.set_ime_cursor_area(...)</code>ï¼šåº”ç”¨ç¨‹åºå°†è¿™ä¸ªè®¡ç®—å‡ºçš„ä½ç½®<strong>å‘Šè¯‰ <code>winit</code></strong>ï¼Œç”± <code>winit</code> è´Ÿè´£ä¸æ“ä½œç³»ç»Ÿåº•å±‚ IME æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œç¡®ä¿ IME çª—å£çš„æ­£ç¡®æ˜¾ç¤ºã€‚</li></ul><p>åŒæ—¶ï¼Œå®ƒä¹ŸåŒ…å«äº†é«˜æ•ˆé‡ç»˜çš„é€»è¾‘ï¼Œé€šè¿‡ <code>generation</code> æœºåˆ¶é¿å…ä¸å¿…è¦çš„æ¸²æŸ“ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>render_state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>state</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>RenderState</span>::<span class=n>Active</span><span class=p>(</span><span class=n>state</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>window</span><span class=p>.</span><span class=n>id</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>window_id</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>            </span><span class=n>render_state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>access_adapter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>process_event</span><span class=p>(</span><span class=o>&amp;</span><span class=n>render_state</span><span class=p>.</span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>editor</span><span class=p>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=n>clone</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>last_drawn_generation</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>editor</span><span class=p>.</span><span class=n>generation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>render_state</span><span class=p>.</span><span class=n>window</span><span class=p>.</span><span class=n>request_redraw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>area</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>editor</span><span class=p>.</span><span class=n>editor</span><span class=p>().</span><span class=n>ime_cursor_area</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>last_sent_ime_cursor_area</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>area</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>last_sent_ime_cursor_area</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>area</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Note: on X11 `set_ime_cursor_area` may cause the exclusion area to be obscured
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=c1>// until https://github.com/rust-windowing/winit/pull/3966 is in the Winit release
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=c1>// used by this example.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=n>render_state</span><span class=p>.</span><span class=n>window</span><span class=p>.</span><span class=n>set_ime_cursor_area</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>PhysicalPosition</span>::<span class=n>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>area</span><span class=p>.</span><span class=n>x0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>text</span>::<span class=no>INSET</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>area</span><span class=p>.</span><span class=n>y0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>text</span>::<span class=no>INSET</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>PhysicalSize</span>::<span class=n>new</span><span class=p>(</span><span class=n>area</span><span class=p>.</span><span class=n>width</span><span class=p>(),</span><span class=w> </span><span class=n>area</span><span class=p>.</span><span class=n>height</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><p><strong>User</strong></p><pre><code>    Rect {
        x0: (area.x0 - inflate).max(0.),
        x1: (area.x1 + inflate).min(editor_width),
        y0: area.y0,
        y1: area.y1,
    }
</code></pre><p>è¿™æ˜¯æ¸²æŸ“çš„æ˜¯å­—ä½“çš„ä¸‹åˆ’çº¿å§ï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>ä¸ï¼Œè¿™æ®µä»£ç æ¸²æŸ“çš„ <strong>ä¸æ˜¯</strong> å­—ä½“çš„ä¸‹åˆ’çº¿ã€‚</p><p>è¿™æ®µä»£ç æ‰€åœ¨çš„å‡½æ•°æ˜¯ <code>ime_cursor_area()</code>ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—å¹¶è¿”å›ä¸€ä¸ª <code>Rect</code>ï¼ˆçŸ©å½¢ï¼‰ï¼Œè¿™ä¸ªçŸ©å½¢ä»£è¡¨çš„æ˜¯ <strong>IME (è¾“å…¥æ³•ç¼–è¾‘å™¨) åº”è¯¥å…³æ³¨çš„å±å¹•åŒºåŸŸ</strong>ã€‚</p><p>è¿™ä¸ªåŒºåŸŸé€šå¸¸æ˜¯ï¼š</p><ul><li>å¦‚æœå½“å‰æœ‰ IME é¢„ç¼–è¾‘æ–‡æœ¬ï¼Œé‚£å°±æ˜¯è¯¥æ–‡æœ¬çš„è¾¹ç•ŒçŸ©å½¢ã€‚</li><li>å¦‚æœæ²¡æœ‰é¢„ç¼–è¾‘æ–‡æœ¬ï¼Œé‚£å°±æ˜¯å½“å‰å…‰æ ‡æˆ–é€‰åŒºçš„è¾¹ç•ŒçŸ©å½¢ã€‚</li></ul><p><code>ime_cursor_area()</code> è¿™ä¸ªå‡½æ•°çš„ç›®çš„ï¼Œä»¥åŠå®ƒè¿”å›çš„ <code>Rect</code>ï¼Œæ˜¯ç”¨æ¥<strong>å‘Šè¯‰æ“ä½œç³»ç»Ÿå’Œ IME</strong>ï¼š</p><ul><li>IME è‡ªå·±çš„å€™é€‰è¯çª—å£åº”è¯¥åœ¨å“ªé‡Œæ˜¾ç¤ºã€‚</li><li>æˆ–è€… IME åº”è¯¥é¿å¼€å“ªä¸ªåŒºåŸŸï¼Œä»¥å…é®æŒ¡ç”¨æˆ·æ­£åœ¨è¾“å…¥æˆ–å…³æ³¨çš„æ–‡æœ¬ã€‚</li></ul><p>ä»£ç ä¸­çš„ <code>inflate</code> å˜é‡ä¹Ÿè¯å®äº†è¿™ä¸€ç‚¹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>        </span><span class=c1>// Using 0.6 as an estimate of the average advance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>inflate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>3.</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>0.6</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>font_size</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>Rect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x0</span>: <span class=p>(</span><span class=n>area</span><span class=p>.</span><span class=n>x0</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>inflate</span><span class=p>).</span><span class=n>max</span><span class=p>(</span><span class=mf>0.</span><span class=p>),</span><span class=w> </span><span class=c1>// å·¦å³å„æ‰©å±• inflate
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>x1</span>: <span class=p>(</span><span class=n>area</span><span class=p>.</span><span class=n>x1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>inflate</span><span class=p>).</span><span class=n>min</span><span class=p>(</span><span class=n>editor_width</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y0</span>: <span class=nc>area</span><span class=p>.</span><span class=n>y0</span><span class=p>,</span><span class=w> </span><span class=c1>// Yè½´ä¸å˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>y1</span>: <span class=nc>area</span><span class=p>.</span><span class=n>y1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¿™æ®µä»£ç å°† <code>area</code> çš„ <code>x0</code> å’Œ <code>x1</code> æ²¿ç€æ°´å¹³æ–¹å‘å‘å¤–æ‰©å±•äº† <code>inflate</code> å¤§å°ï¼Œç›®çš„æ˜¯ä¸ºäº†â€œ<strong>ç¡®ä¿å³ä½¿æ˜¯å¾®å°æˆ–æŠ˜å çš„é€‰åŒºä¹Ÿèƒ½æ•æ‰åˆ°ä¸€äº›ä¸Šä¸‹æ–‡</strong>â€ï¼Œè¿™æ · IME çš„å€™é€‰æ¡†åœ¨å‡ºç°æ—¶å°±ä¸ä¼šè·³æ¥è·³å»ã€‚è¿™æ˜¯ IME äº¤äº’çš„å¸¸è§åšæ³•ï¼Œè€Œä¸æ˜¯ä¸ºäº†ç»˜åˆ¶ä¸‹åˆ’çº¿ã€‚</p><hr><p><strong>å­—ä½“ä¸‹åˆ’çº¿çš„æ¸²æŸ“</strong> æ˜¯åœ¨ <code>PlainEditor</code> çš„ <code>update_layout</code> æ–¹æ³•ä¸­å®Œæˆçš„ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// ... existing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>fn</span> <span class=nf>update_layout</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>font_cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FontContext</span><span class=p>,</span><span class=w> </span><span class=n>layout_cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>LayoutContext</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>builder</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>layout_cx</span><span class=p>.</span><span class=n>ranged_builder</span><span class=p>(</span><span class=n>font_cx</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>scale</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>quantize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>prop</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>default_style</span><span class=p>.</span><span class=n>inner</span><span class=p>().</span><span class=n>values</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>builder</span><span class=p>.</span><span class=n>push_default</span><span class=p>(</span><span class=n>prop</span><span class=p>.</span><span class=n>to_owned</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>preedit_range</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>compose</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ï¼ï¼ï¼ è¿™ä¸€è¡Œæ‰æ˜¯ä¸ºé¢„ç¼–è¾‘æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼çš„ä»£ç  ï¼ï¼ï¼
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>builder</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>StyleProperty</span>::<span class=n>Underline</span><span class=p>(</span><span class=kc>true</span><span class=p>),</span><span class=w> </span><span class=n>preedit_range</span><span class=p>.</span><span class=n>clone</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>layout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=n>build</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ... existing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>åœ¨ <code>update_layout</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœå­˜åœ¨ <code>self.compose</code>ï¼ˆå³æœ‰é¢„ç¼–è¾‘æ–‡æœ¬ï¼‰ï¼Œ<code>builder.push(StyleProperty::Underline(true), preedit_range.clone());</code> è¿™ä¸€è¡Œä¼šæ˜¾å¼åœ°ä¸ºé¢„ç¼–è¾‘æ–‡æœ¬èŒƒå›´åº”ç”¨ <code>Underline(true)</code> çš„æ ·å¼ã€‚è¿™ä¸ªæ ·å¼ä¿¡æ¯ä¼šéšç€å¸ƒå±€æ•°æ®ä¸€èµ·ä¼ é€’ï¼Œæœ€ç»ˆåœ¨å›¾å½¢æ¸²æŸ“æ—¶è¢«ç”¨æ¥ç»˜åˆ¶ä¸‹åˆ’çº¿ã€‚</p><p>æ‰€ä»¥ï¼Œä½ å¼•ç”¨çš„ä»£ç ç‰‡æ®µæ˜¯ç”¨æ¥å®šä¹‰ IME åŒºåŸŸçš„ï¼Œè€Œä¸æ˜¯ç»˜åˆ¶ä¸‹åˆ’çº¿çš„ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>        </span><span class=c1>// Using 0.6 as an estimate of the average advance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>inflate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>3.</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>0.6</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>font_size</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>Rect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x0</span>: <span class=p>(</span><span class=n>area</span><span class=p>.</span><span class=n>x0</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>inflate</span><span class=p>).</span><span class=n>max</span><span class=p>(</span><span class=mf>0.</span><span class=p>),</span><span class=w> </span><span class=c1>// å·¦å³å„æ‰©å±• inflate
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>x1</span>: <span class=p>(</span><span class=n>area</span><span class=p>.</span><span class=n>x1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>inflate</span><span class=p>).</span><span class=n>min</span><span class=p>(</span><span class=n>editor_width</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y0</span>: <span class=nc>area</span><span class=p>.</span><span class=n>y0</span><span class=p>,</span><span class=w> </span><span class=c1>// Yè½´ä¸å˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>y1</span>: <span class=nc>area</span><span class=p>.</span><span class=n>y1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// ... existing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>fn</span> <span class=nf>update_layout</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>font_cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FontContext</span><span class=p>,</span><span class=w> </span><span class=n>layout_cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>LayoutContext</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>builder</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>layout_cx</span><span class=p>.</span><span class=n>ranged_builder</span><span class=p>(</span><span class=n>font_cx</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>scale</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>quantize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>prop</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>default_style</span><span class=p>.</span><span class=n>inner</span><span class=p>().</span><span class=n>values</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>builder</span><span class=p>.</span><span class=n>push_default</span><span class=p>(</span><span class=n>prop</span><span class=p>.</span><span class=n>to_owned</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>preedit_range</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>compose</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ï¼ï¼ï¼ è¿™ä¸€è¡Œæ‰æ˜¯ä¸ºé¢„ç¼–è¾‘æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼çš„ä»£ç  ï¼ï¼ï¼
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>builder</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>StyleProperty</span>::<span class=n>Underline</span><span class=p>(</span><span class=kc>true</span><span class=p>),</span><span class=w> </span><span class=n>preedit_range</span><span class=p>.</span><span class=n>clone</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>layout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=n>build</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ... existing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><p><strong>User</strong></p><p>è¿™æ˜¯ä»€ä¹ˆæ¸¸æˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>æ ¹æ®å›¾ç‰‡ä¸­çš„ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯è§’è‰²åç§°â€œ<strong>æ·±æµ·æ½œè¡Œè€…</strong>â€å’Œå¥—è£…åç§°â€œ<strong>æ·±æµ· æ€å¿µå¥—è£…</strong>â€ï¼Œä»¥åŠå…¶ååŠ¨æ¼«é£æ ¼çš„3Däººç‰©å»ºæ¨¡å’Œç±»ä¼¼æŠ½å¡/è·å–æ–°è§’è‰²çš„ç•Œé¢ï¼Œè¿™æ¬¾æ¸¸æˆå¾ˆå¯èƒ½æ˜¯ï¼š</p><p><strong>ã€Šç»åŒºé›¶ã€‹ (Zenless Zone Zero)</strong></p><p>è¿™æ˜¯ä¸€æ¬¾ç”±ç±³å“ˆæ¸¸ï¼ˆmiHoYoï¼Œå´©åç³»åˆ—å’ŒåŸç¥çš„å¼€å‘å•†ï¼‰å¼€å‘çš„åŠ¨ä½œRPGæ¸¸æˆï¼Œå…¶ç¾æœ¯é£æ ¼å’Œè§’è‰²è®¾è®¡ä¸å›¾ç‰‡é«˜åº¦å»åˆã€‚å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„â€œè·å¾—ã€æ·±æµ·ã€‘æ€å¿µå¥—è£…ï¼Œè§£é”æ­æ¡£èº«ä»½â€ä¹Ÿç¬¦åˆè¯¥æ¸¸æˆçš„ç©æ³•æœºåˆ¶ã€‚</p><hr><p><strong>User</strong></p><p>ldd out/Debug/editor
linux-vdso.so.1 (0x00007fff8a95c000)
libfontconfig.so.1 => /lib/x86_64-linux-gnu/libfontconfig.so.1 (0x0000733b16222000)
libGL.so.1 => /lib/x86_64-linux-gnu/libGL.so.1 (0x0000733b1619b000)
libX11.so.6 => /lib/x86_64-linux-gnu/libX11.so.6 (0x0000733b13cc0000)
libGLU.so.1 => /lib/x86_64-linux-gnu/libGLU.so.1 (0x0000733b13c6a000)
libfreetype.so.6 => /lib/x86_64-linux-gnu/libfreetype.so.6 (0x0000733b13ba2000)
libstdc++.so.6 => /lib/x86_64-linux-gnu/libstdc++.so.6 (0x0000733b13800000)
libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x0000733b13abb000)
libgcc_s.so.1 => /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x0000733b13a9b000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x0000733b13400000)
/lib64/ld-linux-x86-64.so.2 (0x0000733b1629a000)
libexpat.so.1 => /lib/x86_64-linux-gnu/libexpat.so.1 (0x0000733b13a6a000)
libuuid.so.1 => /lib/x86_64-linux-gnu/libuuid.so.1 (0x0000733b16190000)
libGLdispatch.so.0 => /lib/x86_64-linux-gnu/libGLdispatch.so.0 (0x0000733b13748000)
libGLX.so.0 => /lib/x86_64-linux-gnu/libGLX.so.0 (0x0000733b13a36000)
libxcb.so.1 => /lib/x86_64-linux-gnu/libxcb.so.1 (0x0000733b1371e000)
libOpenGL.so.0 => /lib/x86_64-linux-gnu/libOpenGL.so.0 (0x0000733b136f2000)
libpng16.so.16 => /lib/x86_64-linux-gnu/libpng16.so.16 (0x0000733b136b7000)
libz.so.1 => /lib/x86_64-linux-gnu/libz.so.1 (0x0000733b1369b000)
libbrotlidec.so.1 => /lib/x86_64-linux-gnu/libbrotlidec.so.1 (0x0000733b1617e000)
libXau.so.6 => /lib/x86_64-linux-gnu/libXau.so.6 (0x0000733b13a30000)
libXdmcp.so.6 => /lib/x86_64-linux-gnu/libXdmcp.so.6 (0x0000733b13693000)
libbrotlicommon.so.1 => /lib/x86_64-linux-gnu/libbrotlicommon.so.1 (0x0000733b13670000)
libbsd.so.0 => /lib/x86_64-linux-gnu/libbsd.so.0 (0x0000733b13658000)
libmd.so.0 => /lib/x86_64-linux-gnu/libmd.so.0 (0x0000733b1364b000)â€œ</p><p>è¿™éƒ½æ˜¯ä»€ä¹ˆåº“ï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>è¿™äº›æ˜¯ <code>ldd out/Debug/editor</code> å‘½ä»¤çš„è¾“å‡ºï¼Œå®ƒåˆ—å‡ºäº†ä¸€ä¸ªåä¸º <code>editor</code> çš„å¯æ‰§è¡Œæ–‡ä»¶åœ¨ Linux ç³»ç»Ÿä¸Šè¿è¡Œæ—¶æ‰€éœ€çš„<strong>åŠ¨æ€é“¾æ¥åº“ (shared libraries)</strong>ã€‚</p><p>è¿™äº›åº“æ¶µç›–äº†å›¾å½¢æ¸²æŸ“ã€å­—ä½“å¤„ç†ã€ç³»ç»Ÿçº§åŠŸèƒ½ä»¥åŠä¸€äº›é€šç”¨çš„ç¼–ç¨‹æ”¯æŒã€‚ä¸‹é¢æ˜¯å®ƒä»¬åˆ†åˆ«æ˜¯ä»€ä¹ˆä»¥åŠå®ƒä»¬çš„ä¸»è¦ç”¨é€”ï¼š</p><ol><li><p><strong><code>linux-vdso.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> è™šæ‹ŸåŠ¨æ€å…±äº«å¯¹è±¡ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> è¿™æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ä¸ªç‰¹æ®Šâ€œåº“â€ï¼Œå®ƒä¸æ˜¯ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„å†…å­˜ä¸­ã€‚å®ƒåŒ…å«äº†ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ <code>gettimeofday</code>ï¼‰ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è°ƒç”¨å®ƒä»¬ï¼Œè€Œæ— éœ€æ‰§è¡Œæ˜‚è´µçš„ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</li></ul></li><li><p><strong><code>libfontconfig.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> å­—ä½“é…ç½®åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äºç®¡ç†ç³»ç»Ÿä¸Šçš„å­—ä½“ï¼ŒåŒ…æ‹¬æŸ¥æ‰¾å­—ä½“ã€åŒ¹é…å­—ä½“æ¨¡å¼ã€ç¼“å­˜å­—ä½“ä¿¡æ¯ç­‰ã€‚åœ¨ Linux å›¾å½¢åº”ç”¨ä¸­ï¼Œå®ƒå¸¸å¸¸ä¸ FreeType åº“ä¸€èµ·ä½¿ç”¨ã€‚</li></ul></li><li><p><strong><code>libGL.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> OpenGL å®¢æˆ·ç«¯åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æä¾› OpenGL API çš„é€šç”¨æ¥å£ã€‚è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„ GL åº“ï¼Œå®é™…çš„å›¾å½¢æ¸²æŸ“é€šå¸¸ç”±ç‰¹å®šçš„ GPU é©±åŠ¨å®ç°ï¼ˆä¾‹å¦‚ Mesa 3D æˆ– Nvidia/AMD ä¸“æœ‰é©±åŠ¨ï¼‰ã€‚</li></ul></li><li><p><strong><code>libX11.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> X Window System æ ¸å¿ƒåº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> åœ¨ Linux å’Œå…¶ä»– Unix-like ç³»ç»Ÿä¸Šï¼Œæä¾›å›¾å½¢ç”¨æˆ·ç•Œé¢ (GUI) çš„æ ¸å¿ƒåŠŸèƒ½ã€‚å®ƒå¤„ç†çª—å£ç®¡ç†ã€äº‹ä»¶å¤„ç†ã€å›¾å½¢ä¸Šä¸‹æ–‡ç­‰ã€‚</li></ul></li><li><p><strong><code>libGLU.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> OpenGL Utility Libraryã€‚</li><li><strong>ç”¨é€”ï¼š</strong> OpenGL è¾…åŠ©åº“ï¼Œæä¾›äº†ä¸€äº›é«˜çº§çš„ OpenGL å®ç”¨å‡½æ•°ï¼Œä¾‹å¦‚é€è§†æŠ•å½±è®¾ç½®ã€çº¹ç†æ˜ å°„å‡½æ•°ã€å¤æ‚å‡ ä½•ä½“ï¼ˆå¦‚çƒä½“ã€åœ†æŸ±ä½“ï¼‰çš„ç»˜åˆ¶ç­‰ã€‚å®ƒé€šå¸¸å»ºç«‹åœ¨ <code>libGL.so.1</code> ä¹‹ä¸Šã€‚</li></ul></li><li><p><strong><code>libfreetype.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> FreeType å­—ä½“æ¸²æŸ“åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äºå­—ä½“æ–‡ä»¶ï¼ˆå¦‚ TrueType, OpenTypeï¼‰çš„è§£æå’Œå­—å½¢å…‰æ …åŒ–ï¼ˆå°†çŸ¢é‡å­—ä½“è½¬æ¢ä¸ºåƒç´ å›¾åƒï¼‰ã€‚å®ƒæ˜¯è®¸å¤šå›¾å½¢åº”ç”¨ç¨‹åºå’Œæ¡Œé¢ç¯å¢ƒæ¸²æŸ“æ–‡æœ¬çš„åŸºç¡€ã€‚</li></ul></li><li><p><strong><code>libstdc++.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> GNU C++ æ ‡å‡†åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æä¾› C++ æ ‡å‡†åº“çš„å®ç°ï¼ŒåŒ…æ‹¬å®¹å™¨ï¼ˆå¦‚ <code>std::vector</code>, <code>std::string</code>ï¼‰ã€ç®—æ³•ã€è¾“å…¥/è¾“å‡ºæµç­‰ã€‚å¦‚æœä½ çš„ <code>editor</code> æ˜¯ç”¨ C++ ç¼–å†™çš„ï¼Œæˆ–è€…é“¾æ¥äº† C++ åº“ï¼Œå°±éœ€è¦å®ƒã€‚</li></ul></li><li><p><strong><code>libm.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> æ•°å­¦åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æä¾›å„ç§æ•°å­¦å‡½æ•°ï¼Œå¦‚ä¸‰è§’å‡½æ•°ã€æŒ‡æ•°å‡½æ•°ã€å¯¹æ•°å‡½æ•°ç­‰ã€‚</li></ul></li><li><p><strong><code>libgcc_s.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> GNU ç¼–è¯‘å™¨æ”¯æŒåº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> åŒ…å« GCC ç¼–è¯‘å™¨ç”Ÿæˆçš„ä¸€äº›è¿è¡Œæ—¶æ”¯æŒä¾‹ç¨‹ï¼Œä¾‹å¦‚å¼‚å¸¸å¤„ç†å’ŒåŸå­æ“ä½œç­‰ã€‚</li></ul></li><li><p><strong><code>libc.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> GNU C æ ‡å‡†åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> è¿™æ˜¯ Linux ç³»ç»Ÿä¸Šæœ€æ ¸å¿ƒçš„åº“ä¹‹ä¸€ï¼Œæä¾›å‡ ä¹æ‰€æœ‰åŸºæœ¬çš„ç³»ç»Ÿè°ƒç”¨ã€å†…å­˜ç®¡ç†ã€æ–‡ä»¶ I/Oã€å­—ç¬¦ä¸²æ“ä½œç­‰åŠŸèƒ½ã€‚</li></ul></li><li><p><strong><code>/lib64/ld-linux-x86-64.so.2</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> åŠ¨æ€é“¾æ¥å™¨/åŠ è½½å™¨ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æ“ä½œç³»ç»Ÿç”¨æ¥åŠ è½½ç¨‹åºå’Œè§£æå…¶æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“çš„ç»„ä»¶ã€‚åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå®ƒä¼šè´Ÿè´£æ‰¾åˆ°å¹¶åŠ è½½æ‰€æœ‰ä¾èµ–çš„ <code>*.so</code> æ–‡ä»¶ã€‚</li></ul></li><li><p><strong><code>libexpat.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> XML è§£æå™¨åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ä¸€ä¸ªè½»é‡çº§çš„ XML è§£æåº“ã€‚åœ¨å­—ä½“é…ç½®ï¼ˆFontconfigï¼‰æˆ–å…¶ä»–éœ€è¦è§£æ XML é…ç½®æ–‡ä»¶çš„åœ°æ–¹å¯èƒ½ä¼šç”¨åˆ°ã€‚</li></ul></li><li><p><strong><code>libuuid.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> Universally Unique Identifier (UUID) åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äºç”Ÿæˆæˆ–æ“ä½œé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ (UUID)ã€‚</li></ul></li><li><p><strong><code>libGLdispatch.so.0</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> OpenGL Dispatch åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äºåœ¨å¤šä¸ª OpenGL å®ç°ä¹‹é—´è¿›è¡Œè°ƒåº¦å’Œç®¡ç†ï¼Œå°¤å…¶æ˜¯åœ¨æœ‰å¤šä¸ª GPU æˆ–å›¾å½¢é©±åŠ¨çš„ç³»ç»Ÿä¸Šã€‚</li></ul></li><li><p><strong><code>libGLX.so.0</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> OpenGL X Window System æ‰©å±•åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> å…è®¸ OpenGL åœ¨ X Window System ç¯å¢ƒä¸­è¿›è¡Œæ¸²æŸ“ã€‚å®ƒå¤„ç† OpenGL ä¸Šä¸‹æ–‡å’Œçª—å£ä¹‹é—´çš„å…³è”ã€‚</li></ul></li><li><p><strong><code>libxcb.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> X C Binding åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> Xlib çš„æ›¿ä»£å“ï¼Œæä¾›ä¸ X Window System æœåŠ¡å™¨çš„åº•å±‚é€šä¿¡åè®®ã€‚é€šå¸¸ç”¨äºæ„å»ºé«˜æ€§èƒ½çš„ X åº”ç”¨ç¨‹åºã€‚</li></ul></li><li><p><strong><code>libOpenGL.so.0</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> OpenGL ç‰ˆæœ¬åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> å¯èƒ½æ˜¯å¯¹ç‰¹å®š OpenGL ç‰ˆæœ¬çš„å…¼å®¹å±‚æˆ–å¦ä¸€ä¸ªå…¥å£ç‚¹ã€‚</li></ul></li><li><p><strong><code>libpng16.so.16</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> PNG å›¾åƒåº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äºè¯»å–å’Œå†™å…¥ PNG æ ¼å¼çš„å›¾åƒæ–‡ä»¶ã€‚</li></ul></li><li><p><strong><code>libz.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> Zlib å‹ç¼©åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æä¾›æ— æŸæ•°æ®å‹ç¼©å’Œè§£å‹ç¼©åŠŸèƒ½ã€‚è®¸å¤šæ–‡ä»¶æ ¼å¼ï¼ˆå¦‚ PNGï¼‰å’Œç½‘ç»œåè®®éƒ½ä½¿ç”¨å®ƒã€‚</li></ul></li><li><p><strong><code>libbrotlidec.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> Brotli è§£å‹ç¼©åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äºè§£å‹ç¼©ä½¿ç”¨ Google Brotli ç®—æ³•å‹ç¼©çš„æ•°æ®ã€‚</li></ul></li><li><p><strong><code>libXau.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> X Authority åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äº X Window System çš„è®¤è¯ç®¡ç†ã€‚</li></ul></li><li><p><strong><code>libXdmcp.so.6</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> X Display Manager Control Protocol åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> ç”¨äº XDMCP åè®®ï¼Œé€šå¸¸åœ¨è¿œç¨‹ X ä¼šè¯ä¸­ä½¿ç”¨ã€‚</li></ul></li><li><p><strong><code>libbrotlicommon.so.1</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> Brotli å…¬å…±åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> Brotli ç®—æ³•çš„é€šç”¨å‡½æ•°å’Œæ•°æ®ç»“æ„ï¼Œä¾› <code>libbrotlidec</code> å’Œ <code>libbrotlienc</code> ä½¿ç”¨ã€‚</li></ul></li><li><p><strong><code>libbsd.so.0</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> BSD å…¼å®¹åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æä¾›ä¸€äº› BSD (Berkeley Software Distribution) Unix é£æ ¼çš„å‡½æ•°ï¼Œä»¥å¢å¼ºè·¨å¹³å°å…¼å®¹æ€§ã€‚</li></ul></li><li><p><strong><code>libmd.so.0</code></strong>:</p><ul><li><strong>ç±»å‹ï¼š</strong> Message Digest åº“ã€‚</li><li><strong>ç”¨é€”ï¼š</strong> æä¾›ä¸€äº›æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆå¦‚ MD5, SHAï¼‰ã€‚å¯èƒ½è¢«å…¶ä»–åº“ä¾èµ–ã€‚</li></ul></li></ol><p><strong>æ€»ç»“ï¼š</strong></p><p>è¿™ä¸ª <code>editor</code> å¯æ‰§è¡Œæ–‡ä»¶ä¼¼ä¹æ˜¯ä¸€ä¸ª<strong>æ¡Œé¢å›¾å½¢åº”ç”¨ç¨‹åº</strong>ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨æˆ–æŸç§å›¾å½¢è®¾è®¡å·¥å…·ã€‚å®ƒçš„ä¾èµ–è¡¨æ˜å®ƒï¼š</p><ul><li>åœ¨ <strong>Linux X Window System</strong> ç¯å¢ƒä¸‹è¿è¡Œã€‚</li><li>ä½¿ç”¨äº† <strong>OpenGL</strong> è¿›è¡Œå›¾å½¢æ¸²æŸ“ã€‚</li><li>é›†æˆäº† <strong>FreeType</strong> å’Œ <strong>Fontconfig</strong> è¿›è¡Œå­—ä½“å¤„ç†å’Œæ–‡æœ¬æ¸²æŸ“ã€‚</li><li>åˆ©ç”¨äº† <strong>Brotli</strong> è¿›è¡Œæ•°æ®è§£å‹ç¼©ï¼ˆå¯èƒ½ç”¨äºèµ„æºæ–‡ä»¶ï¼‰ã€‚</li><li>åŸºäº <strong>C/C++</strong> è¯­è¨€ç¼–å†™ã€‚</li></ul><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¡Œé¢åº”ç”¨ç¨‹åºåœ¨ Linux ä¸Šæ‰€éœ€çš„æ ¸å¿ƒä¾èµ–åˆ—è¡¨ã€‚</p><hr><p><strong>User</strong></p><p>flow componentå’Œdiffusion componentæ˜¯ä»€ä¹ˆï¼Ÿ</p><hr><p><strong>Cursor</strong></p><p>â€œflow componentâ€å’Œâ€œdiffusion componentâ€è¿™ä¸¤ä¸ªæœ¯è¯­åœ¨ä¸åŒé¢†åŸŸæœ‰ä¸åŒå«ä¹‰ï¼Œæœ€å¸¸è§äº<strong>ç‰©ç†ã€å·¥ç¨‹ã€æ•°å­¦å»ºæ¨¡</strong>ï¼Œä»¥åŠ**ç”Ÿæˆå¼AIï¼ˆå¦‚æ‰©æ•£æ¨¡å‹ï¼‰**ç­‰é¢†åŸŸã€‚ä¸‹é¢åˆ†åˆ«è§£é‡Šï¼š</p><hr><h2 id=1-ç‰©ç†å·¥ç¨‹æ•°å­¦å»ºæ¨¡ä¸­çš„å«ä¹‰>1. ç‰©ç†/å·¥ç¨‹/æ•°å­¦å»ºæ¨¡ä¸­çš„å«ä¹‰</h2><p>åœ¨<strong>æµä½“åŠ›å­¦ã€ä¼ çƒ­å­¦ã€æ‰©æ•£è¿‡ç¨‹</strong>ç­‰é¢†åŸŸï¼š</p><h3 id=flow-componentæµåŠ¨åˆ†é‡><strong>Flow Componentï¼ˆæµåŠ¨åˆ†é‡ï¼‰</strong></h3><ul><li>æŒ‡çš„æ˜¯ç³»ç»Ÿä¸­<strong>ç‰©è´¨ã€èƒ½é‡æˆ–åŠ¨é‡çš„æœ‰åºä¼ è¾“éƒ¨åˆ†</strong>ï¼Œé€šå¸¸è¡¨ç°ä¸ºâ€œæµåŠ¨â€ã€‚</li><li>ä¾‹å¦‚ï¼šæ°´æµã€ç©ºæ°”æµã€ç”µå­æµç­‰ã€‚</li><li>åœ¨æ•°å­¦å»ºæ¨¡ä¸­ï¼ŒæµåŠ¨åˆ†é‡å¸¸ç”¨æ¥æè¿°<strong>å¯¹æµï¼ˆconvectionï¼‰</strong>ï¼Œå³ç‰©è´¨éšæ•´ä½“æµä½“è¿åŠ¨è€Œå‘ç”Ÿçš„ä¼ è¾“ã€‚</li></ul><h3 id=diffusion-componentæ‰©æ•£åˆ†é‡><strong>Diffusion Componentï¼ˆæ‰©æ•£åˆ†é‡ï¼‰</strong></h3><ul><li>æŒ‡çš„æ˜¯<strong>ç‰©è´¨ã€èƒ½é‡æˆ–åŠ¨é‡çš„æ— åºæ‰©æ•£éƒ¨åˆ†</strong>ï¼Œé€šå¸¸è¡¨ç°ä¸ºâ€œæ‰©æ•£â€ã€‚</li><li>ä¾‹å¦‚ï¼šç›åœ¨æ°´ä¸­çš„æ‰©æ•£ã€çƒ­é‡åœ¨å›ºä½“ä¸­çš„æ‰©æ•£ç­‰ã€‚</li><li>åœ¨æ•°å­¦å»ºæ¨¡ä¸­ï¼Œæ‰©æ•£åˆ†é‡å¸¸ç”¨æ¥æè¿°<strong>æ‰©æ•£ï¼ˆdiffusionï¼‰</strong>ï¼Œå³ç”±äºæµ“åº¦æ¢¯åº¦ã€æ¸©åº¦æ¢¯åº¦ç­‰å¯¼è‡´çš„åˆ†å­éšæœºè¿åŠ¨ã€‚</li></ul><h4 id=ä¸¾ä¾‹><strong>ä¸¾ä¾‹ï¼š</strong></h4><p>åœ¨ä¼ è´¨æ–¹ç¨‹ï¼ˆå¦‚Fickå®šå¾‹ï¼‰ä¸­ï¼Œç‰©è´¨çš„æ€»é€šé‡å¯ä»¥åˆ†ä¸ºæµåŠ¨åˆ†é‡å’Œæ‰©æ•£åˆ†é‡ï¼š
[
J = J_{\text{flow}} + J_{\text{diffusion}}
]</p><ul><li>(J_{\text{flow}})ï¼šæµåŠ¨åˆ†é‡ï¼ˆå¦‚éšæµä½“æ•´ä½“è¿åŠ¨çš„ç‰©è´¨ï¼‰</li><li>(J_{\text{diffusion}})ï¼šæ‰©æ•£åˆ†é‡ï¼ˆå¦‚åˆ†å­çƒ­è¿åŠ¨å¯¼è‡´çš„æ‰©æ•£ï¼‰</li></ul><hr><h2 id=2-ç”Ÿæˆå¼aiæ·±åº¦å­¦ä¹ ä¸­çš„å«ä¹‰>2. ç”Ÿæˆå¼AI/æ·±åº¦å­¦ä¹ ä¸­çš„å«ä¹‰</h2><p>åœ¨<strong>ç”Ÿæˆæ¨¡å‹</strong>é¢†åŸŸï¼Œå°¤å…¶æ˜¯<strong>æ‰©æ•£æ¨¡å‹ï¼ˆDiffusion Modelï¼‰<strong>å’Œ</strong>æµæ¨¡å‹ï¼ˆFlow Modelï¼‰</strong>ï¼š</p><h3 id=flow-component><strong>Flow Component</strong></h3><ul><li>é€šå¸¸æŒ‡<strong>Normalizing Flow</strong>ï¼Œä¸€ç§é€šè¿‡ä¸€ç³»åˆ—å¯é€†å˜æ¢å°†ç®€å•åˆ†å¸ƒï¼ˆå¦‚é«˜æ–¯åˆ†å¸ƒï¼‰æ˜ å°„åˆ°å¤æ‚åˆ†å¸ƒçš„ç”Ÿæˆæ¨¡å‹ã€‚</li><li>Flow component åœ¨æ¨¡å‹ä¸­è´Ÿè´£â€œæµå¼â€åœ°å˜æ¢æ•°æ®åˆ†å¸ƒï¼Œå¸¸ç”¨äºæ¦‚ç‡å¯†åº¦å»ºæ¨¡å’Œé‡‡æ ·ã€‚</li></ul><h3 id=diffusion-component><strong>Diffusion Component</strong></h3><ul><li>æŒ‡<strong>Diffusion Model</strong>ä¸­çš„æ‰©æ•£è¿‡ç¨‹éƒ¨åˆ†ï¼Œå³é€šè¿‡é€æ­¥æ·»åŠ å™ªå£°ï¼ˆæ­£å‘æ‰©æ•£ï¼‰å’Œé€æ­¥å»å™ªï¼ˆåå‘æ‰©æ•£ï¼‰æ¥ç”Ÿæˆæ•°æ®çš„è¿‡ç¨‹ã€‚</li><li>Diffusion component è´Ÿè´£æ¨¡æ‹Ÿæ•°æ®çš„æ‰©æ•£å’Œè¿˜åŸè¿‡ç¨‹ã€‚</li></ul><h4 id=ä¸¾ä¾‹-1><strong>ä¸¾ä¾‹ï¼š</strong></h4><p>åœ¨æŸäº›å¤åˆç”Ÿæˆæ¨¡å‹ä¸­ï¼Œå¯èƒ½ä¼šç»“åˆ flow å’Œ diffusion ä¸¤ç§æœºåˆ¶ï¼Œåˆ†åˆ«ç§°ä¸º flow component å’Œ diffusion componentã€‚</p><hr><h2 id=3-å…·ä½“åº”ç”¨åœºæ™¯>3. å…·ä½“åº”ç”¨åœºæ™¯</h2><ul><li><strong>ç‰©ç†/å·¥ç¨‹</strong>ï¼šæè¿°ä¼ çƒ­ã€ä¼ è´¨ã€æµä½“åŠ¨åŠ›å­¦ç­‰è¿‡ç¨‹æ—¶ï¼Œå¸¸å¸¸å°†æ€»ä¼ è¾“åˆ†ä¸ºæµåŠ¨åˆ†é‡å’Œæ‰©æ•£åˆ†é‡ã€‚</li><li><strong>AI/æ·±åº¦å­¦ä¹ </strong>ï¼šåœ¨å¤åˆç”Ÿæˆæ¨¡å‹ï¼ˆå¦‚Flow+Diffusionæ··åˆæ¨¡å‹ï¼‰ä¸­ï¼Œflow component è´Ÿè´£å¯é€†å˜æ¢ï¼Œdiffusion component è´Ÿè´£å™ªå£°æ‰©æ•£ä¸å»å™ªã€‚</li></ul><hr><h2 id=æ€»ç»“-1>æ€»ç»“</h2><ul><li><strong>flow component</strong>ï¼šæœ‰åºçš„æµåŠ¨éƒ¨åˆ†ï¼ˆç‰©ç†/å·¥ç¨‹ï¼‰ï¼Œæˆ–å¯é€†å˜æ¢éƒ¨åˆ†ï¼ˆAI/æ·±åº¦å­¦ä¹ ï¼‰ã€‚</li><li><strong>diffusion component</strong>ï¼šæ— åºçš„æ‰©æ•£éƒ¨åˆ†ï¼ˆç‰©ç†/å·¥ç¨‹ï¼‰ï¼Œæˆ–æ‰©æ•£/å»å™ªéƒ¨åˆ†ï¼ˆAI/æ·±åº¦å­¦ä¹ ï¼‰ã€‚</li></ul><p>å¦‚æœä½ æœ‰å…·ä½“çš„åº”ç”¨åœºæ™¯æˆ–ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥è¡¥å……è¯´æ˜ï¼Œæˆ‘å¯ä»¥ç»™å‡ºæ›´é’ˆå¯¹æ€§çš„è§£é‡Šï¼</p></section><footer class=article-footer><section class=article-tags><a href=/zh-cn/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/>è®¡ç®—æœº</a>
<a href=/zh-cn/tags/%E9%80%BB%E8%BE%91/>é€»è¾‘</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>æœ€åæ›´æ–°äº Jun 17, 2025 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/zh-cn/p/2025%E5%B9%B46%E6%9C%8818%E6%97%A5/><div class=article-details><h2 class=article-title>2025å¹´6æœˆ18æ—¥</h2></div></a></article><article><a href=/zh-cn/p/2025%E5%B9%B46%E6%9C%8816%E6%97%A5/><div class=article-details><h2 class=article-title>2025å¹´6æœˆ16æ—¥</h2></div></a></article><article><a href=/zh-cn/p/2025%E5%B9%B46%E6%9C%8815%E6%97%A5/><div class=article-details><h2 class=article-title>2025å¹´6æœˆ15æ—¥</h2></div></a></article><article><a href=/zh-cn/p/2025%E5%B9%B46%E6%9C%8814%E6%97%A5/><div class=article-details><h2 class=article-title>2025å¹´6æœˆ14æ—¥</h2></div></a></article><article><a href=/zh-cn/p/%E8%B6%85%E8%B6%8A%E7%B3%BB%E7%BB%9F/><div class=article-details><h2 class=article-title>è¶…è¶Šç³»ç»Ÿ</h2></div></a></article></div></div></aside><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23liqc7SD1bN7OvCI6",clientSecret:"7b0ed5cd67a344de02c2efded9da2dfb8ac14783",repo:"tannal.github.io",owner:"tannal",admin:["tannal"],distractionFreeMode:!1,id:md5(location.pathname),proxy:null});(function(){const e=["localhost","127.0.0.1"],t=window.location.hostname;if(e.includes(t)){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 è°­ç›Ÿ</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>